<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Somphea Reak Shop</title>
    <!-- CSS and Scripts -->
    <link rel="stylesheet" href="/static/style.css">
    
    <style>
        /* --- 4-COLUMN CATEGORY GRID FIX --- */
        .category-bar {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important; /* Force 4 columns */
            gap: 12px 8px;
            padding: 10px;
            background: white;
            justify-items: center;
            overflow-x: hidden; /* Prevent horizontal scroll */
            white-space: normal;
        }

        .category-bar a {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            text-decoration: none;
            color: #333;
            margin: 0;
            padding: 0;
            background: none;
            border: none;
            box-shadow: none;
        }

        .category-bar img {
            width: 55px;
            height: 55px;
            border-radius: 50%; /* Circle images */
            object-fit: cover;
            border: 2px solid #eee;
            margin-bottom: 5px;
            display: block;
        }

        .category-bar span {
            font-size: 11px;
            font-weight: bold;
            line-height: 1.2;
            width: 100%;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Fix for Customize Link which might be text-only */
        .custom-link {
            grid-column: span 4; /* Make full width */
            background: #007bff !important;
            color: white !important;
            padding: 10px !important;
            border-radius: 8px;
            margin-top: 5px !important;
        }

        /* --- PRODUCT GRID FIX --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 per row mobile */
            gap: 10px;
            padding: 10px;
        }
        @media(min-width: 768px) {
            .product-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .product-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .product-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; }
        .price-line { color: #e44d26; font-weight: bold; font-size: 16px; margin: 5px 0; }
        .add-cart-button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; }
        
        /* Floating Cart */
        .floating-cart {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #007bff; color: white; padding: 12px 30px; border-radius: 30px;
            text-decoration: none; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;
        }

        /* Subcategory Scroll */
        .scroll-bar { display: flex; overflow-x: auto; gap: 10px; padding: 10px; scrollbar-width: none; background: white; }
        .scroll-bar a { background: #eee; padding: 8px 15px; border-radius: 20px; text-decoration: none; color: #333; white-space: nowrap; }
        .scroll-bar a.active { background: #333; color: white; }
        
        .modal-content-wrapper img { max-width: 90vw; max-height: 80vh; }
    </style>

    <script defer>
        function openImageModal(src) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            modalImg.src = src;
            modal.style.display = 'flex';
        }
        function closeImageModal(event) {
            document.getElementById('image-modal').style.display = 'none';
        }
        function increaseQuantity(btn) {
            const input = btn.parentElement.querySelector('input[type="number"]');
            input.value = parseInt(input.value) + 1;
        }
        function decreaseQuantity(btn) {
            const input = btn.parentElement.querySelector('input[type="number"]');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }
    </script>
</head>

<body>
    <!-- Banner -->
    <div class="banner">
        <img src="/static/images/banner.jpg" alt="Somphea Reak Banner" onerror="this.src='https://via.placeholder.com/800x200?text=Shop+Banner'">
    </div>
    <h1 style="text-align: center; margin: 10px 0;">Somphea Reak Shop</h1>

    <!-- Slider -->
    <div class="slider" style="overflow: hidden; margin-bottom: 20px;">
      <div class="slides" style="display: flex;">
        <div class="slide" style="min-width:100%"><img src="/static/images/testslide1.jpg" style="width:100%" onerror="this.src='https://via.placeholder.com/400x200'"></div>
      </div>
    </div>

    <!-- Success Message -->
    <div id="success" style="display:none; position: fixed; top:20px; right:20px; background:#28a745; color:white; padding:10px; border-radius:5px; z-index:9999;">
        âœ… á”á“áŸ’ááŸ‚á˜á‘áŸ…á€á“áŸ’ááŸ’ášá€á‘áŸ†á“á·á‰á”á¶á“á‡áŸ„á‚á‡áŸá™!
    </div>

    <!-- Sticky Category Bar (Grid) -->
    <div class="category-bar">
        <a href="/category/Hot Sale" class="{% if current_category == 'Hot Sale' %}active{% endif %}">
          <img src="/static/images/categoryhotsale.jpg" alt="Hot Sale" onerror="this.src='https://via.placeholder.com/100'">
          <span>ğŸ”¥ á‘áŸ†á“á·á‰á–á·áŸáŸáŸ</span>
        </a>
        <a href="/category/LEGO" class="{% if current_category == 'LEGO' %}active{% endif %}">
          <img src="/static/images/categorylego.jpg" alt="LEGO" onerror="this.src='https://via.placeholder.com/100'">
          <span>LEGO</span>
        </a>
        <a href="/category/Toy" class="{% if current_category == 'Toy' %}active{% endif %}">
          <img src="/static/images/categorytoy.jpg" alt="Toy" onerror="this.src='https://via.placeholder.com/100'">
          <span>á”áŸ’ášáŠá¶á”áŸ‹á€áŸ’á˜áŸá„</span>
        </a>
        <a href="/category/Keychain" class="{% if current_category == 'Keychain' %}active{% endif %}">
          <img src="/static/images/categorykey.jpg" alt="Keychain" onerror="this.src='https://via.placeholder.com/100'">
          <span>á”ááŸ’áŠáŸ„á„áŸáŸ„</span>
        </a>
        <a href="/category/LEGO Anime" class="{% if current_category == 'LEGO Anime' %}active{% endif %}">
          <img src="/static/images/categoryanime.jpg" alt="Anime" onerror="this.src='https://via.placeholder.com/100'">
          <span>LEGO Anime</span>
        </a>
        <a href="/category/LEGO Ninjago" class="{% if current_category == 'LEGO Ninjago' %}active{% endif %}">
          <img src="/static/images/categoryninjago.jpg" alt="Ninjago" onerror="this.src='https://via.placeholder.com/100'">
          <span>Ninjago</span>
        </a>
        <a href="/category/Accessories" class="{% if current_category == 'Accessories' %}active{% endif %}">
          <img src="/static/images/categorybracelet.jpg" alt="Accessories" onerror="this.src='https://via.placeholder.com/100'">
          <span>á‚áŸ’ášá¿á„ááŸ‚á„ááŸ’á›á½á“</span>
        </a>
        <!-- Lucky Draw -->
        <a href="{{ url_for('lucky_draw') }}" class="lucky-draw-link">
          <img src="/static/images/categoryluckydraw.jpg" alt="Lucky Draw" onerror="this.src='https://via.placeholder.com/100?text=Lucky'">
          <span>ğŸ’ á áŸ’á‚áŸá˜</span>
        </a>
        <!-- Italy Bracelet -->
        <a href="/category/Italy Bracelet" class="{% if current_category == 'Italy Bracelet' %}active{% endif %}">
          <img src="/static/images/italybracelet.jpg" alt="Italy" onerror="this.src='https://via.placeholder.com/100'">
          <span>Italy Bracelet</span>
        </a>
        <!-- Customize Bracelet (Full Width) -->
        <a href="/custom-bracelet" class="custom-link">âœ¨ Customize Bracelet</a>
    </div>

    <!-- Subcategories -->
    {% if subcategories %}
    <div class="sticky-wrapper sub-sticky">
      <div class="back-to-category">
        <a href="/" class="back-button" style="padding: 10px 20px; background: #333; color: white; border-radius: 8px; text-decoration: none;">â¬…ï¸ Back</a>
      </div>
      <div class="scroll-bar subcategory-bar" id="subcategory-scroll">
        {% for sub in subcategories %}
          <a href="/subcategory/{{ sub }}" class="{% if current_subcategory == sub %}active{% endif %}">
            {{ sub }}
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Product Grid -->
    <div class="product-grid" id="product-grid">
      {% for product in products %}
      <div class="product-card">
        <div class="product-labels" style="position:absolute; top:10px; left:10px; display:flex; flex-direction:column; gap:4px; z-index:1;">
          {% if "Hot Sale" in product.categories %}
            <span style="background:#ff5722; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">Hot</span>
          {% endif %}
          {% if "New" in product.categories %}
            <span style="background:#28a745; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">New</span>
          {% endif %}
        </div>

        <img src="{{ product.image }}" alt="{{ product.name_kh }}" onclick="openImageModal(this.src)" onerror="this.src='https://via.placeholder.com/150'">

        <h3>{% if language == 'kh' %}{{ product.name_kh }}{% else %}{{ product.name_en }}{% endif %}</h3>

        <div class="price-line">
            {{ "{:,}".format(product.price) }}áŸ›
        </div>

        <form class="add-to-cart-form">
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <div class="quantity-selector" style="display:flex; justify-content:center; margin:10px 0;">
            <button type="button" onclick="decreaseQuantity(this)" style="width:30px; height:30px;">-</button>
            <input type="number" name="quantity" value="1" min="1" style="width:50px; text-align:center;">
            <button type="button" onclick="increaseQuantity(this)" style="width:30px; height:30px;">+</button>
          </div>
          <button type="submit" class="add-cart-button">á”á“áŸ’ááŸ‚á˜</button>
        </form>

      </div> 
      {% endfor %}
    </div>

    {% if products|length == 0 %}
        <div style="text-align: center; color: #999; padding: 40px;">á‚áŸ’á˜á¶á“á‘áŸ†á“á·á‰á‘áŸ (No items)</div>
    {% endif %}

    <div style="text-align:center; margin-top: 30px;">
      <a href="/cart" class="floating-cart">
        ğŸ›’ á€á“áŸ’ááŸ’ášá€ (<span id="cart-count">{{ cart|length }}</span>)
      </a>
    </div>

    <!-- Fullscreen Image Modal -->
    <div id="image-modal" class="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;" onclick="closeImageModal(event)">
      <div class="modal-content-wrapper" onclick="event.stopPropagation()">
        <span class="close-button" style="position:absolute; top:20px; right:30px; font-size:40px; color:white; cursor:pointer;" onclick="closeImageModal(event)">&times;</span>
        <img id="modal-image" src="" alt="Preview" style="max-width:90%; max-height:80vh; border-radius:10px;">
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const forms = document.querySelectorAll('.add-to-cart-form');
      forms.forEach(form => {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const formData = new FormData(form);
          fetch('/add-to-cart', { method: 'POST', body: formData })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.querySelectorAll('#cart-count').forEach(el => el.innerText = data.cart_count);
              const success = document.getElementById('success');
              success.style.display = 'block';
              setTimeout(() => { success.style.display = 'none'; }, 1500);
            }
          });
        });
      });
    });
    </script>
</body>
</html>


