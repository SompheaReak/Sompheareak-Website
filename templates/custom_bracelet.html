<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customize Your Italy Bracelet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* ------------------------------------------------ */
    /* GLOBAL & TYPOGRAPHY */
    /* ------------------------------------------------ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    :root {
        --primary-color: #0066cc; /* Deep Blue */
        --secondary-color: #ff9800; /* Orange/Gold Accent */
        --success-color: #28a745;
        --danger-color: #dc3545;
        --background-light: #f7f9fc;
        --text-dark: #212529;
        --text-light: #6c757d;
        --border-color: #e0e0e0;
        --radius: 12px;
    }

    body { 
        font-family: 'Inter', sans-serif; 
        background: var(--background-light); 
        color: var(--text-dark);
        margin: 0; 
        padding: 0; 
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }
    
    h2.title { 
        margin: 30px 0 20px; 
        color: var(--primary-color); 
        font-weight: 800; 
        font-size: 1.8rem;
        text-align: center;
        width: 100%;
        padding: 0 1rem;
        box-sizing: border-box;
    }

    /* Helper for hiding the detail view */
    .hidden-detail { display: none !important; }

    /* ------------------------------------------------ */
    /* HEADER & NAVIGATION */
    /* ------------------------------------------------ */
    .header { 
        position: sticky; 
        top: 0; 
        background: white; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px 1rem; /* Mobile padding */
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
        z-index: 1000; 
        width: 100%; 
        box-sizing: border-box; 
    }
    .back-home { 
        background: var(--primary-color); 
        color: white; 
        padding: 8px 16px; 
        border-radius: var(--radius); 
        text-decoration: none; 
        font-weight: 600; 
        transition: background 0.2s;
        font-size: 0.9rem;
    }
    .back-home:hover { background: #0056b3; }
    .header h3 { font-size: 1rem; font-weight: 600; margin: 0; }
    @media (min-width: 640px) {
        .header { padding: 12px 5%; }
        .header h3 { font-size: 1.2rem; }
    }

    /* ------------------------------------------------ */
    /* PREVIEW CARD */
    /* ------------------------------------------------ */
    .main-container {
        width: 100%;
        max-width: 1000px;
        padding: 0 1rem;
        box-sizing: border-box;
    }

    .preview-box { 
        background: white; 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius); 
        margin: 30px 0; 
        padding: 20px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        text-align: left;
    }

    .preview-header { 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
        margin-bottom:15px; 
        flex-wrap: wrap; /* Wrap on small screens */
    }
    .preview-header h3 { color: var(--text-dark); margin: 0; font-weight: 700; font-size: 1.1rem; }
    .cancel-btn { 
        background: var(--danger-color); 
        color:white; 
        border:none; 
        padding:8px 14px; 
        border-radius: var(--radius); 
        font-weight: 600; 
        cursor:pointer; 
        transition: background 0.2s;
        margin-top: 10px;
    }
    .cancel-btn:hover { background: #c82333; }

    /* Bracelet Container */
    #bracelet-preview { 
        display:flex; 
        justify-content:flex-start; 
        align-items:flex-start; 
        overflow-x:auto; 
        gap: 12px; 
        padding: 15px 10px; 
        min-height: 160px; 
        border: 1px dashed var(--border-color); 
        border-radius: var(--radius);
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    .bracelet-charm { 
        position:relative; 
        flex-shrink: 0; 
        padding: 5px; 
        border-radius: var(--radius);
        background: #fcfcfc;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .bracelet-charm img { 
        width: 80px; 
        height: 120px; 
        object-fit:cover; 
        border-radius: 6px; 
        display: block;
    }

    /* Charm Controls (Move/Remove) */
    .remove-btn { 
        position:absolute; 
        top: -8px; 
        right: -8px; 
        background: var(--danger-color); 
        color:white; 
        border:2px solid white; 
        border-radius:50%; 
        font-size: 12px; 
        width: 24px; 
        height: 24px; 
        cursor:pointer; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
        transition: background 0.2s, transform 0.2s; 
        line-height: 1;
        padding: 0;
    }
    .remove-btn:hover { background:#cc0000; transform: scale(1.1); }
    .controls { display:flex; gap:3px; margin-top:8px; justify-content: space-between; }
    .move-left, .move-right { 
        border:none; 
        background: var(--text-light); 
        color:white; 
        border-radius: 6px; 
        font-size: 14px; 
        padding: 4px 8px; 
        cursor:pointer;
        transition: background 0.2s;
        flex-grow: 1;
    }
    .move-left:hover, .move-right:hover { background: var(--primary-color); }

    .total-box { 
        margin-top: 20px; 
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
        text-align:center; 
    }
    .total-box p { 
        font-size: 1.5rem; 
        font-weight: 800; 
        margin: 5px 0 15px; 
        color: var(--primary-color);
    }
    .action-buttons { 
        display:flex; 
        justify-content:center; 
        gap:15px; 
        flex-wrap:wrap; 
    }
    .screenshot-btn, .add-recommended-btn { 
        color:white; 
        border:none; 
        padding:12px 24px; 
        border-radius: var(--radius); 
        font-size: 1rem; 
        font-weight: 600;
        cursor:pointer; 
        transition: 0.2s;
        min-width: 180px;
        margin-top: 10px;
    }
    .screenshot-btn { 
        background: var(--success-color); 
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
    }
    .screenshot-btn:hover { background: #1e7e34; transform: translateY(-2px); }

    .add-recommended-btn { 
        background: var(--secondary-color); 
        box-shadow: 0 4px 8px rgba(255, 152, 0, 0.2);
    }
    .add-recommended-btn:hover { background: #e68900; transform: translateY(-2px); }

    /* ------------------------------------------------ */
    /* CATEGORY GALLERY */
    /* ------------------------------------------------ */
    .category-gallery { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
        gap: 15px; 
        padding: 20px 0; 
        width: 100%; 
    }
    
    .category-item { 
        background:white; 
        border:1px solid var(--border-color); 
        border-radius: var(--radius); 
        padding: 20px 10px; 
        cursor:pointer; 
        transition: 0.2s; 
        text-align:center; 
        font-size: 1rem; 
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    .category-item:hover { 
        border-color: var(--primary-color);
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .category-item img { 
        width: 80px; 
        height: 120px; 
        object-fit:cover; 
        border-radius: 6px; 
        margin-bottom: 10px;
    }

    /* ------------------------------------------------ */
    /* MODAL & CHARM GRID */
    /* ------------------------------------------------ */
    .modal { 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background: rgba(0,0,0,0.6); 
        display:none; 
        justify-content:center; 
        align-items:flex-end; 
        z-index:10000; 
    }
    .modal-content { 
        background:white; 
        padding: 20px; 
        border-radius: 12px 12px 0 0; 
        width: 100%; 
        max-width: 1000px;
        max-height: 85vh; 
        height: auto; 
        overflow-y: auto; 
        text-align:center; 
        position: relative; 
        animation: slideUp 0.3s ease-out; 
    }
    
    @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }

    #modalTitle { 
        color: var(--primary-color); 
        margin-top: 0; 
        font-size: 1.5rem;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
    }

    .charm-grid { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px; 
    }
    
    .charm-list-item { 
        background:var(--background-light); 
        border:1px solid var(--border-color); 
        border-radius: var(--radius); 
        padding: 10px 5px; 
        cursor:pointer; 
        transition: 0.2s; 
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .charm-list-item:hover { 
        border-color:var(--secondary-color); 
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 152, 0, 0.1);
    }
    .charm-list-item img { 
        width: 80px; 
        height: 120px; 
        object-fit:cover; 
        border-radius: 8px; 
    }
    .charm-list-item p { margin: 5px 0 0; font-size: 0.9rem; }
    .charm-list-item strong { color: var(--text-dark); }
    
    .close-modal-btn { 
        background: var(--text-light); 
        color:white; 
        border:none; 
        padding: 8px 16px; 
        border-radius: var(--radius); 
        cursor:pointer; 
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10001; 
        transition: background 0.2s;
        font-weight: 600;
    }
    .close-modal-btn:hover { background: var(--text-dark); }

    /* --- CHARM DETAIL VIEW STYLES --- */
    .detail-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 20px;
    }
    .detail-view img {
        width: 150px;
        height: 220px;
        object-fit: cover;
        border-radius: var(--radius);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        border: 4px solid var(--border-color);
    }
    .detail-info {
        text-align: center;
    }
    .detail-info h4 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: var(--primary-color);
    }
    .detail-info p {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--secondary-color);
        margin: 0;
    }
    .detail-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        width: 100%;
        max-width: 400px;
    }
    .add-charm-btn, .back-btn {
        flex-grow: 1;
        padding: 12px;
        border: none;
        border-radius: var(--radius);
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .add-charm-btn {
        background: var(--success-color);
        color: white;
    }
    .add-charm-btn:hover {
        background: #1e7e34;
        transform: translateY(-1px);
    }
    .back-btn {
        background: var(--background-light);
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }
    .back-btn:hover {
        background: #e9ecef;
        transform: translateY(-1px);
    }

    /* ------------------------------------------------ */
    /* NOTIFICATION CENTER */
    /* ------------------------------------------------ */
    #notification-center {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 100000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 90%;
    }
    .notification {
        background-color: var(--success-color);
        color: white;
        padding: 12px 18px;
        border-radius: var(--radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.5s, transform 0.5s;
        transform: translateY(20px);
        font-weight: 600;
        font-size: 0.9rem;
    }
    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }
  </style>
</head>
<body>
    <!-- Notification Center HTML Element -->
    <div id="notification-center"></div>

  <div class="header">
    <a href="/" class="back-home">üè† Back to Home</a>
    <h3>Customize Your Bracelet</h3>
  </div>
  
  <div class="main-container">

    <div class="preview-box" id="previewBox">
      <div class="preview-header">
        <h3>ü™Ñ Preview Bracelet (Saved Live)</h3>
        <button id="cancelSelection" class="cancel-btn">‚ùå Clear Design</button>
      </div>

      <!-- Bracelet preview area with scroll for mobile -->
      <div id="bracelet-preview">Add your first charm from the categories below!</div>

      <div class="total-box">
        <p>Total: <span id="totalPrice">...</span></p>
        <div class="action-buttons">
          <button class="screenshot-btn" id="screenshotBtn">üì∏ Take Screenshot</button>
          <button class="add-recommended-btn" id="recommendedBtn">‚ú® Add Recommended Charm</button>
        </div>
      </div>
    </div>

    <h2 class="title">ü™Ñ Choose a Category ü™Ñ</h2>
    <div id="categoryGallery" class="category-gallery"></div>
  </div>


  <div id="charmModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <button id="closeModalBtn" class="close-modal-btn">Close</button>
      
      <!-- List View -->
      <div id="charmListView">
        <div id="charmGrid" class="charm-grid"></div>
      </div>

      <!-- Detail View (Initially hidden) -->
      <div id="charmDetailView" class="detail-view hidden-detail">
        <!-- Content will be populated by JS -->
      </div>
      
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // --- FIREBASE SETUP ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    let charms = []; 
    let currentCategoryCharms = []; // Store charms for the currently open category

    // Initialize Firebase and Authentication
    if (Object.keys(firebaseConfig).length > 0) {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          console.log("Firebase: User signed in with UID:", userId);
          isAuthReady = true;
          loadDesign();
        } else {
          if (!isAuthReady) {
            try {
              if (initialAuthToken) {
                const credential = await signInWithCustomToken(auth, initialAuthToken);
                userId = credential.user.uid;
                console.log("Firebase: Signed in with custom token. UID:", userId);
              } else {
                const credential = await signInAnonymously(auth);
                userId = credential.user.uid;
                console.log("Firebase: Signed in anonymously. UID:", userId);
              }
            } catch (error) {
              console.error("Firebase Auth Error:", error);
              userId = 'anonymous_' + crypto.randomUUID();
            }
            isAuthReady = true;
            loadDesign();
          }
        }
      });
    } else {
      console.warn("Firebase config not available. Running without persistence.");
      isAuthReady = true;
      renderBracelet(); 
    }

    // --- FIRESTORE FUNCTIONS ---

    // Custom notification function (replaces alert/confirm)
    function showNotification(message, isError = false) {
        const center = document.getElementById('notification-center');
        const note = document.createElement('div');
        note.className = 'notification';
        if (isError) {
            note.style.backgroundColor = '#d9534f'; 
        }
        note.textContent = message;

        center.appendChild(note);

        setTimeout(() => note.classList.add('show'), 10);

        setTimeout(() => {
            note.classList.remove('show');
            setTimeout(() => center.removeChild(note), 500); 
        }, 3000);
    }

    async function saveDesign() {
      if (!isAuthReady || !db || !userId) {
        if (isAuthReady) console.warn("Cannot save: Persistence not configured.");
        return;
      }
      
      const docRef = doc(db, `artifacts/${appId}/users/${userId}/bracelets`, 'current_design');
      
      try {
        await setDoc(docRef, { 
          charms: charms,
          updatedAt: new Date().toISOString()
        });
        showNotification('Design saved automatically!');
      } catch (e) {
        console.error("Error saving document: ", e);
        showNotification('Error saving design!', true);
      }
    }

    function loadDesign() {
      if (!isAuthReady || !db || !userId) return;

      const docRef = doc(db, `artifacts/${appId}/users/${userId}/bracelets`, 'current_design');
      
      onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const loadedData = docSnap.data().charms;
          if (loadedData) {
            if (JSON.stringify(charms) !== JSON.stringify(loadedData)) {
                charms = loadedData;
                renderBracelet();
                showNotification('Your last design loaded!');
            }
          }
        } else {
            console.log("No saved design found, starting new bracelet.");
            if (charms.length === 0) renderBracelet();
        }
      }, (error) => {
        console.error("Error listening to document:", error);
        showNotification('Error loading design!', true);
        renderBracelet();
      });
    }

    // --- CORE APPLICATION LOGIC ---

    // DOM refs
    const preview = document.getElementById('bracelet-preview');
    const totalPriceSpan = document.getElementById('totalPrice');
    const categoryGallery = document.getElementById('categoryGallery');
    const charmModal = document.getElementById('charmModal');
    const charmGrid = document.getElementById('charmGrid');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const screenshotBtn = document.getElementById('screenshotBtn');
    const recommendedBtn = document.getElementById('recommendedBtn');
    const cancelSelectionBtn = document.getElementById('cancelSelection');
    const charmListView = document.getElementById('charmListView');
    const charmDetailView = document.getElementById('charmDetailView');

    // Charm Data (Same as before)
    const allCharms = [
      {"id": 1, "name_kh": "Silver Charm", "price": 400, "image": "https://placehold.co/90x150/d3d3d3/555?text=Base+Charm", "categories": ["Charm"]},
      {"id": 12301, "name_kh": "Car Charm 01", "price": 3000, "image": "https://placehold.co/90x150/0066cc/ffffff?text=Car+01", "categories": ["Car Logo"]},
      {"id": 12302, "name_kh": "Car Charm 02", "price": 3000, "image": "https://placehold.co/90x150/cc0000/ffffff?text=Car+02", "categories": ["Car Logo"]},
      {"id": 12303, "name_kh": "Car Charm 03", "price": 3000, "image": "https://placehold.co/90x150/339966/000000?text=Car+03", "categories": ["Car Logo"]},
      {"id": 12307, "name_kh": "Car Charm 07", "price": 3000, "image": "https://placehold.co/90x150/ff8800/ffffff?text=Car+07", "categories": ["Car Logo"]}, 
      {"id": 12315, "name_kh": "Car Charm 15", "price": 3000, "image": "https://placehold.co/90x150/00cccc/000000?text=Car+15", "categories": ["Car Logo"]},
      {"id": 1234501, "name_kh": "Flag Charm Cambodia", "price": 3000, "image": "https://placehold.co/90x150/000080/ffffff?text=üá∞üá≠", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
      {"id": 1234502, "name_kh": "Flag Charm Italy", "price": 3000, "image": "https://placehold.co/90x150/009246/f4f5f0?text=üáÆüáπ", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
      {"id": 1234503, "name_kh": "Flag Charm Brazil", "price": 3000, "image": "https://placehold.co/90x150/009739/ffd933?text=üáßüá∑", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
      {"id": 1234519, "name_kh": "Flag Charm France", "price": 3000, "image": "https://placehold.co/90x150/0055a4/ffffff?text=üá´üá∑", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
      {"id": 123501, "name_kh": "Ruby Gemstone", "price": 3500, "image": "https://placehold.co/90x150/dc143c/ffffff?text=üíé+Ruby", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
      {"id": 123506, "name_kh": "Sapphire Gemstone", "price": 3500, "image": "https://placehold.co/90x150/0f52ba/ffffff?text=üíé+Sapphire", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
      {"id": 123521, "name_kh": "Diamond Gemstone", "price": 5000, "image": "https://placehold.co/90x150/b9f2ff/000000?text=üíé+Diamond", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
      {"id": 234501, "name_kh": "Letter Charm A", "price": 1200, "image": "https://placehold.co/90x150/f0f0f0/000000?text=A", "categories": ["Letter"], "discount": 20},
      {"id": 234509, "name_kh": "Letter Charm I", "price": 1200, "image": "https://placehold.co/90x150/f0f0f0/000000?text=I", "categories": ["Letter"], "discount": 20},
      {"id": 234520, "name_kh": "Letter Charm T", "price": 1200, "image": "https://placehold.co/90x150/f0f0f0/000000?text=T", "categories": ["Letter"], "discount": 20},
      {"id": 234525, "name_kh": "Letter Charm Y", "price": 1200, "image": "https://placehold.co/90x150/f0f0f0/000000?text=Y", "categories": ["Letter"], "discount": 20},
      {"id": 123601, "name_kh": "Steav Charm 01", "price": 3000, "image": "https://placehold.co/90x150/000000/ffffff?text=ü§ñ+S-01", "categories": ["Steav"], "discount": 20},
      {"id": 123613, "name_kh": "Steav Charm 13", "price": 4000, "image": "https://placehold.co/90x150/800080/ffffff?text=ü§ñ+S-13", "categories": ["Steav"], "discount": 20},
      {"id": 123701, "name_kh": "Cute Dog Charm", "price": 3000, "image": "https://placehold.co/90x150/f08080/ffffff?text=üêï+Cute", "categories": ["Cutie"], "discount": 20},
      {"id": 123716, "name_kh": "Cute Cat Charm", "price": 4000, "image": "https://placehold.co/90x150/dda0dd/000000?text=üêà+Cute", "categories": ["Cutie"], "discount": 20}
    ]; 

    // Build unique categories
    const categories = Array.from(allCharms.reduce((s, ch) => {
      ch.categories.forEach(cat => { if (!s.has(cat)) s.add(cat); });
      return s;
    }, new Set()));

    // Renders the total price
    function updateTotalPrice() {
        const total = charms.reduce((sum, charm) => sum + Number(charm.price), 0);
        totalPriceSpan.textContent = total.toLocaleString() + '·üõ';
        preview.scrollLeft = preview.scrollWidth; 
    }

    // Renders the bracelet preview
    function renderBracelet() {
      preview.innerHTML = '';
      if (charms.length === 0) {
        preview.textContent = 'Add your first charm from the categories below!';
        preview.style.justifyContent = 'center';
        preview.style.alignItems = 'center';
        preview.style.color = 'var(--text-light)';
        updateTotalPrice();
        return;
      }

      preview.style.justifyContent = 'flex-start';
      preview.style.alignItems = 'flex-start';
      preview.style.color = 'var(--text-dark)';


      charms.forEach((charm, idx) => {
        const div = document.createElement('div');
        div.className = 'bracelet-charm';
        div.innerHTML = `
          <button class="remove-btn" data-index="${idx}" title="Remove">‚úñ</button>
          <img src="${charm.image}" onerror="this.onerror=null;this.src='https://placehold.co/90x150/cccccc/333?text=Error';" alt="${escapeHtml(charm.name_kh)}">
          <div class="controls">
            <button class="move-left" data-index="${idx}" title="Move left">‚¨ÖÔ∏è</button>
            <button class="move-right" data-index="${idx}" title="Move right">‚û°Ô∏è</button>
          </div>
        `;
        preview.appendChild(div);
      });

      updateTotalPrice();

      // Attach listeners for remove / move buttons
      preview.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          removeCharm(i);
        });
      });
      preview.querySelectorAll('.move-left').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          moveLeft(i);
        });
      });
      preview.querySelectorAll('.move-right').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          moveRight(i);
        });
      });
    }

    // Add / remove / move functions now call saveDesign()
    function addCharm(image, name_kh, price) {
      charms.push({ image, name_kh, price: Number(price) });
      renderBracelet();
      saveDesign();
      closeCharmModal();
      showNotification(`Added ${name_kh} to your bracelet!`);
    }

    function removeCharm(index) {
      if (index >= 0 && index < charms.length) {
        charms.splice(index, 1);
        renderBracelet();
        saveDesign();
      }
    }

    function moveLeft(index) {
      if (index > 0) {
        [charms[index-1], charms[index]] = [charms[index], charms[index-1]];
        renderBracelet();
        saveDesign();
      }
    }

    function moveRight(index) {
      if (index < charms.length - 1) {
        [charms[index+1], charms[index]] = [charms[index], charms[index+1]];
        renderBracelet();
        saveDesign();
      }
    }
    
    // --- CATEGORY AND MODAL LOGIC ---
    
    // Get an image for a category
    function getCategoryImage(cat) {
      const found = allCharms.find(c => c.categories.includes(cat));
      return found ? found.image : 'https://placehold.co/90x150/cccccc/333?text=N/A';
    }

    // Render category tiles
    function renderCategories() {
      categoryGallery.innerHTML = '';
      categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.tabIndex = 0;
        item.dataset.category = cat;

        const imgSrc = getCategoryImage(cat);
        item.innerHTML = `<img src="${imgSrc}" onerror="this.onerror=null;this.src='https://placehold.co/90x150/cccccc/333?text=Error';" alt="${escapeHtml(cat)}"><p>${escapeHtml(cat)}</p>`;
        item.addEventListener('click', () => openCharmModal(cat));
        item.addEventListener('keydown', (e) => { if (e.key === 'Enter') openCharmModal(cat); });

        categoryGallery.appendChild(item);
      });
    }

    // Opens modal and shows list view
    function openCharmModal(category) {
      modalTitle.textContent = `‚ú® ${category} Charms ‚ú®`;
      charmGrid.innerHTML = '';
      charmListView.classList.remove('hidden-detail');
      charmDetailView.classList.add('hidden-detail');

      currentCategoryCharms = allCharms.filter(ch => ch.categories.includes(category));
      
      if (currentCategoryCharms.length === 0) {
        charmGrid.innerHTML = `<p>No charms in this category.</p>`;
      } else {
        currentCategoryCharms.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'charm-list-item';
          div.dataset.id = ch.id;
          div.tabIndex = 0;
          
          div.innerHTML = `
            <img src="${ch.image}" onerror="this.onerror=null;this.src='https://placehold.co/90x150/cccccc/333?text=Error';" alt="${escapeHtml(ch.name_kh)}">
            <p>${escapeHtml(ch.name_kh)}</p>
            <p><strong>${Number(ch.price).toLocaleString()}·üõ</strong></p>
          `;
          
          const clickHandler = () => showCharmDetail(ch);
          div.addEventListener('click', clickHandler);
          div.addEventListener('keydown', (e) => { if (e.key === 'Enter') clickHandler(); });
          
          charmGrid.appendChild(div);
        });
      }

      charmModal.style.display = 'flex';
      charmModal.setAttribute('aria-hidden','false');
    }
    
    // Shows the detail view for a specific charm
    function showCharmDetail(charm) {
      charmListView.classList.add('hidden-detail');
      charmDetailView.classList.remove('hidden-detail');

      charmDetailView.innerHTML = `
        <img src="${charm.image}" onerror="this.onerror=null;this.src='https://placehold.co/150x220/cccccc/333?text=Error';" alt="${escapeHtml(charm.name_kh)}">
        <div class="detail-info">
          <h4>${escapeHtml(charm.name_kh)}</h4>
          <p>Price: ${Number(charm.price).toLocaleString()}·üõ</p>
        </div>
        <div class="detail-actions">
          <button id="addCharmDetailBtn" class="add-charm-btn">‚ûï Add to Bracelet</button>
          <button id="backToCharmListBtn" class="back-btn">‚Üê Back to List</button>
        </div>
      `;

      document.getElementById('addCharmDetailBtn').addEventListener('click', () => {
        addCharm(charm.image, charm.name_kh, charm.price);
      });

      document.getElementById('backToCharmListBtn').addEventListener('click', () => {
        charmDetailView.classList.add('hidden-detail');
        charmListView.classList.remove('hidden-detail');
      });
    }


    function closeCharmModal() {
      charmModal.style.display = 'none';
      charmModal.setAttribute('aria-hidden','true');
      // Reset to list view just in case
      charmListView.classList.remove('hidden-detail');
      charmDetailView.classList.add('hidden-detail');
    }

    // --- EVENT LISTENERS ---

    // Cancel selection 
    cancelSelectionBtn.addEventListener('click', () => {
        charms = [];
        renderBracelet();
        saveDesign();
        showNotification('Design cleared successfully!');
    });

    // screenshot
    screenshotBtn.addEventListener('click', () => {
      const element = document.getElementById('previewBox');
      html2canvas(element, { useCORS: true }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'bracelet_design.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    });

    // recommended (random) charm
    recommendedBtn.addEventListener('click', () => {
      if (allCharms.length === 0) {
        showNotification('No charms available to recommend!', true);
        return;
      }
      const random = allCharms[Math.floor(Math.random()*allCharms.length)];
      addCharm(random.image, random.name_kh, random.price);
      // Since addCharm calls closeCharmModal(), the notification must be handled inside addCharm
    });

    // modal close button
    closeModalBtn.addEventListener('click', closeCharmModal);
    // also close modal when clicking outside content
    charmModal.addEventListener('click', (e) => {
      if (e.target === charmModal) closeCharmModal();
    });

    // helper to escape text for safe insertion
    function escapeHtml(str) {
      if (str === null || typeof str === 'undefined') return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Initial Render
    renderCategories();
    // renderBracelet() is called by loadDesign() after auth is ready.

  </script>
</body>
</html>

