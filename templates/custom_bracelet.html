<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Somphea Reak Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; user-select: none; }
    
    .sold-out { filter: grayscale(1) opacity(0.4); pointer-events: none; }
    .sold-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); background: #ef4444; color: white; font-size: 8px; font-weight: 900; padding: 2px 4px; border-radius: 4px; z-index: 10; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="text-gray-900 pb-32">

  <header class="sticky top-0 z-[50] bg-white/95 backdrop-blur-md border-b px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center text-white font-black italic">S</div>
          <div>
              <span class="text-xs font-black uppercase tracking-widest block">Studio</span>
              {% if is_admin %} <span class="text-[8px] font-bold text-orange-600 uppercase bg-orange-100 px-2 rounded-full">Admin Mode</span> {% endif %}
          </div>
      </div>
      {% if is_admin %}
      <a href="/admin/panel" class="text-[10px] font-bold text-gray-400 uppercase">Back to Inventory</a>
      {% endif %}
  </header>

  <!-- WORKSPACE -->
  <div class="bg-white border-b shadow-sm sticky top-[57px] z-[40]">
      <div id="workspace" class="flex items-end h-32 overflow-x-auto px-4 py-4 gap-1 no-scrollbar">
          <div class="m-auto text-gray-300 text-[10px] font-black uppercase tracking-widest">Select items below</div>
      </div>
      <div class="px-4 py-2 flex justify-between items-center bg-gray-50 text-[10px] font-bold uppercase border-t">
          <span class="text-gray-400">Total</span>
          <span class="text-lg font-black text-gray-900" id="total-price">0៛</span>
      </div>
  </div>

  <!-- CHARM LIST -->
  <div class="p-4" id="charm-container"></div>

  <!-- ACTION BAR -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-[60] flex gap-3">
      <button onclick="resetSpace()" class="w-12 h-12 rounded-xl bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fa-solid fa-rotate-left"></i></button>
      
      {% if is_admin %}
      <!-- ONLY ADMIN SEES THIS BUTTON -->
      <button onclick="adminConfirmSale()" class="flex-grow bg-orange-600 text-white rounded-xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-transform">
          Generate Receipt & Sell
      </button>
      {% else %}
      <!-- PUBLIC USERS SEE THIS -->
      <button class="flex-grow bg-gray-900 text-white rounded-xl font-black uppercase text-xs tracking-widest opacity-80 cursor-default">
          Review Only
      </button>
      {% endif %}
  </div>

  <!-- RECEIPT MODAL -->
  <div id="receiptModal" class="fixed inset-0 z-[100] bg-black/90 hidden flex-col items-center justify-center p-6">
      <div id="receiptCard" class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl relative">
          <div class="bg-black p-6 text-center text-white">
              <h2 class="text-lg font-black uppercase tracking-widest italic">Somphea Reak</h2>
              <p class="text-[10px] opacity-80 uppercase">Official Receipt</p>
          </div>
          <div class="p-6" id="receiptContent"></div>
          <div class="p-4 bg-gray-50 border-t flex gap-3 no-print">
              <button onclick="location.reload()" class="flex-grow bg-black text-white py-3 rounded-xl text-[10px] font-black uppercase">Done</button>
          </div>
      </div>
  </div>

  <script>
    const allProducts = {{ products | tojson }};
    let currentSelection = [];

    function init() {
        const container = document.getElementById('charm-container');
        const categories = [...new Set(allProducts.flatMap(p => p.categories))];
        categories.forEach(cat => {
            const items = allProducts.filter(p => p.categories.includes(cat));
            if(items.length === 0) return;
            const html = `
                <div class="mb-6">
                    <h3 class="text-xs font-black uppercase text-gray-400 mb-3 tracking-widest">${cat}</h3>
                    <div class="grid grid-cols-4 gap-2">
                        ${items.map(p => `
                            <div onclick="${p.stock > 0 ? `addCharm(${p.id})` : ''}" class="relative bg-white rounded-xl p-1 border shadow-sm active:scale-95 transition-transform ${p.stock <= 0 ? 'sold-out' : ''}">
                                ${p.stock <= 0 ? '<div class="sold-badge">SOLD OUT</div>' : ''}
                                <img src="${p.image}" class="w-full aspect-square object-cover rounded-lg mb-1">
                                <p class="text-[8px] font-bold text-center truncate text-gray-500">${p.price}៛</p>
                            </div>`).join('')}
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function addCharm(id) {
        const product = allProducts.find(p => p.id === id);
        currentSelection.push({ ...product, uid: Date.now() + Math.random() });
        renderWorkspace();
    }
    function renderWorkspace() {
        const ws = document.getElementById('workspace');
        let total = 0;
        ws.innerHTML = currentSelection.map(item => {
            total += item.price;
            return `<div class="flex-none w-10 relative"><img src="${item.image}" class="w-full rounded-md shadow-sm border"><button onclick="removeCharm(${item.uid})" class="absolute -top-1 -right-1 bg-red-500 text-white w-3 h-3 rounded-full flex items-center justify-center text-[6px]">×</button></div>`;
        }).join('') || '<div class="m-auto text-gray-300 text-[10px] font-black uppercase tracking-widest">Select items below</div>';
        document.getElementById('total-price').innerText = total.toLocaleString() + '៛';
    }
    function removeCharm(uid) { currentSelection = currentSelection.filter(item => item.uid !== uid); renderWorkspace(); }
    function resetSpace() { currentSelection = []; renderWorkspace(); }

    async function adminConfirmSale() {
        if(currentSelection.length === 0) return;
        
        // 1. Generate Receipt HTML
        let html = '<div class="space-y-2 max-h-[50vh] overflow-y-auto">';
        currentSelection.forEach(item => {
            html += `<div class="flex items-center gap-3 border-b pb-2"><img src="${item.image}" class="w-10 h-10 rounded border"><div class="flex-grow"><p class="text-[10px] font-black uppercase">${item.name_kh}</p><p class="text-[10px] text-gray-500">${item.price}៛</p></div></div>`;
        });
        html += `</div><div class="flex justify-between border-t border-black pt-3 mt-3"><span class="font-black text-sm">TOTAL</span><span class="font-black text-xl text-orange-600">${document.getElementById('total-price').innerText}</span></div>`;
        document.getElementById('receiptContent').innerHTML = html;
        document.getElementById('receiptModal').classList.remove('hidden');
        document.getElementById('receiptModal').classList.add('flex');

        // 2. Call API to deduct stock
        const ids = currentSelection.map(c => c.id);
        await fetch('/admin/api/sell-items', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids: ids })
        });
    }
    init();
  </script>
</body>
</html>


