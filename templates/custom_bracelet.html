<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customize Your Italy Bracelet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
<style>
    body { 
        font-family: Arial, sans-serif; 
        background: #fafafa; 
        margin: 0; 
        padding: 0; 
        text-align: center; 
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .header { position: sticky; top: 0; background: white; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 1000; width: 100%; }
    .back-home { background: #007bff; color: white; padding: 10px 18px; border-radius: 8px; text-decoration: none; font-weight: bold; }
    h2.title { margin-top: 20px; color: #333; }

    .preview-box { position: sticky; top: 60px; background: #fff; border: 2px solid #ddd; border-radius: 12px; margin: 20px auto; padding: 20px; width: 90%; max-width: 900px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .preview-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .cancel-btn { background: #ff4c4c; color:white; border:none; padding:8px 16px; border-radius:6px; font-weight:bold; cursor:pointer; }
    #bracelet-preview { display:flex; justify-content:flex-start; align-items:flex-start; overflow-x:auto; gap:5px; padding:10px; min-height:160px; }
    .bracelet-charm { position:relative; margin:0; }
    .remove-btn { position:absolute; top:-15px; left:50%; transform:translateX(-50%); background:red; color:white; border:none; border-radius:50%; font-size:14px; width:26px; height:26px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition:0.2s; }
    .remove-btn:hover { background:#cc0000; transform:translateX(-50%) scale(1.1); }
    .bracelet-charm img { width:90px; height:150px; object-fit:cover; }
    .controls { display:flex; gap:5px; margin-top:5px; }
    .move-left, .move-right { border:none; background:rgba(0,0,0,0.4); color:white; border-radius:4px; font-size:14px; padding:2px 6px; cursor:pointer; }

    .total-box { margin-top:10px; text-align:center; }
    .total-box p { font-size:18px; font-weight:bold; margin:5px 0; }
    .action-buttons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .screenshot-btn { background:#28a745; color:white; border:none; padding:10px 18px; border-radius:8px; font-size:16px; cursor:pointer; }
    .add-recommended-btn { background:#ff9800; color:white; border:none; padding:10px 18px; border-radius:8px; font-size:16px; cursor:pointer; transition:0.2s; }
    .add-recommended-btn:hover { background:#e68900; transform:scale(1.05); }

    /* Category grid - FIX CENTERING AND INCREASE OVERALL SIZE */
    .category-gallery { 
        display:grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap:20px; /* Increased gap */
        padding:20px; /* Reduced padding on top/bottom */
        max-width: 600px; /* Increased max-width to make the whole grid bigger */
        width: 90%; /* Ensure it uses width within the max-width */
        margin:0 auto; 
    }
    .category-item { 
        background:white; 
        border:2px solid #eee; 
        border-radius:10px; 
        padding: 30px 20px; /* GREATLY INCREASED PADDING for height/size */
        cursor:pointer; 
        transition:0.2s; 
        text-align:center; 
        font-size: 1.4rem; /* INCREASED FONT SIZE */
        margin: 5px; 
        opacity: 1 !important; 
    }
    /* Hover effects removed */
    .category-item:hover { 
        border-color:#eee; 
        transform: none; 
    }
    
    .category-item img { width:100px; height:150px; object-fit:cover; border-radius:8px; }

    /* Modal - NO BACKGROUND OVERLAY (CLEAN SCREEN) */
  /* Modal - UPDATED FOR 50% HEIGHT BOTTOM SLIDE-UP */
.modal { 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background: rgba(0,0,0,0.5); /* Added a slight overlay for better focus */
    display:none; 
    justify-content:center; 
    align-items:flex-end; /* ALIGNS MODAL CONTENT TO THE BOTTOM */
    z-index:10000; 
    backdrop-filter: none; 
}
.modal-content { 
    background:white; 
    padding:20px; 
    border-radius:10px 10px 0 0; 
    width: 100%; 
    max-width: none; 
    /* The key change: set max-height to 50% of the viewport height (vh) */
    max-height: 50vh; 
    height: auto; /* Allow content to dictate initial height up to max-height */
    overflow-y: auto; 
    text-align:center; 
    position: relative; 
    bottom: 0;
    left: 0; 
    transform: none; 
}
    /* Charm Grid inside Modal - BIGGER IMAGES */
    .charm-grid { 
        display:grid; 
        grid-template-columns: repeat(5, 1fr); 
        gap: 15px; 
    }
    
    .recommended-item { 
        background:white; 
        border:2px solid #eee; 
        border-radius:10px; 
        padding:10px; 
        cursor:pointer; 
        transition:0.2s; 
        text-align: center;
    }
    .recommended-item:hover { border-color:#007bff; transform:scale(1.05); }
    .recommended-item img { width:90px; height:150px; object-fit:cover; border-radius:10px; }
    
    /* CLOSE BUTTON TOP-RIGHT */
    .close-modal-btn { 
        margin-top:0; 
        background:#ff4c4c; 
        color:white; 
        border:none; 
        padding:8px 14px; 
        border-radius:4px; 
        cursor:pointer; 
        
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10001; 
    }
</style>
</head>
<body>

  <div class="header">
    <a href="/" class="back-home">üè† Back to Home</a>
    <h3>Customize Your Bracelet</h3>
  </div>

  <div class="preview-box" id="previewBox">
    <div class="preview-header">
      <h3>ü™Ñ Preview Bracelet</h3>
      <button id="cancelSelection" class="cancel-btn">‚ùå Cancel Selection</button>
    </div>

    <div id="bracelet-preview">Your charms will appear here...</div>

    <div class="total-box">
      <p>Total: <span id="totalPrice">0·üõ</span></p>
      <div class="action-buttons">
        <button class="screenshot-btn" id="screenshotBtn">üì∏ Take Screenshot</button>
        <button class="add-recommended-btn" id="recommendedBtn">‚ú® Add Recommended Charm</button>
      </div>
    </div>
  </div>

  <h2 class="title">ü™Ñ Choose a Category ü™Ñ</h2>
  <div id="categoryGallery" class="category-gallery"></div>

  <div id="charmModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <div id="charmGrid" class="charm-grid"></div>
      <button id="closeModalBtn" class="close-modal-btn">Close</button>
    </div>
  </div>

  <script>
    // DOM refs
    const preview = document.getElementById('bracelet-preview');
    const totalPrice = document.getElementById('totalPrice');
    const categoryGallery = document.getElementById('categoryGallery');
    const charmModal = document.getElementById('charmModal');
    const charmGrid = document.getElementById('charmGrid');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const screenshotBtn = document.getElementById('screenshotBtn');
    const recommendedBtn = document.getElementById('recommendedBtn');

    let charms = []; // current preview charms

    const allCharms = [
    // --- CAR LOGOS (cc01 - cc15) ---
    {"id": 12301, "name_kh": "Car Charm 01", "price": 3000, "image": "/static/images/cc01.jpg", "categories": ["Car Logo"]},
    {"id": 12302, "name_kh": "Car Charm 02", "price": 3000, "image": "/static/images/cc02.jpg", "categories": ["Car Logo"]},
    {"id": 12303, "name_kh": "Car Charm 03", "price": 3000, "image": "/static/images/cc03.jpg", "categories": ["Car Logo"]},
    {"id": 12304, "name_kh": "Car Charm 04", "price": 3000, "image": "/static/images/cc04.jpg", "categories": ["Car Logo"]},
    {"id": 12305, "name_kh": "Car Charm 05", "price": 3000, "image": "/static/images/cc05.jpg", "categories": ["Car Logo"]},
    {"id": 12306, "name_kh": "Car Charm 06", "price": 3000, "image": "/static/images/cc06.jpg", "categories": ["Car Logo"]},
    {"id": 12307, "name_kh": "Car Charm 07", "price": 3000, "image": "/static/images/cc07.jpg", "categories": ["Car Logo"]}, // Corrected typo: "Car Lego"
    {"id": 12308, "name_kh": "Car Charm 08", "price": 3000, "image": "/static/images/cc08.jpg", "categories": ["Car Logo"]},
    {"id": 12309, "name_kh": "Car Charm 09", "price": 3000, "image": "/static/images/cc09.jpg", "categories": ["Car Logo"]},
    {"id": 12310, "name_kh": "Car Charm 10", "price": 3000, "image": "/static/images/cc10.jpg", "categories": ["Car Logo"]},
    {"id": 12311, "name_kh": "Car Charm 11", "price": 3000, "image": "/static/images/cc11.jpg", "categories": ["Car Logo"]},
    {"id": 12312, "name_kh": "Car Charm 12", "price": 3000, "image": "/static/images/cc12.jpg", "categories": ["Car Logo"]},
    {"id": 12313, "name_kh": "Car Charm 13", "price": 3000, "image": "/static/images/cc13.jpg", "categories": ["Car Logo"]},
    {"id": 12314, "name_kh": "Car Charm 14", "price": 3000, "image": "/static/images/cc14.jpg", "categories": ["Car Logo"]},
    {"id": 12315, "name_kh": "Car Charm 15", "price": 3000, "image": "/static/images/cc15.jpg", "categories": ["Car Logo"]},

    // --- FLAGS (cf01 - cf19) ---
    {"id": 1234501, "name_kh": "Flag Charm 01", "price": 3000, "image": "/static/images/cf01.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234502, "name_kh": "Flag Charm 02", "price": 3000, "image": "/static/images/cf02.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234503, "name_kh": "Flag Charm 03", "price": 3000, "image": "/static/images/cf03.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234504, "name_kh": "Flag Charm 04", "price": 3000, "image": "/static/images/cf04.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234505, "name_kh": "Flag Charm 05", "price": 3000, "image": "/static/images/cf05.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234506, "name_kh": "Flag Charm 06", "price": 3000, "image": "/static/images/cf06.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234507, "name_kh": "Flag Charm 07", "price": 3000, "image": "/static/images/cf07.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234508, "name_kh": "Flag Charm 08", "price": 3000, "image": "/static/images/cf08.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234509, "name_kh": "Flag Charm 09", "price": 3000, "image": "/static/images/cf09.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234510, "name_kh": "Flag Charm 10", "price": 3000, "image": "/static/images/cf10.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234511, "name_kh": "Flag Charm 11", "price": 3000, "image": "/static/images/cf11.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234512, "name_kh": "Flag Charm 12", "price": 3000, "image": "/static/images/cf12.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234513, "name_kh": "Flag Charm 13", "price": 3000, "image": "/static/images/cf13.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234514, "name_kh": "Flag Charm 14", "price": 3000, "image": "/static/images/cf14.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234515, "name_kh": "Flag Charm 15", "price": 3000, "image": "/static/images/cf15.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234516, "name_kh": "Flag Charm 16", "price": 3000, "image": "/static/images/cf16.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234517, "name_kh": "Flag Charm 17", "price": 3000, "image": "/static/images/cf17.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234518, "name_kh": "Flag Charm 18", "price": 3000, "image": "/static/images/cf18.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234519, "name_kh": "Flag Charm 19", "price": 3000, "image": "/static/images/cf19.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},

    // --- GEMSTONES (cg01 - cg24) ---
    {"id": 123501, "name_kh": "Gemstone Charm 01", "price": 3500, "image": "/static/images/cg01.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123502, "name_kh": "Gemstone Charm 02", "price": 3500, "image": "/static/images/cg02.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123503, "name_kh": "Gemstone Charm 03", "price": 3500, "image": "/static/images/cg03.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123504, "name_kh": "Gemstone Charm 04", "price": 3500, "image": "/static/images/cg04.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123505, "name_kh": "Gemstone Charm 05", "price": 3500, "image": "/static/images/cg05.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123506, "name_kh": "Gemstone Charm 06", "price": 3500, "image": "/static/images/cg06.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123507, "name_kh": "Gemstone Charm 07", "price": 3500, "image": "/static/images/cg07.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123508, "name_kh": "Gemstone Charm 08", "price": 3500, "image": "/static/images/cg08.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123509, "name_kh": "Gemstone Charm 09", "price": 3500, "image": "/static/images/cg09.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123510, "name_kh": "Gemstone Charm 10", "price": 3500, "image": "/static/images/cg10.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123511, "name_kh": "Gemstone Charm 11", "price": 3500, "image": "/static/images/cg11.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123512, "name_kh": "Gemstone Charm 12", "price": 3500, "image": "/static/images/cg12.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123513, "name_kh": "Gemstone Charm 13", "price": 3500, "image": "/static/images/cg13.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123514, "name_kh": "Gemstone Charm 14", "price": 3500, "image": "/static/images/cg14.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123515, "name_kh": "Gemstone Charm 15", "price": 3500, "image": "/static/images/cg15.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123516, "name_kh": "Gemstone Charm 16", "price": 3500, "image": "/static/images/cg16.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123517, "name_kh": "Gemstone Charm 17", "price": 3500, "image": "/static/images/cg17.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123518, "name_kh": "Gemstone Charm 18", "price": 3500, "image": "/static/images/cg18.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123519, "name_kh": "Gemstone Charm 19", "price": 3500, "image": "/static/images/cg19.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123520, "name_kh": "Gemstone Charm 20", "price": 3500, "image": "/static/images/cg20.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123521, "name_kh": "Gemstone Charm 21", "price": 5000, "image": "/static/images/cg21.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123522, "name_kh": "Gemstone Charm 22", "price": 5000, "image": "/static/images/cg22.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123523, "name_kh": "Gemstone Charm 23", "price": 5000, "image": "/static/images/cg23.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123524, "name_kh": "Gemstone Charm 24", "price": 5000, "image": "/static/images/cg24.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},

    // --- LETTERS (a - z) ---
    {"id": 234501, "name_kh": "Letter Charm A", "price": 1200, "image": "/static/images/a.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234502, "name_kh": "Letter Charm B", "price": 1200, "image": "/static/images/b.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234503, "name_kh": "Letter Charm C", "price": 1200, "image": "/static/images/c.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234504, "name_kh": "Letter Charm D", "price": 1200, "image": "/static/images/d.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234505, "name_kh": "Letter Charm E", "price": 1200, "image": "/static/images/e.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234506, "name_kh": "Letter Charm F", "price": 1200, "image": "/static/images/f.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234507, "name_kh": "Letter Charm G", "price": 1200, "image": "/static/images/g.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234508, "name_kh": "Letter Charm H", "price": 1200, "image": "/static/images/h.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234509, "name_kh": "Letter Charm I", "price": 1200, "image": "/static/images/i.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234510, "name_kh": "Letter Charm J", "price": 1200, "image": "/static/images/j.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234511, "name_kh": "Letter Charm K", "price": 1200, "image": "/static/images/k.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234512, "name_kh": "Letter Charm L", "price": 1200, "image": "/static/images/l.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234513, "name_kh": "Letter Charm M", "price": 1200, "image": "/static/images/m.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234514, "name_kh": "Letter Charm N", "price": 1200, "image": "/static/images/n.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234515, "name_kh": "Letter Charm O", "price": 1200, "image": "/static/images/o.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234516, "name_kh": "Letter Charm P", "price": 1200, "image": "/static/images/p.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234517, "name_kh": "Letter Charm Q", "price": 1200, "image": "/static/images/q.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234518, "name_kh": "Letter Charm R", "price": 1200, "image": "/static/images/r.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234519, "name_kh": "Letter Charm S", "price": 1200, "image": "/static/images/s.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234520, "name_kh": "Letter Charm T", "price": 1200, "image": "/static/images/t.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234521, "name_kh": "Letter Charm U", "price": 1200, "image": "/static/images/u.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234522, "name_kh": "Letter Charm V", "price": 1200, "image": "/static/images/v.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234523, "name_kh": "Letter Charm W", "price": 1200, "image": "/static/images/w.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234524, "name_kh": "Letter Charm X", "price": 1200, "image": "/static/images/x.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234525, "name_kh": "Letter Charm Y", "price": 1200, "image": "/static/images/y.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234526, "name_kh": "Letter Charm Z", "price": 1200, "image": "/static/images/z.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},

    // --- STEAV (cm01 - cm13) ---
    {"id": 123601, "name_kh": "Steav Charm 01", "price": 3000, "image": "/static/images/cm01.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123602, "name_kh": "Steav Charm 02", "price": 3000, "image": "/static/images/cm02.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123603, "name_kh": "Steav Charm 03", "price": 3000, "image": "/static/images/cm03.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123604, "name_kh": "Steav Charm 04", "price": 3000, "image": "/static/images/cm04.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123605, "name_kh": "Steav Charm 05", "price": 3000, "image": "/static/images/cm05.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123606, "name_kh": "Steav Charm 06", "price": 3000, "image": "/static/images/cm06.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123607, "name_kh": "Steav Charm 07", "price": 3000, "image": "/static/images/cm07.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123608, "name_kh": "Steav Charm 08", "price": 3000, "image": "/static/images/cm08.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123609, "name_kh": "Steav Charm 09", "price": 3000, "image": "/static/images/cm09.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123610, "name_kh": "Steav Charm 10", "price": 3000, "image": "/static/images/cm10.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123611, "name_kh": "Steav Charm 11", "price": 3000, "image": "/static/images/cm11.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123612, "name_kh": "Steav Charm 12", "price": 3000, "image": "/static/images/cm12.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123613, "name_kh": "Steav Charm 13", "price": 4000, "image": "/static/images/cm13.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},

    // --- CUTIE (cw01 - cw16) ---
    {"id": 123701, "name_kh": "Cutie Charm 01", "price": 3000, "image": "/static/images/cw01.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123702, "name_kh": "Cutie Charm 02", "price": 3000, "image": "/static/images/cw02.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123703, "name_kh": "Cutie Charm 03", "price": 3000, "image": "/static/images/cw03.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123704, "name_kh": "Cutie Charm 04", "price": 3000, "image": "/static/images/cw04.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123705, "name_kh": "Cutie Charm 05", "price": 3000, "image": "/static/images/cw05.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123706, "name_kh": "Cutie Charm 06", "price": 4000, "image": "/static/images/cw06.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123707, "name_kh": "Cutie Charm 07", "price": 4000, "image": "/static/images/cw07.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123708, "name_kh": "Cutie Charm 08", "price": 4000, "image": "/static/images/cw08.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123709, "name_kh": "Cutie Charm 09", "price": 4000, "image": "/static/images/cw09.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123710, "name_kh": "Cutie Charm 10", "price": 4000, "image": "/static/images/cw10.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20}, // Corrected typo: "Cutiet" -> "Cutie"
    {"id": 123711, "name_kh": "Cutie Charm 11", "price": 4000, "image": "/static/images/cw11.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123712, "name_kh": "Cutie Charm 12", "price": 4000, "image": "/static/images/cw12.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123713, "name_kh": "Cutie Charm 13", "price": 4000, "image": "/static/images/cw13.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123714, "name_kh": "Cutie Charm 14", "price": 4000, "image": "/static/images/cw14.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123715, "name_kh": "Cutie Charm 15", "price": 4000, "image": "/static/images/cw15.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123716, "name_kh": "Cutie Charm 16", "price": 4000, "image": "/static/images/cw16.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20}
];
    // Build unique categories (order preserved by first appearance)
    const categories = Array.from(allCharms.reduce((s, ch) => {
      ch.categories.forEach(cat => { if (!s.has(cat)) s.add(cat); });
      return s;
    }, new Set()));

    // Render category tiles
    function renderCategories() {
      categoryGallery.innerHTML = '';
      categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.tabIndex = 0;
        item.dataset.category = cat;

        const imgSrc = getCategoryImage(cat);
        item.innerHTML = `<img src="${imgSrc}" alt="${escapeHtml(cat)}"><p>${escapeHtml(cat)}</p>`;
        item.addEventListener('click', () => openCharmModal(cat));
        item.addEventListener('keydown', (e) => { if (e.key === 'Enter') openCharmModal(cat); });

        categoryGallery.appendChild(item);
      });
    }

    // Get an image for a category (first charm image in that category)
    function getCategoryImage(cat) {
      const found = allCharms.find(c => c.categories.includes(cat));
      return found ? found.image : '/static/images/default.jpg';
    }

    // Open modal and populate charms for the chosen category
    function openCharmModal(category) {
      modalTitle.textContent = `‚ú® ${category} Charms ‚ú®`;
      charmGrid.innerHTML = '';

      const charmsInCategory = allCharms.filter(ch => ch.categories.includes(category));
      if (charmsInCategory.length === 0) {
        charmGrid.innerHTML = `<p>No charms in this category.</p>`;
      } else {
        charmsInCategory.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'recommended-item';
          div.dataset.image = ch.image;
          div.dataset.name = ch.name_kh;
          div.dataset.price = ch.price;
          div.innerHTML = `
            <img src="${ch.image}" alt="${escapeHtml(ch.name_kh)}">
            <p>${escapeHtml(ch.name_kh)}</p>
            <p><strong>${Number(ch.price).toLocaleString()}·üõ</strong></p>
          `;
          div.addEventListener('click', () => {
            addCharm(ch.image, ch.name_kh, ch.price);
            // keep modal open so user can add several; remove the next line if you prefer it to close:
            // closeCharmModal();
          });
          charmGrid.appendChild(div);
        });
      }

      charmModal.style.display = 'flex';
      charmModal.setAttribute('aria-hidden','false');
    }

    function closeCharmModal() {
      charmModal.style.display = 'none';
      charmModal.setAttribute('aria-hidden','true');
    }

    // Renders the bracelet preview and total price
    function renderBracelet() {
      preview.innerHTML = '';
      if (charms.length === 0) {
        preview.textContent = 'Your charms will appear here...';
        totalPrice.textContent = '0·üõ';
        return;
      }

      let total = 0;
      charms.forEach((charm, idx) => {
        total += Number(charm.price);
        const div = document.createElement('div');
        div.className = 'bracelet-charm';
        div.innerHTML = `
          <button class="remove-btn" data-index="${idx}" title="Remove">‚úñ</button>
          <img src="${charm.image}" alt="${escapeHtml(charm.name)}">
          <div class="controls">
            <button class="move-left" data-index="${idx}" title="Move left">‚¨ÖÔ∏è</button>
            <button class="move-right" data-index="${idx}" title="Move right">‚û°Ô∏è</button>
          </div>
        `;
        preview.appendChild(div);
      });

      totalPrice.textContent = total.toLocaleString() + '·üõ';

      // attach listeners for remove / move buttons (delegation would also work)
      preview.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          removeCharm(i);
        });
      });
      preview.querySelectorAll('.move-left').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          moveLeft(i);
        });
      });
      preview.querySelectorAll('.move-right').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.dataset.index);
          moveRight(i);
        });
      });
    }

    // Add / remove / move
    function addCharm(image, name, price) {
      charms.push({ image, name, price: Number(price) });
      renderBracelet();
    }

    function removeCharm(index) {
      charms.splice(index, 1);
      renderBracelet();
    }

    function moveLeft(index) {
      if (index > 0) {
        [charms[index-1], charms[index]] = [charms[index], charms[index-1]];
        renderBracelet();
      }
    }

    function moveRight(index) {
      if (index < charms.length - 1) {
        [charms[index+1], charms[index]] = [charms[index], charms[index+1]];
        renderBracelet();
      }
    }

    // Cancel selection
    document.getElementById('cancelSelection').addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel your bracelet design?')) {
        charms = [];
        renderBracelet();
      }
    });

    // screenshot
    screenshotBtn.addEventListener('click', () => {
      const element = document.getElementById('previewBox');
      html2canvas(element).then(canvas => {
        const link = document.createElement('a');
        link.download = 'bracelet_design.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    });

    // recommended (random) charm
    recommendedBtn.addEventListener('click', () => {
      if (allCharms.length === 0) return;
      const random = allCharms[Math.floor(Math.random()*allCharms.length)];
      addCharm(random.image, random.name_kh, random.price);
    });

    // modal close button
    closeModalBtn.addEventListener('click', closeCharmModal);
    // also close modal when clicking outside content
    charmModal.addEventListener('click', (e) => {
      if (e.target === charmModal) closeCharmModal();
    });

    // helper to escape text for safe insertion
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // initial render
    renderCategories();
    renderBracelet();

    // expose renderCategories so we can call it after updating `allCharms` dynamically
    function renderCategories() { renderCategoriesImpl(); }
    function renderCategoriesImpl() {
      categoryGallery.innerHTML = '';
      categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.tabIndex = 0;
        item.dataset.category = cat;
        const imgSrc = getCategoryImage(cat);
        item.innerHTML = `<img src="${imgSrc}" alt="${escapeHtml(cat)}"><p>${escapeHtml(cat)}</p>`;
        item.addEventListener('click', () => openCharmModal(cat));
        item.addEventListener('keydown', (e) => { if (e.key === 'Enter') openCharmModal(cat); });
        categoryGallery.appendChild(item);
      });
    }

    // If you want to add categories dynamically later (from server),
    // update allCharms array and then recalc categories & call renderCategoriesImpl():
    //
    // Example:
    // allCharms.push({ id:999, name_kh:'New', price:2000, image:'/static/images/new.jpg', categories:['NewCat'] });
    // categories.push('NewCat'); // or recompute unique set
    // renderCategoriesImpl();

  </script>
</body>
</html>