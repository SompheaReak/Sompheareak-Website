<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Customize Your Italy Bracelet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        -webkit-tap-highlight-color: transparent;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    .bracelet-charm-anim {
        animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes pop {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Fixed Aspect Ratio for Cover */
    .aspect-16-9 {
        aspect-ratio: 16 / 9;
    }

    #drawer {
        transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 overflow-x-hidden">

  <!-- HEADER -->
  <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-lg border-b border-gray-100 px-4 py-3 flex items-center justify-between">
    <a href="/" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-600 active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h3 class="font-extrabold text-sm tracking-tighter uppercase">Italy Bracelet <span class="text-orange-600">Pro</span></h3>
    <div class="w-10"></div>
  </header>

  <!-- COVER IMAGE (16:9) -->
  <section class="w-full aspect-16-9 bg-gray-200 overflow-hidden relative">
    <img src="https://images.unsplash.com/photo-1611085583191-a3b1a308964b?auto=format&fit=crop&q=80&w=1200" alt="Cover" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex flex-col justify-end p-6">
        <span class="text-orange-400 text-[10px] font-black tracking-[0.3em] uppercase mb-1">Premium Quality</span>
        <h2 class="text-white text-xl font-black leading-tight">CUSTOMIZE YOUR <br>UNIQUE STORY</h2>
    </div>
  </section>

  <!-- BRACELET SHOWCASE (PRE-DESIGNED) -->
  <section class="py-6 px-4">
    <div class="flex items-center justify-between mb-4">
        <h4 class="text-[11px] font-black text-gray-400 uppercase tracking-widest">Trending Designs</h4>
        <span class="text-[10px] text-orange-600 font-bold">Swipe to view</span>
    </div>
    <div class="flex gap-4 overflow-x-auto scrollbar-hide">
        <div class="min-w-[200px] h-24 bg-white rounded-2xl p-2 shadow-sm border border-gray-100 flex items-center gap-2">
            <img src="https://images.unsplash.com/photo-1593085512500-5d55148d6f0d?auto=format&fit=crop&q=80&w=200" class="w-12 h-20 object-cover rounded-lg">
            <div>
                <p class="text-[10px] font-black">"Ocean Soul"</p>
                <p class="text-[9px] text-gray-400">12 Links â€¢ Blue/Silver</p>
                <button onclick="addRecommendedSet('Ocean')" class="mt-2 text-[9px] font-bold text-orange-600">Quick Build</button>
            </div>
        </div>
        <div class="min-w-[200px] h-24 bg-white rounded-2xl p-2 shadow-sm border border-gray-100 flex items-center gap-2">
            <img src="https://images.unsplash.com/photo-1613292252537-be6ada176e0e?auto=format&fit=crop&q=80&w=200" class="w-12 h-20 object-cover rounded-lg">
            <div>
                <p class="text-[10px] font-black">"Speed Master"</p>
                <p class="text-[9px] text-gray-400">8 Links â€¢ Ferrari/F1</p>
                <button onclick="addRecommendedSet('Speed')" class="mt-2 text-[9px] font-bold text-orange-600">Quick Build</button>
            </div>
        </div>
    </div>
  </section>

  <!-- PREVIEW BOX (STICKY) -->
  <section id="capture-area" class="sticky top-[65px] z-[90] bg-white border-b shadow-sm px-4 py-5">
    <div class="flex items-center justify-between mb-3">
        <span id="link-count" class="bg-gray-100 text-[10px] font-black text-gray-500 px-3 py-1 rounded-full">0 / 18 LINKS</span>
        <button onclick="clearBracelet()" class="text-[10px] font-black text-red-500 uppercase">Clear</button>
    </div>

    <!-- The Bracelet Container -->
    <div id="bracelet-preview" class="flex gap-1 overflow-x-auto py-3 scrollbar-hide min-h-[140px] items-center bg-gray-50 rounded-2xl px-4 border border-dashed border-gray-200">
        <div class="w-full text-center py-10 opacity-40">
            <i class="fa-solid fa-wand-magic-sparkles mb-2 text-xl"></i>
            <p class="text-[10px] font-bold">Pick categories below to build</p>
        </div>
    </div>

    <div class="mt-4 flex justify-between items-center">
        <span class="text-[10px] font-black text-gray-400 uppercase">Est. Total</span>
        <span id="total-price" class="text-xl font-black">0áŸ›</span>
    </div>
  </section>

  <!-- CATEGORY GRID (6 PER ROW) -->
  <section class="p-2 pt-6 pb-32">
    <div class="flex items-center justify-between mb-4 px-2">
        <h4 class="text-[11px] font-black text-gray-400 uppercase tracking-widest">Select Category</h4>
    </div>
    <div id="categoryGallery" class="grid grid-cols-6 gap-2">
      <!-- Injected by JS -->
    </div>
  </section>

  <!-- CHARM SELECTION DRAWER -->
  <div id="drawer" class="fixed inset-0 z-[200] translate-y-full pointer-events-none">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" onclick="closeDrawer()"></div>
    <div class="absolute bottom-0 left-0 right-0 h-[65vh] bg-white rounded-t-[3rem] shadow-2xl pointer-events-auto flex flex-col">
        <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto my-4"></div>
        <div class="px-8 pb-4 flex items-center justify-between">
            <h4 id="drawer-title" class="text-lg font-black uppercase tracking-tighter">Category</h4>
            <button onclick="closeDrawer()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-400">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="charmGrid" class="flex-grow overflow-y-auto px-4 pb-12 grid grid-cols-3 md:grid-cols-5 gap-3">
            <!-- Injected by JS -->
        </div>
    </div>
  </div>

  <!-- FIXED FOOTER ACTIONS -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t p-4 z-[110]">
    <div class="max-w-md mx-auto flex gap-3">
        <button onclick="addRandom()" class="w-14 h-14 flex items-center justify-center bg-gray-100 rounded-2xl text-gray-600 active:scale-90 transition-transform">
            <i class="fa-solid fa-shuffle"></i>
        </button>
        <button onclick="handleAddToCart()" id="add-to-cart-btn" disabled class="flex-grow bg-gray-900 text-white font-black rounded-2xl shadow-xl shadow-gray-200 active:scale-95 transition-all disabled:opacity-30 disabled:grayscale text-sm uppercase tracking-widest">
            Add to Cart
        </button>
    </div>
  </div>

  <script>
    // --- DATA ---
    // In production, replace with: const allCharms = {{ charms_json | safe }};
    const allCharms = [
      {"id": 1, "name_kh": "Silver Link", "price": 400, "image": "https://images.unsplash.com/photo-1611085583191-a3b1a308964b?auto=format&fit=crop&q=80&w=200", "categories": ["Charm"]},
      {"id": 2, "name_kh": "Blue Gem", "price": 800, "image": "https://images.unsplash.com/photo-1593085512500-5d55148d6f0d?auto=format&fit=crop&q=80&w=200", "categories": ["Gems"]},
      {"id": 1100, "name_kh": "F1 Logo", "price": 3000, "image": "https://images.unsplash.com/photo-1613292252537-be6ada176e0e?auto=format&fit=crop&q=80&w=200", "categories": ["Class F1ðŸŽï¸"]},
      {"id": 3, "name_kh": "Flag Link", "price": 1200, "image": "https://images.unsplash.com/photo-1590483734724-383b853b317d?auto=format&fit=crop&q=80&w=200", "categories": ["Flag"]},
      {"id": 4, "name_kh": "Football", "price": 2500, "image": "https://images.unsplash.com/photo-1611085583191-a3b1a308964b?auto=format&fit=crop&q=80&w=200", "categories": ["Football"]},
      {"id": 5, "name_kh": "Gold Charm", "price": 5000, "image": "https://images.unsplash.com/photo-1611591437281-460bfbe1220a?auto=format&fit=crop&q=80&w=200", "categories": ["Gold"]},
    ];

    const categories = Array.from(new Set(allCharms.flatMap(c => c.categories)));
    const MAX_LINKS = 18;
    let selectedCharms = JSON.parse(localStorage.getItem('customCharms')) || [];

    // --- LOGIC ---

    function init() {
      renderCategories();
      updateUI();
    }

    function renderCategories() {
      const container = document.getElementById('categoryGallery');
      container.innerHTML = categories.map(cat => {
        const charm = allCharms.find(c => c.categories.includes(cat));
        return `
          <div onclick="openDrawer('${cat}')" class="flex flex-col items-center gap-1 active:scale-95 transition-transform">
            <div class="w-12 h-16 bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden p-1">
                <img src="${charm.image}" class="w-full h-full object-cover rounded-lg">
            </div>
            <span class="text-[8px] font-black text-gray-500 uppercase truncate w-full text-center">${cat}</span>
          </div>
        `;
      }).join('');
    }

    function openDrawer(cat) {
      const drawer = document.getElementById('drawer');
      const title = document.getElementById('drawer-title');
      const grid = document.getElementById('charmGrid');
      
      title.innerText = cat;
      grid.innerHTML = '';
      
      allCharms.filter(c => c.categories.includes(cat)).forEach(c => {
        const div = document.createElement('div');
        div.className = "bg-gray-50 rounded-2xl p-2 border border-transparent active:border-orange-500 active:bg-orange-50 transition-all cursor-pointer";
        div.onclick = () => { addCharm(c); };
        div.innerHTML = `
            <img src="${c.image}" class="w-full aspect-[2/3] object-cover rounded-xl mb-2">
            <p class="text-[9px] font-black text-gray-800 truncate">${c.name_kh}</p>
            <p class="text-[10px] font-black text-orange-600">${c.price}áŸ›</p>
        `;
        grid.appendChild(div);
      });

      drawer.classList.remove('translate-y-full');
    }

    function closeDrawer() {
      document.getElementById('drawer').classList.add('translate-y-full');
    }

    function addCharm(charm) {
      if (selectedCharms.length >= MAX_LINKS) {
        alert("Maximum 18 links allowed!");
        return;
      }
      selectedCharms.push({ ...charm, uid: Date.now() + Math.random() });
      updateUI();
    }

    function removeCharm(uid) {
        selectedCharms = selectedCharms.filter(c => c.uid !== uid);
        updateUI();
    }

    function updateUI() {
      const preview = document.getElementById('bracelet-preview');
      const totalDisplay = document.getElementById('total-price');
      const countDisplay = document.getElementById('link-count');
      const addBtn = document.getElementById('add-to-cart-btn');

      localStorage.setItem('customCharms', JSON.stringify(selectedCharms));

      if (selectedCharms.length === 0) {
        preview.innerHTML = `
          <div class="w-full text-center py-10 opacity-40">
            <i class="fa-solid fa-wand-magic-sparkles mb-2 text-xl"></i>
            <p class="text-[10px] font-bold">Pick categories below to build</p>
          </div>`;
        totalDisplay.innerText = "0áŸ›";
        countDisplay.innerText = "0 / 18 LINKS";
        addBtn.disabled = true;
        return;
      }

      let total = 0;
      preview.innerHTML = selectedCharms.map(c => {
        total += c.price;
        return `
          <div class="flex-shrink-0 relative group bracelet-charm-anim">
            <div class="w-14 h-24 bg-white rounded-lg border border-gray-100 shadow-md overflow-hidden p-1">
                <img src="${c.image}" class="w-full h-full object-cover rounded-md">
            </div>
            <button onclick="removeCharm(${c.uid})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-lg">
                <i class="fa-solid fa-x"></i>
            </button>
          </div>
        `;
      }).join('');

      totalDisplay.innerText = total.toLocaleString() + "áŸ›";
      countDisplay.innerText = `${selectedCharms.length} / ${MAX_LINKS} LINKS`;
      addBtn.disabled = false;
      
      // Auto-scroll to end
      preview.scrollTo({ left: preview.scrollWidth, behavior: 'smooth' });
    }

    function clearBracelet() {
        if (confirm("Reset design?")) {
            selectedCharms = [];
            updateUI();
        }
    }

    function addRandom() {
        const rand = allCharms[Math.floor(Math.random() * allCharms.length)];
        addCharm(rand);
    }

    function addRecommendedSet(type) {
        selectedCharms = [];
        // Simulate a pre-designed set
        for(let i=0; i<8; i++) {
            const rand = allCharms[Math.floor(Math.random() * allCharms.length)];
            selectedCharms.push({ ...rand, uid: Date.now() + Math.random() });
        }
        updateUI();
    }

    function handleAddToCart() {
        const total = selectedCharms.reduce((s, c) => s + c.price, 0);
        const formData = new FormData();
        formData.append('name', `Custom Bracelet (${selectedCharms.length} links)`);
        formData.append('price', total);
        formData.append('image', selectedCharms[0].image);

        fetch('/add-to-cart', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            alert("Design added to cart!");
            selectedCharms = [];
            localStorage.removeItem('customCharms');
            window.location.href = "/";
        });
    }

    init();
  </script>
</body>
</html>

