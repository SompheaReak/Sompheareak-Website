<!-- Add these to your <style> section -->
<style>
    .sold-out { filter: grayscale(1) opacity(0.3); cursor: not-allowed !important; pointer-events: none; }
    .sold-out-badge { 
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
        background: #ef4444; color: white; font-size: 6px; font-weight: 900; 
        padding: 2px 4px; border-radius: 2px; z-index: 10; white-space: nowrap;
    }
</style>

<!-- Update your <script> section -->
<script>
    // Receive live stock data from Python
    const allCharms = {{ charms_json | tojson }};
    const categories = Array.from(new Set(allCharms.flatMap(c => c.categories)));
    let selectedCharms = JSON.parse(localStorage.getItem('customCharms')) || [];

    function init() {
        renderCategories();
        updateUI();
    }

    // ... (Your renderCategories function)

    function openDrawer(cat) {
        const grid = document.getElementById('charmGrid');
        document.getElementById('drawer-title').innerText = cat;
        grid.innerHTML = allCharms.filter(c => c.categories.includes(cat)).map(c => {
            const isSoldOut = c.stock <= 0;
            return `
                <div onclick="${isSoldOut ? '' : `addCharmById(${c.id})`}" 
                     class="relative flex flex-col items-center bg-gray-50 rounded-lg p-1 ${isSoldOut ? 'sold-out' : 'active:bg-orange-50 cursor-pointer'}">
                    ${isSoldOut ? '<div class="sold-out-badge">SOLD OUT</div>' : ''}
                    <img src="${c.image}" class="w-full aspect-[2/3.5] object-cover rounded shadow-sm">
                    <p class="text-[6px] font-black mt-1 text-gray-400">${c.price}áŸ›</p>
                </div>
            `;
        }).join('');
        document.getElementById('drawer').classList.remove('translate-y-full');
    }

    async function takeScreenshot() {
        // ... (Your current screenshot logic) ...

        // NEW: Deduct stock when user clicks download in the result modal
        document.getElementById('downloadBtn').onclick = async () => {
            await fetch('/api/deduct-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids: selectedCharms.map(c => c.id) })
            });
            
            // Proceed to download
            const dataUrl = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = `bracelet-${Date.now()}.png`;
            link.href = dataUrl;
            link.click();
            
            alert("Design Saved! Stock updated.");
            window.location.reload();
        };
    }
</script>

