<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customize Your Bracelet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#fafafa; text-align:center; margin:0; padding:0; }
  .header { position:sticky; top:0; background:#fff; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .back-home { background:#007bff; color:white; padding:8px 15px; border-radius:8px; text-decoration:none; font-weight:bold; }
  .preview-box { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); padding:20px; width:90%; max-width:900px; margin:20px auto; }
  .cancel-btn { background:#ff4c4c; color:white; border:none; padding:8px 14px; border-radius:6px; font-weight:bold; cursor:pointer; }
  #bracelet-preview { display:flex; justify-content:flex-start; gap:5px; overflow-x:auto; min-height:160px; align-items:flex-start; padding:10px; }
  .bracelet-charm img { width:90px; height:150px; object-fit:cover; }
  .remove-btn { position:absolute; top:-15px; left:50%; transform:translateX(-50%); background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer; }
  .controls { display:flex; justify-content:center; gap:5px; margin-top:5px; }
  .total-box p { font-weight:bold; font-size:18px; }
  .action-buttons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .screenshot-btn { background:#28a745; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }
  .add-recommended-btn { background:#ff9800; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }
  .category-gallery { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; padding:20px; max-width:600px; margin:auto; }
  .category-item { background:#fff; border:2px solid #eee; border-radius:10px; padding:10px; cursor:pointer; transition:0.2s; }
  .category-item:hover { border-color:#007bff; transform:scale(1.05); }
  .category-item img { width:100px; height:150px; object-fit:cover; border-radius:8px; }
  .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:9999; }
  .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:90%; max-height:90%; overflow-y:auto; }
  .charm-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); gap:15px; }
  .recommended-item { background:white; border:2px solid #eee; border-radius:10px; padding:10px; cursor:pointer; transition:0.2s; }
  .recommended-item:hover { border-color:#007bff; transform:scale(1.05); }
  .recommended-item img { width:90px; height:150px; object-fit:cover; }
</style>
</head>
<body>

<div class="header">
  <a href="#" class="back-home">üè† Back to Home</a>
  <h3>Customize Your Bracelet</h3>
</div>

<div class="preview-box" id="previewBox">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3>ü™Ñ Preview Bracelet</h3>
    <button id="cancelSelection" class="cancel-btn">‚ùå Cancel Selection</button>
  </div>
  <div id="bracelet-preview">Your charms will appear here...</div>
  <div class="total-box">
    <p>Total: <span id="totalPrice">0·üõ</span></p>
    <div class="action-buttons">
      <button id="screenshotBtn" class="screenshot-btn">üì∏ Take Screenshot</button>
      <button id="recommendedBtn" class="add-recommended-btn">‚ú® Add Recommended Charm</button>
    </div>
  </div>
</div>

<h2>ü™Ñ Choose a Category ü™Ñ</h2>
<div id="categoryGallery" class="category-gallery"></div>

<div id="charmModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <div id="charmGrid" class="charm-grid"></div>
    <button id="closeModalBtn" class="cancel-btn">Close</button>
  </div>
</div>

<script>
// ======== DATA =========
const allCharms = [
  { id:1, name_kh:"Italy Charm 1", price:5000, image:"/static/images/cc01.jpg", categories:["Italy Bracelet"] },
  { id:2, name_kh:"Italy Charm 2", price:5000, image:"/static/images/cc02.jpg", categories:["Italy Bracelet"] },
  { id:3, name_kh:"Car Charm 1", price:4500, image:"/static/images/cf01.jpg", categories:["Car Logo"] },
  { id:4, name_kh:"Car Charm 2", price:4500, image:"/static/images/cf02.jpg", categories:["Car Logo"] },
  { id:5, name_kh:"Flag Charm 1", price:4800, image:"/static/images/cf03.jpg", categories:["Flag"] },
  { id:6, name_kh:"Gemstone 1", price:6000, image:"/static/images/cg01.jpg", categories:["Gemstone"] },
  { id:7, name_kh:"Letter A", price:1000, image:"/static/images/a.jpg", categories:["Letter"] },
  { id:8, name_kh:"Letter B", price:1000, image:"/static/images/b.jpg", categories:["Letter"] },
];

// ======== DOM =========
const preview = document.getElementById('bracelet-preview');
const totalPrice = document.getElementById('totalPrice');
const categoryGallery = document.getElementById('categoryGallery');
const charmModal = document.getElementById('charmModal');
const charmGrid = document.getElementById('charmGrid');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModalBtn');

let charms = [];

// ======== FUNCTIONS =========
function getUniqueCategories() {
  const set = new Set();
  allCharms.forEach(c => c.categories.forEach(cat => set.add(cat)));
  return Array.from(set);
}

function renderCategories() {
  const cats = getUniqueCategories();
  categoryGallery.innerHTML = '';
  cats.forEach(cat => {
    const img = allCharms.find(c => c.categories.includes(cat))?.image || '/static/images/default.jpg';
    const div = document.createElement('div');
    div.className = 'category-item';
    div.innerHTML = `<img src="${img}" alt="${cat}"><p>${cat}</p>`;
    div.onclick = () => openCharmModal(cat);
    categoryGallery.appendChild(div);
  });
}

function openCharmModal(category) {
  modalTitle.textContent = `‚ú® ${category} Charms ‚ú®`;
  const charmsInCat = allCharms.filter(c => c.categories.includes(category));
  charmGrid.innerHTML = '';
  charmsInCat.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'recommended-item';
    div.innerHTML = `
      <img src="${ch.image}" alt="${ch.name_kh}">
      <p>${ch.name_kh}</p>
      <p><strong>${ch.price.toLocaleString()}·üõ</strong></p>`;
    div.onclick = () => addCharm(ch.image, ch.name_kh, ch.price);
    charmGrid.appendChild(div);
  });
  charmModal.style.display = 'flex';
}

function closeCharmModal() {
  charmModal.style.display = 'none';
}

closeModalBtn.onclick = closeCharmModal;
charmModal.onclick = e => { if (e.target === charmModal) closeCharmModal(); };

function renderBracelet() {
  preview.innerHTML = '';
  if (charms.length === 0) {
    preview.textContent = 'Your charms will appear here...';
    totalPrice.textContent = '0·üõ';
    return;
  }
  let total = 0;
  charms.forEach((c, i) => {
    total += c.price;
    const div = document.createElement('div');
    div.style.position = 'relative';
    div.innerHTML = `
      <button class="remove-btn" data-index="${i}">‚úñ</button>
      <img src="${c.image}" alt="${c.name}">
      <div class="controls">
        <button onclick="moveLeft(${i})">‚¨ÖÔ∏è</button>
        <button onclick="moveRight(${i})">‚û°Ô∏è</button>
      </div>`;
    div.querySelector('.remove-btn').onclick = () => removeCharm(i);
    preview.appendChild(div);
  });
  totalPrice.textContent = total.toLocaleString() + '·üõ';
}

function addCharm(image, name, price) {
  charms.push({ image, name, price });
  renderBracelet();
}

function removeCharm(i) {
  charms.splice(i, 1);
  renderBracelet();
}
function moveLeft(i) {
  if (i > 0) [charms[i-1], charms[i]] = [charms[i], charms[i-1]];
  renderBracelet();
}
function moveRight(i) {
  if (i < charms.length - 1) [charms[i+1], charms[i]] = [charms[i], charms[i+1]];
  renderBracelet();
}

document.getElementById('cancelSelection').onclick = () => {
  if (confirm('Clear all charms?')) { charms = []; renderBracelet(); }
};

document.getElementById('screenshotBtn').onclick = () => {
  html2canvas(document.getElementById('previewBox')).then(canvas => {
    const link = document.createElement('a');
    link.download = 'bracelet_design.png';
    link.href = canvas.toDataURL();
    link.click();
  });
};

document.getElementById('recommendedBtn').onclick = () => {
  const random = allCharms[Math.floor(Math.random()*allCharms.length)];
  addCharm(random.image, random.name_kh, random.price);
};

// ======== INIT =========
renderCategories();
renderBracelet();
</script>
</body>
</html>