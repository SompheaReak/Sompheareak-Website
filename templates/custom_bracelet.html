<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Somphea Reak - Italy Bracelet Studio Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        background-color: #f8fafc;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    /* Animation for adding links */
    .link-pop {
        animation: linkPop 0.2s ease-out forwards;
    }
    @keyframes linkPop {
        0% { transform: scale(0.9); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Drag and Drop Visual States */
    .dragging {
        opacity: 0.3;
        transform: scale(0.9);
        filter: grayscale(1);
    }
    .drag-over {
        border-left: 4px solid #ea580c !important;
        background-color: rgba(234, 88, 12, 0.05);
    }

    #drawer {
        transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }

    /* Seamless Bracelet Links - No spaces or borders */
    .bracelet-link-container {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px; /* Precise link width */
        height: 100px; /* Precise link height */
        flex-shrink: 0;
        position: relative;
        margin: 0;
        padding: 0;
        cursor: grab;
    }
    .bracelet-link-container:active { cursor: grabbing; }

    .bracelet-link-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .aspect-16-9 { aspect-ratio: 16 / 9; }
  </style>
</head>
<body class="text-gray-900 overflow-x-hidden">

  <!-- HEADER -->
  <header class="sticky top-0 z-[100] bg-white/95 backdrop-blur-xl border-b border-gray-100 px-4 py-3 flex items-center justify-between">
    <a href="/" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-gray-500 active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <div class="text-center">
        <h3 class="font-extrabold text-[9px] tracking-[0.2em] uppercase text-gray-400">Italy Bracelet</h3>
        <p class="font-black text-sm text-gray-900 tracking-tighter uppercase">Studio Pro</p>
    </div>
    <div class="w-10"></div>
  </header>

  <!-- COVER IMAGE -->
  <section class="w-full aspect-16-9 bg-gray-100 overflow-hidden relative shadow-inner">
    <img src="https://images.unsplash.com/photo-1611085583191-a3b1a308964b?auto=format&fit=crop&q=80&w=1200" alt="Cover" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-gray-900/30 to-transparent flex flex-col justify-end p-6">
        <h2 class="text-white text-2xl font-black uppercase italic tracking-tighter">Your Bracelet<br><span class="text-orange-500">Your Story</span></h2>
    </div>
  </section>

  <!-- SEAMLESS PREVIEW BOX (Sticky) -->
  <section class="sticky top-[65px] z-[90] bg-white border-b shadow-xl">
    <div class="max-w-2xl mx-auto px-4 py-6">
        <div class="flex items-center justify-between mb-4 px-1">
            <span id="link-count" class="bg-gray-900 text-[9px] font-black text-white px-3 py-1.5 rounded-full tracking-widest uppercase">0 / 18 LINKS</span>
            <button onclick="clearBracelet()" class="text-[10px] font-black text-red-500 uppercase tracking-widest active:bg-red-50 px-2 py-1 rounded">Reset Design</button>
        </div>

        <div class="relative group">
            <!-- Navigation Arrows -->
            <button onclick="scrollPreview(-120)" class="absolute left-0 top-1/2 -translate-y-1/2 z-20 w-10 h-24 bg-white/40 backdrop-blur-md shadow-lg flex items-center justify-center rounded-r-3xl text-gray-400 hover:text-black transition-all">
                <i class="fa-solid fa-chevron-left text-lg"></i>
            </button>

            <!-- SEAMLESS BRACELET CONTAINER -->
            <div id="bracelet-preview" class="flex overflow-x-auto py-2 scrollbar-hide min-h-[140px] items-center bg-gray-50 rounded-[2rem] px-12 border-2 border-dashed border-gray-200 gap-0">
                <div class="w-full text-center py-10 opacity-30">
                    <p class="text-[10px] font-black uppercase tracking-[0.4em]">Design Area</p>
                </div>
            </div>

            <button onclick="scrollPreview(120)" class="absolute right-0 top-1/2 -translate-y-1/2 z-20 w-10 h-24 bg-white/40 backdrop-blur-md shadow-lg flex items-center justify-center rounded-l-3xl text-gray-400 hover:text-black transition-all">
                <i class="fa-solid fa-chevron-right text-lg"></i>
            </button>
        </div>

        <div class="mt-6 flex justify-between items-end px-2">
            <div class="text-left">
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1 text-xs">Total Amount</p>
                <span id="total-price" class="text-3xl font-black text-gray-900">0áŸ›</span>
            </div>
            <div class="text-right flex flex-col items-end">
                <p class="text-[9px] font-bold text-gray-400 uppercase italic leading-tight">Drag and drop<br>to reorder charms</p>
            </div>
        </div>
    </div>
  </section>

  <!-- CATEGORY GRID (6 per row) -->
  <section class="p-4 pb-48">
    <div class="mb-5 px-1">
        <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Select Collection</h4>
    </div>
    <div id="categoryGallery" class="grid grid-cols-6 gap-3">
      <!-- Injected by JS -->
    </div>
  </section>

  <!-- SELECTION DRAWER (8 per row grid) -->
  <div id="drawer" class="fixed inset-0 z-[200] translate-y-full pointer-events-none">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto" onclick="closeDrawer()"></div>
    <div class="absolute bottom-0 left-0 right-0 h-[65vh] bg-white rounded-t-[3.5rem] shadow-2xl pointer-events-auto flex flex-col border-t-2 border-gray-100">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto my-6"></div>
        <div class="px-8 pb-4 flex items-center justify-between">
            <h4 id="drawer-title" class="text-xl font-black uppercase tracking-tighter text-gray-900">Charms</h4>
            <button onclick="closeDrawer()" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full text-gray-400 active:scale-90">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto px-3 pb-24">
            <!-- 8 CHARMS PER ROW GRID -->
            <div id="charmGrid" class="grid grid-cols-8 gap-2">
                <!-- Injected by JS -->
            </div>
        </div>
    </div>
  </div>

  <!-- FIXED FOOTER -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-gray-100 p-5 z-[110]">
    <div class="max-w-md mx-auto flex gap-4">
        <button onclick="addRandom()" class="w-16 h-16 flex items-center justify-center bg-gray-50 border border-gray-200 rounded-2xl text-gray-500 active:scale-90 transition-transform shadow-inner">
            <i class="fa-solid fa-shuffle text-xl"></i>
        </button>
        <button onclick="handleAddToCart()" id="add-to-cart-btn" disabled class="flex-grow bg-gray-900 text-white font-black rounded-2xl shadow-2xl active:scale-95 transition-all disabled:opacity-20 text-xs uppercase tracking-[0.2em] py-5">
            Add To Cart
        </button>
    </div>
  </div>

  <script>
    // --- DATABASE ---
    const allCharms = [
    {"id": 1, "name_kh": "Silver Charm", "price": 400, "image": "/static/images/c01.jpg", "categories": ["Charm"]},
    {"id": 1100, "name_kh": "Classic F1 Logo", "price": 3000, "image": "/static/images/charm-f1â€“101.jpg", "categories": ["Class F1ðŸŽï¸"]},
    {"id": 1192, "name_kh": "Classic F1 - Ferri", "price": 3000, "image": "/static/images/charm-f1-301.jpg", "categories": ["Class F1ðŸŽï¸"]},
    {"id": 1001, "name_kh": "Car Charm 01", "price": 3000, "image": "/static/images/cc01.jpg", "categories": ["Car Logo"]},
    {"id": 2001, "name_kh": "Flag Charm 01", "price": 3000, "image": "/static/images/cf01.jpg", "categories": ["Flag"]},
    {"id": 3001, "name_kh": "Gemstone Charm 01", "price": 3500, "image": "/static/images/cg01.jpg", "categories": ["Gemstone"]},
    {"id": 4001, "name_kh": "Chain Charm 01", "price": 3000, "image": "/static/images/charm-chain-01.jpg", "categories": ["Chain"]},
    {"id": 5001, "name_kh": "Barcelona", "price": 3000, "image": "/static/images/charm-footballclub-01.jpg", "categories": ["Football Club Logo"]},
    {"id": 6001, "name_kh": "Black Charm 01", "price": 3000, "image": "/static/images/cb01.jpg", "categories": ["Black Lover"]},
    {"id": 8001, "name_kh": "Pink Charm 01", "price": 3000, "image": "/static/images/cp01.jpg", "categories": ["Pink Lover"]},
    {"id": 9001, "name_kh": "Pink Letter A", "price": 1200, "image": "/static/images/ap.jpg", "categories": ["Pink Letter"]},
    {"id": 1101, "name_kh": "Letter A", "price": 1200, "image": "/static/images/a.jpg", "categories": ["Letter"]},
    {"id": 1401, "name_kh": "Cutie Charm 01", "price": 3000, "image": "/static/images/cw01.jpg", "categories": ["Cutie"]},
    {"id": 1501, "name_kh": "Bubble 01", "price": 3000, "image": "/static/images/charm-bubble-01.jpg", "categories": ["SlayðŸ’…"]},
    {"id": 1601, "name_kh": "Cute Cat 01", "price": 3000, "image": "/static/images/charm-cutecat-01.jpg", "categories": ["Cute Cat"]},
    {"id": 1701, "name_kh": "Rok Jit 01", "price": 3000, "image": "/static/images/charm-rokjit-01.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1801, "name_kh": "8 Ball 01", "price": 3000, "image": "/static/images/charm-8ball-01.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 2101, "name_kh": "Flower 01", "price": 3000, "image": "/static/images/charm-flower-01.jpg", "categories": ["Flower ðŸŒ¹"]},
    ];

    const categories = Array.from(new Set(allCharms.flatMap(c => c.categories)));
    const MAX_LINKS = 18;
    let selectedCharms = JSON.parse(localStorage.getItem('customCharms')) || [];

    // --- RENDER FUNCTIONS ---

    function init() {
        renderCategories();
        updateUI();
    }

    function renderCategories() {
        const container = document.getElementById('categoryGallery');
        container.innerHTML = categories.map(cat => {
            const charm = allCharms.find(c => c.categories.includes(cat));
            return `
                <div onclick="openDrawer('${cat}')" class="flex flex-col items-center gap-2 active:scale-95 transition-transform cursor-pointer">
                    <div class="w-full aspect-[2/3.2] bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden p-1 hover:border-orange-200 transition-colors">
                        <img src="${charm.image}" class="w-full h-full object-cover rounded-lg">
                    </div>
                    <span class="text-[7px] font-black text-gray-500 uppercase truncate w-full text-center tracking-tighter">${cat}</span>
                </div>
            `;
        }).join('');
    }

    function openDrawer(cat) {
        const drawer = document.getElementById('drawer');
        const title = document.getElementById('drawer-title');
        const grid = document.getElementById('charmGrid');
        
        title.innerText = cat;
        // 8 CHARMS PER ROW GRID
        grid.innerHTML = allCharms.filter(c => c.categories.includes(cat)).map(c => `
            <div onclick="addCharmById(${c.id})" class="flex flex-col items-center bg-gray-50 rounded-lg p-1 border-2 border-transparent active:border-orange-500 transition-all cursor-pointer">
                <img src="${c.image}" class="w-full aspect-[2/3.5] object-cover rounded-md shadow-sm">
                <p class="text-[6px] font-black mt-1 text-gray-400">${c.price}áŸ›</p>
            </div>
        `).join('');

        drawer.classList.remove('translate-y-full');
        drawer.classList.add('pointer-events-auto');
    }

    function closeDrawer() { 
        const drawer = document.getElementById('drawer');
        drawer.classList.add('translate-y-full'); 
        drawer.classList.remove('pointer-events-auto');
    }

    // --- BUILDER ACTIONS ---

    function addCharmById(id) {
        if (selectedCharms.length >= MAX_LINKS) return alert("Bracelet is full!");
        const charm = allCharms.find(c => c.id === id);
        selectedCharms.push({ ...charm, uid: Math.random().toString(36).substr(2, 9) });
        updateUI();
    }

    function removeCharm(uid) {
        selectedCharms = selectedCharms.filter(c => c.uid !== uid);
        updateUI();
    }

    function updateUI() {
        const preview = document.getElementById('bracelet-preview');
        const totalDisplay = document.getElementById('total-price');
        const countDisplay = document.getElementById('link-count');
        const addBtn = document.getElementById('add-to-cart-btn');

        localStorage.setItem('customCharms', JSON.stringify(selectedCharms));

        if (selectedCharms.length === 0) {
            preview.innerHTML = `<div class="w-full text-center py-10 opacity-30 uppercase tracking-[0.4em] text-[10px] font-black">Designer Space</div>`;
            totalDisplay.innerText = "0áŸ›";
            countDisplay.innerText = "0 / 18 LINKS";
            addBtn.disabled = true;
            return;
        }

        let total = 0;
        preview.innerHTML = selectedCharms.map((c, index) => {
            total += c.price;
            return `
                <div class="bracelet-link-container link-pop" 
                     draggable="true" 
                     data-index="${index}"
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                    <img src="${c.image}" class="pointer-events-none">
                    <button onclick="removeCharm('${c.uid}')" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[8px] shadow-lg opacity-0 hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `;
        }).join('');

        totalDisplay.innerText = total.toLocaleString() + "áŸ›";
        countDisplay.innerText = `${selectedCharms.length} / ${MAX_LINKS} LINKS`;
        addBtn.disabled = false;
        
        // Auto-scroll on first few items
        if (selectedCharms.length > 5) {
            preview.scrollTo({ left: preview.scrollWidth, behavior: 'smooth' });
        }
    }

    // --- REORDERING (DRAG & DROP) ---

    let draggedIndex = null;

    function handleDragStart(e) {
        draggedIndex = parseInt(e.target.dataset.index);
        e.dataTransfer.setData('text/plain', draggedIndex);
        e.target.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('.bracelet-link-container');
        if (target) target.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        const target = e.target.closest('.bracelet-link-container');
        if (target) target.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        const target = e.target.closest('.bracelet-link-container');
        if (!target) return;
        target.classList.remove('drag-over');

        const dropIndex = parseInt(target.dataset.index);
        if (draggedIndex === dropIndex) return;

        // Splice and Move
        const movedItem = selectedCharms.splice(draggedIndex, 1)[0];
        selectedCharms.splice(dropIndex, 0, movedItem);
        
        updateUI();
    }

    // --- NAVIGATION ---

    function scrollPreview(val) {
        document.getElementById('bracelet-preview').scrollBy({ left: val, behavior: 'smooth' });
    }

    function clearBracelet() {
        if (confirm("Reset current design?")) { selectedCharms = []; updateUI(); }
    }

    function addRandom() {
        const rand = allCharms[Math.floor(Math.random() * allCharms.length)];
        if(rand) addCharmById(rand.id);
    }

    function handleAddToCart() {
        const total = selectedCharms.reduce((s, c) => s + c.price, 0);
        const formData = new FormData();
        formData.append('product_id', selectedCharms[0]?.id || 0);
        formData.append('custom_name', `Custom Italy Bracelet (${selectedCharms.length} links)`);
        formData.append('price', total);

        fetch('/add-to-cart', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(() => {
            alert("Design added to cart!");
            selectedCharms = [];
            localStorage.removeItem('customCharms');
            window.location.href = "/";
        });
    }

    init();
  </script>
</body>
</html>

