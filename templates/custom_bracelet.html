<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customize Your Italy Bracelet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    body { 
        font-family: Arial, sans-serif; 
        background: #fafafa; 
        margin: 0; 
        padding: 0; 
        text-align: center; 
        display: flex;
        flex-direction: column;
        align-items: center;
        /* Ensure no body padding/margin causes scrollbar on the right */
        overflow-x: hidden; 
    }
    
    /* üî•üî•üî• HEADER CHANGES: INCREASED PADDING, FONT SIZE, AND GIF SIZE üî•üî•üî• */
    .header { 
        position: sticky; 
        top: 0; 
        background: white; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 20px 30px; /* Increased vertical and horizontal padding for bigger look */
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Stronger shadow */
        z-index: 1000; 
        width: 100%; 
        flex-wrap: wrap; 
        gap: 20px; /* Increased gap */
        box-sizing: border-box; 
    }
    
    /* --- LARGER BACK HOME BUTTON --- */
    .back-home { 
        background: #007bff; 
        color: white; 
        padding: 15px 25px; /* Increased padding */
        border-radius: 12px; /* Slightly rounder */
        text-decoration: none; 
        font-weight: bold; 
        font-size: 1.1rem; /* Increased font size */
    }
    
    /* --- LARGER HEADER TITLE --- */
    .header h3 {
        font-size: 1.5rem; /* Increased font size for title */
        margin: 0;
        color: #1a1a1a;
    }

    h2.title { margin-top: 20px; color: #333; }

    /* GIF Style */
    .header-gif {
        max-height: 70px; /* Increased GIF size */
        width: auto;
        margin: 0 10px; 
    }


    /* --- PREVIEW BOX CHANGES: ADJUSTED TOP STICKY POSITION --- */
    .preview-box { 
        position: sticky; 
        top: 90px; /* Adjusted sticky position to clear the taller header */
        background: #fff; 
        border: 2px solid #ddd; 
        border-radius: 15px; /* Slightly rounder corners */
        margin: 25px auto; /* Increased margin */
        padding: 30px; /* Increased padding */
        width: 90%; 
        max-width: 900px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Stronger shadow */
    }
    .preview-header { 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
        margin-bottom:15px; /* Increased margin */
        flex-wrap: wrap; 
        gap: 10px; 
    } 
    
    /* --- LARGER CANCEL BUTTON --- */
    .cancel-btn { 
        background: #ff4c4c; 
        color:white; 
        border:none; 
        padding: 10px 20px; /* Increased padding */
        border-radius:8px; 
        font-weight:bold; 
        font-size: 1rem;
        cursor:pointer; 
    }
    
    /* TALLER PREVIEW AREA */
    #bracelet-preview { 
        display:flex; 
        justify-content:flex-start; 
        align-items:flex-start; 
        overflow-x:auto; 
        gap:8px; 
        /* FIX: INCREASED TOP PADDING TO MAKE ROOM FOR THE FULL REMOVE BUTTON CIRCLE */
        padding: 30px 15px 15px 15px; 
        min-height:220px; 
        background: #f8f8f8; 
        border-radius: 8px;
    }

    .bracelet-charm { 
        position:relative; 
        /* The margin-top property pushes the whole charm down, making room for the negative top of the button */
        margin: 20px 0 10px 0; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        z-index: 10; 
    }
    
    /* üõ†Ô∏è REDESIGN: MODERN CIRCLE ICON REMOVE BUTTON (OPTION 1) üõ†Ô∏è */
    .remove-btn { 
        position:absolute; 
        top: -25px; /* Adjusted slightly up for bigger button */
        left: 50%; 
        transform:translateX(-50%); 
        background: #a11919; /* Darker, richer red */
        color: white; 
        border: none; /* No white border */
        border-radius: 50%; 
        font-size: 18px; /* Larger icon */
        width: 30px; /* Larger click area */
        height: 30px; 
        cursor: pointer; 
        box-shadow: 0 3px 6px rgba(0,0,0,0.4); /* Stronger shadow */
        transition: 0.2s; 
        z-index: 20; 
        line-height: 28px; /* Center the icon */
        text-align: center;
        font-weight: bold;
        padding: 0;
    }
    .remove-btn:hover { 
        background: #8a1515; /* Even darker on hover */
        transform:translateX(-50%) scale(1.1); 
    }
    /* üõ†Ô∏è END REDESIGN üõ†Ô∏è */
    
    .bracelet-charm img { width:90px; height:150px; object-fit:cover; }
    .controls { 
        display:flex; 
        gap:5px; 
        margin-top:5px; 
        justify-content: center; 
        width: 100%; 
    }
    .move-left, .move-right { border:none; background:rgba(0,0,0,0.4); color:white; border-radius:4px; font-size:14px; padding:2px 6px; cursor:pointer; }

    .total-box { margin-top:15px; text-align:center; }
    .total-box p { font-size:20px; font-weight:bold; margin:5px 0; }
    .action-buttons { display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }

    /* --- LARGER ACTION BUTTONS --- */
    .add-recommended-btn { 
        background:#ff9800; 
        color:white; 
        border:none; 
        padding: 12px 22px; 
        border-radius:10px; 
        font-size:18px; 
        cursor:pointer; 
        transition:0.2s; 
    }
    .add-recommended-btn:hover { background:#e68900; transform:scale(1.05); }

    .add-to-cart-btn { 
        background: #007bff; 
        color: white; 
        border: none; 
        padding: 12px 22px; 
        border-radius: 10px; 
        font-size: 18px; 
        cursor: pointer; 
        transition: 0.2s; 
    }
    .add-to-cart-btn:hover {
        background: #0056b3;
        transform: scale(1.05);
    }
    /* End Button Styles */


    /* --- CATEGORY GALLERY: STICK TO EDGES --- */
    .category-gallery { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
        gap: 10px; 
        padding: 10px; 
        width: 100%; 
        max-width: 100%; 
        margin: 0; 
        box-sizing: border-box; 
        justify-content: center; 
    }
    .category-item { 
        background:white; 
        border:2px solid #eee; 
        border-radius:10px; 
        padding: 20px 15px;
        cursor:pointer; 
        transition:0.2s; 
        text-align:center; 
        font-size: 1.2rem; 
        margin: 0; 
        opacity: 1 !important; 
    }
    .category-item:hover { 
        border-color:#eee; 
        transform: none; 
    }
    
    .category-item img { width:100px; height:150px; object-fit:cover; border-radius:8px; }

    /* Modal */
    .modal { 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background: rgba(0,0,0,0.5); 
        display:none; 
        justify-content:center; 
        align-items:flex-end; 
        z-index:10000; 
        backdrop-filter: none; 
    }
    .modal-content { 
        background:white; 
        padding: 15px 0 0 0; 
        border-radius:10px 10px 0 0; 
        width: 100%; 
        max-width: none; 
        max-height: 50vh; 
        height: auto; 
        overflow-y: auto; 
        text-align:center; 
        position: relative; 
        bottom: 0;
        left: 0; 
        transform: none; 
    }
    
    /* --- CHARM GRID: STICK TO EDGES (uses padding only from the item itself) --- */
    .charm-grid { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(6, 1fr)); 
        max-width: 100%; 
        width: 100%; 
        margin: 0; 
        padding: 10px; 
        box-sizing: border-box;
        gap: 10px; 
    }
    
    .recommended-item { 
        background:white; 
        border:2px solid #eee; 
        border-radius:10px; 
        padding:10px; 
        cursor:pointer; 
        transition:0.2s; 
        text-align: center;
    }
    .recommended-item:hover { border-color:#007bff; transform:scale(1.05); }
    /* Adjusted image size for selection tiles */
    .recommended-item img { 
        width: 60px; 
        height: 100px; 
        object-fit:cover; 
        border-radius:10px; 
    }
    
    /* CLOSE BUTTON TOP-RIGHT */
    .close-modal-btn { 
        margin-top:0; 
        background:#ff4c4c; 
        color:white; 
        border:none; 
        padding:8px 14px; 
        border-radius:4px; 
        cursor:pointer; 
        
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10001; 
    }

    /* Media Queries for Mobile Responsiveness */
    @media (max-width: 768px) {
        .header {
            flex-direction: column; 
            align-items: flex-start; 
            padding: 10px 15px; 
        }
        .header h3 {
            order: 1; 
            width: 100%;
            text-align: center;
            margin-top: 10px;
            font-size: 1.3rem; /* Adjusted title size for mobile */
        }
        .back-home {
            order: 0; 
            font-size: 16px; 
            padding: 10px 18px; 
        }
        .header-gif {
            order: 2; 
            margin-top: 10px;
            max-height: 50px; 
        }
        
        .preview-box {
            top: 70px; /* Adjusted sticky position for mobile due to slightly taller header */
            width: 95%;
            margin: 10px auto;
            padding: 20px;
        }
        .preview-header {
            flex-direction: column;
            align-items: center;
        }
        
        /* Adjust button padding/size for mobile */
        .cancel-btn, .add-to-cart-btn, .add-recommended-btn {
            width: 100%; 
            font-size: 16px; 
            padding: 10px 18px;
        }


        .category-gallery {
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
            gap: 5px; 
            padding: 5px; 
        }

        .charm-grid {
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); 
            gap: 5px; 
            padding: 10px 5px; 
        }

        .modal-content {
            max-height: 75vh; 
            padding-bottom: 50px; 
        }
    }

    @media (max-width: 480px) {
        .category-gallery {
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
        }
        .charm-grid {
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); 
        }
        .bracelet-charm img {
            width: 70px; 
            height: 120px;
        }
        .remove-btn {
            /* Ensure it remains visible on smaller screens too */
            top: -28px; 
            width: 22px;
            height: 22px;
            font-size: 16px; /* Slightly smaller font size on tiny screens */
            line-height: 20px;
        }
    }

</style>

</head>
<body>

  <div class="header">
    <a href="/" class="back-home">üè† Back to Home</a>
    <img src="YOUR_GIF_URL_HERE" alt="Decorative GIF" class="header-gif">
    <h3>Customize Your Bracelet</h3>
  </div>

  <div class="preview-box" id="previewBox">
    <div class="preview-header">
      <h3>ü™Ñ Preview Bracelet</h3>
      <button id="cancelSelection" class="cancel-btn">‚ùå Cancel Selection</button>
    </div>

    <div id="bracelet-preview">Your charms will appear here...</div>

    <div class="total-box">
      <p>Total Charms: <span id="totalCharms">0</span></p>
      <p>Total Price: <span id="totalPrice">0·üõ</span></p>
      <div class="action-buttons">
        <button class="add-recommended-btn" id="recommendedBtn">‚ú® Add Recommended Charm</button>
        <button class="add-to-cart-btn" id="addToCartBtn">üõçÔ∏è Add to Cart</button>
      </div>
    </div>
  </div>

  <h2 class="title">ü™Ñ Choose a Category ü™Ñ</h2>
  <div id="categoryGallery" class="category-gallery"></div>

  <div id="charmModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <div id="charmGrid" class="charm-grid"></div>
      <button id="closeModalBtn" class="close-modal-btn">Close</button>
    </div>
  </div>

  <script>
    // DOM refs
    const preview = document.getElementById('bracelet-preview');
    const totalPrice = document.getElementById('totalPrice');
    const totalCharms = document.getElementById('totalCharms'); 
    const categoryGallery = document.getElementById('categoryGallery');
    const charmModal = document.getElementById('charmModal');
    const charmGrid = document.getElementById('charmGrid');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const recommendedBtn = document.getElementById('recommendedBtn');
    const addToCartBtn = document.getElementById('addToCartBtn'); 

    // Initialize charms array by attempting to load from local storage
    let charms = JSON.parse(localStorage.getItem('customCharms')) || [];

    // --- FULL CHARM DATA ARRAY ---
    const allCharms = [
    
    ];
    // --- END FULL CHARM DATA ARRAY ---


    // Build unique categories 
    const categories = Array.from(allCharms.reduce((s, ch) => {
      ch.categories.forEach(cat => { if (!s.has(cat)) s.add(cat); });
      return s;
    }, new Set()));

    // --- Core Functions ---

    // Renders the category tiles on the main page
    function renderCategoriesImpl() {
      categoryGallery.innerHTML = '';
      categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.tabIndex = 0;
        item.dataset.category = cat;

        const imgSrc = getCategoryImage(cat);
        item.innerHTML = `<img src="${imgSrc}" alt="${escapeHtml(cat)}"><p>${escapeHtml(cat)}</p>`;
        item.addEventListener('click', () => openCharmModal(cat));
        item.addEventListener('keydown', (e) => { if (e.key === 'Enter') openCharmModal(cat); });

        categoryGallery.appendChild(item);
      });
    }

    // Gets an image for a category
    function getCategoryImage(cat) {
      const found = allCharms.find(c => c.categories.includes(cat));
      // Fallback for missing images
      return found ? found.image : '/static/images/default.jpg'; 
    }

    // Open modal and populate charms for the chosen category
    function openCharmModal(category) {
      modalTitle.textContent = `‚ú® ${category} Charms ‚ú®`;
      charmGrid.innerHTML = '';

      const charmsInCategory = allCharms.filter(ch => ch.categories.includes(category));
      if (charmsInCategory.length === 0) {
        charmGrid.innerHTML = `<p>No charms in this category.</p>`;
      } else {
        charmsInCategory.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'recommended-item';
          // Store only the index of the charm in allCharms for simplicity, 
          // or store the full data attributes for robustness if allCharms is huge.
          // Sticking with data attributes for minimal change to existing logic.
          div.dataset.image = ch.image;
          div.dataset.name = ch.name_kh;
          div.dataset.price = ch.price;
          div.innerHTML = `
            <img src="${ch.image}" alt="${escapeHtml(ch.name_kh)}">
            <p>${escapeHtml(ch.name_kh)}</p>
            <p><strong>${Number(ch.price).toLocaleString()}·üõ</strong></p>
          `;
          
          // FIX: Updated click handler to properly pass data to addCharm
          div.addEventListener('click', (e) => {
            // Get data attributes directly from the clicked element
            const image = div.dataset.image;
            const name = div.dataset.name;
            const price = div.dataset.price;
            addCharm(image, name, price);
            // NOTE: The request asked to keep the modal open, 
            // but the original code had closeCharmModal() commented out. 
            // The original logic seems to want it closed, but the request wants it open.
            // I will comment out the close in addCharm to satisfy the request. 
            // But if the selection is made via click on one of the charms, the intent is usually to close it.
            // Since the user is asking to keep it there, I will adjust the comment in addCharm.
          });
          charmGrid.appendChild(div);
        });
      }

      charmModal.style.display = 'flex';
      charmModal.setAttribute('aria-hidden','false');
    }

    function closeCharmModal() {
      charmModal.style.display = 'none';
      charmModal.setAttribute('aria-hidden','true');
    }

    // Renders the bracelet preview and total price
    function renderBracelet() {
      preview.innerHTML = '';
      const charmCount = charms.length;

      // Save the current state to localStorage
      localStorage.setItem('customCharms', JSON.stringify(charms));

      if (charmCount === 0) {
        preview.textContent = 'Your charms will appear here...';
        totalPrice.textContent = '0·üõ';
        totalCharms.textContent = '0'; // Update total charms
        return;
      }

      let total = 0;
      charms.forEach((charm, idx) => {
        total += Number(charm.price);
        const div = document.createElement('div');
        div.className = 'bracelet-charm';
        div.innerHTML = `
          <button class="remove-btn" data-index="${idx}" title="Remove">‚àí </button>
          <img src="${charm.image}" alt="${escapeHtml(charm.name)}">
          <div class="controls">
            <button class="move-left" data-index="${idx}" title="Move left" ${idx === 0 ? 'disabled' : ''}>‚¨ÖÔ∏è</button>
            <button class="move-right" data-index="${idx}" title="Move right" ${idx === charmCount - 1 ? 'disabled' : ''}>‚û°Ô∏è</button>
          </div>
        `;
        preview.appendChild(div);
      });

      // Scroll to the end of the bracelet preview when a new charm is added
      preview.scrollLeft = preview.scrollWidth;

      totalPrice.textContent = total.toLocaleString() + '·üõ';
      totalCharms.textContent = charmCount; // Update total charms
    }

    // Add / remove / move
    function addCharm(image, name, price) {
      charms.push({ image, name, price: Number(price) });
      renderBracelet();
      // Per the user request, DO NOT close the modal automatically after selection
      // closeCharmModal(); 
    }

    function removeCharm(index) {
      charms.splice(index, 1);
      renderBracelet();
    }

    function moveLeft(index) {
      if (index > 0) {
        [charms[index-1], charms[index]] = [charms[index], charms[index-1]];
        renderBracelet();
      }
    }

    function moveRight(index) {
      if (index < charms.length - 1) {
        [charms[index+1], charms[index]] = [charms[index], charms[index+1]];
        renderBracelet();
      }
    }

    // Add to Cart Functionality
    function addToCart() {
        if (charms.length === 0) {
            alert('Please add at least one charm to your bracelet before adding it to the cart!');
            return;
        }

        const total = charms.reduce((sum, charm) => sum + charm.price, 0);
        const charmNames = charms.map(c => c.name).join(', ');
        const itemCount = charms.length;

        const cartItem = {
            name: `Custom Bracelet (${itemCount} charms)`,
            details: charmNames,
            total_price: total
        };

        // --- Simulated Cart Action ---
        console.log('--- Item Added to Cart (Simulated) ---');
        console.log(cartItem);
        // --- End Simulated Cart Action ---

        alert(`‚úÖ Successfully added a Custom Bracelet with ${itemCount} charms for ${total.toLocaleString()}·üõ to your cart!`);
        
        // Clear saved design after adding to cart
        charms = [];
        renderBracelet();
    }

    // helper to escape text for safe insertion
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // --- Event Listeners ---

    // EVENT DELEGATION SETUP (Handles clicks on dynamically rendered charm controls)
    preview.addEventListener('click', (e) => {
        const target = e.target;
        // Check if the clicked element is one of the control buttons
        if (target.classList.contains('remove-btn') || 
            target.classList.contains('move-left') || 
            target.classList.contains('move-right')) {
            
            // Get the index from the button's data-index attribute
            const index = Number(target.dataset.index);

            if (target.classList.contains('remove-btn')) {
                removeCharm(index);
            } else if (target.classList.contains('move-left')) {
                moveLeft(index);
            } else if (target.classList.contains('move-right')) {
                moveRight(index);
            }
            e.preventDefault(); 
        }
    });

    document.getElementById('cancelSelection').addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel your bracelet design? This will clear your saved progress.')) {
        charms = [];
        // Explicitly clear local storage upon cancellation
        localStorage.removeItem('customCharms');
        renderBracelet();
      }
    });

    recommendedBtn.addEventListener('click', () => {
      if (allCharms.length === 0) return;
      const random = allCharms[Math.floor(Math.random()*allCharms.length)];
      addCharm(random.image, random.name_kh, random.price);
    });

    addToCartBtn.addEventListener('click', addToCart);

    closeModalBtn.addEventListener('click', closeCharmModal);
    charmModal.addEventListener('click', (e) => {
      if (e.target === charmModal) closeCharmModal();
    });

    // initial render
    renderCategoriesImpl();
    // This will load saved charms (if any) and render the bracelet
    renderBracelet();

  </script>
</body>
</html>
