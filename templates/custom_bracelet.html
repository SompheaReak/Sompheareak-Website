<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Somphea Reak - Studio Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* --- CORE SETUP --- */
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        background-color: #f8fafc;
        overscroll-behavior-y: none;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- ANIMATIONS --- */
    @keyframes popIn {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    /* Only apply animation to elements with this class */
    .animate-pop-new { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

    /* --- CHARM STYLES --- */
    .bracelet-link-container {
        transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        touch-action: none;
        z-index: 10;
        
        /* UPDATED DIMENSIONS FOR 900x1500px IMAGES */
        height: 75%; /* Occupy 75% of the tray height */
        width: auto; /* Width scales automatically */
        aspect-ratio: 2 / 3.5; /* Matches ~900x1500 ratio */
        
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .bracelet-link-container:active { transform: scale(0.95); }

    .dragging {
        transform: scale(1.15) translateY(-20px) rotate(2deg) !important;
        z-index: 50;
        filter: drop-shadow(0 20px 30px rgba(0,0,0,0.2));
        opacity: 0.9;
    }

    .drag-over {
        transform: translateX(15px);
    }

    /* --- UI POLISH --- */
    .glass-nav {
        background: rgba(255, 255, 255, 0.95);
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .jewelry-tray {
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
        box-shadow: inset 0 2px 15px rgba(0,0,0,0.03);
    }

    /* --- DRAWER --- */
    #drawer {
        transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        will-change: transform;
    }

    /* --- SCREENSHOT HIDDEN --- */
    .screenshot-frame {
        background: #fff;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 1200px;
    }

    /* DELETE BUTTON */
    .delete-btn {
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .delete-btn.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        pointer-events: auto;
    }
    .delete-btn.hide {
        opacity: 0;
        transform: translate(-50%, -20%) scale(0.5);
        pointer-events: none;
    }

    .is-selected img {
        filter: brightness(1.1) drop-shadow(0 0 8px rgba(234, 88, 12, 0.5));
    }
  </style>
</head>
<body class="text-slate-900 h-screen flex flex-col overflow-hidden" onclick="handleGlobalClick(event)">

  <!-- 1. HEADER -->
  <header class="glass-nav fixed top-0 left-0 right-0 z-50 px-4 h-16 flex items-center justify-between shadow-sm">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden border border-slate-200">
            <img src="/static/images/logo.jpg" alt="Logo" class="w-full h-full object-cover">
        </div>
        <div class="flex flex-col">
            <h1 class="text-sm font-extrabold text-slate-900 uppercase tracking-tight leading-tight">Somphea Reak</h1>
            <span class="text-[9px] font-bold text-orange-600 uppercase tracking-widest">Bracelet Studio</span>
        </div>
    </div>

    <div class="flex items-center gap-2">
        <a href="/" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 transition active:scale-95">
             <i class="fa-solid fa-house text-xs"></i>
        </a>
        <button onclick="clearBracelet()" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 transition active:scale-95">
            <i class="fa-regular fa-trash-can text-xs"></i>
        </button>
    </div>
  </header>

  <!-- 2. WORKSPACE -->
  <main class="flex-1 flex flex-col pt-16 pb-24 relative overflow-y-auto">
      
      <!-- Preview Tray -->
      <section class="flex-none relative z-20 bg-white shadow-sm border-b border-slate-100">
          <div class="px-6 py-3 flex justify-between items-center">
              <span id="link-count" class="bg-slate-900 text-white text-[9px] font-bold px-3 py-1 rounded-full uppercase tracking-wider">0 Links</span>
              <div class="text-right">
                  <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Total</p>
                  <p id="total-price" class="text-lg font-black text-slate-900 leading-none">0áŸ›</p>
              </div>
          </div>

          <!-- Tray Area: Height increased -->
          <div class="jewelry-tray relative w-full h-80 bg-slate-50 overflow-hidden group">
              <div class="absolute top-1/2 left-0 w-full h-px border-t border-dashed border-slate-300 -translate-y-1/2 opacity-50 pointer-events-none"></div>

              <!-- Scrollable Track -->
              <div id="bracelet-preview" onscroll="handlePreviewScroll(this)" 
                   class="absolute inset-0 flex items-center px-[50vw] overflow-x-auto no-scrollbar gap-1 snap-x snap-mandatory">
                  
                  <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-40">
                      <i class="fa-solid fa-gem text-3xl mb-2 text-slate-300"></i>
                      <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Add charms below</p>
                  </div>

              </div>

              <!-- Fade Edges -->
              <div class="absolute inset-y-0 left-0 w-8 bg-gradient-to-r from-slate-50 to-transparent pointer-events-none"></div>
              <div class="absolute inset-y-0 right-0 w-8 bg-gradient-to-l from-slate-50 to-transparent pointer-events-none"></div>
          </div>

          <!-- Scroll Indicator -->
          <div class="px-6 py-3 flex items-center gap-4">
              <button onclick="scrollManual(-100)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-caret-left"></i></button>
              <div class="flex-grow h-1 bg-slate-100 rounded-full overflow-hidden relative">
                  <div id="scroll-thumb" class="absolute left-0 top-0 h-full w-1/3 bg-slate-300 rounded-full transition-all duration-100"></div>
              </div>
              <button onclick="scrollManual(100)" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-caret-right"></i></button>
          </div>
      </section>

      <!-- Category Gallery -->
      <section class="p-4">
          <div class="flex items-center justify-between mb-4 px-2">
              <h3 class="text-xs font-bold text-slate-900 uppercase tracking-widest">Collections</h3>
          </div>
          <div id="categoryGallery" class="grid grid-cols-6 gap-2"></div>
      </section>

  </main>

  <!-- 3. DRAWER -->
  <div id="drawer" class="fixed inset-0 z-[100] translate-y-full pointer-events-none">
      <div class="absolute inset-0 bg-slate-900/60 pointer-events-auto opacity-0 transition-opacity duration-300" id="drawer-backdrop" onclick="closeDrawer()"></div>
      
      <div class="absolute bottom-0 left-0 right-0 h-[65vh] bg-white rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pointer-events-auto flex flex-col">
          <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-4 mb-2"></div>
          
          <div class="px-6 pb-4 flex items-center justify-between border-b border-slate-50">
              <div>
                  <span class="text-[9px] font-bold text-orange-500 uppercase tracking-widest">Select Items</span>
                  <h4 id="drawer-title" class="text-xl font-bold text-slate-900">Category</h4>
              </div>
              <button onclick="closeDrawer()" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition">
                  <i class="fa-solid fa-xmark"></i>
              </button>
          </div>

          <div class="flex-1 overflow-y-auto px-4 py-6 scrollbar-hide">
              <div id="charmGrid" class="grid grid-cols-7 gap-1 pb-12"></div>
          </div>
      </div>
  </div>

  <!-- 4. FOOTER -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-slate-100 p-4 z-[90]">
      <div class="max-w-md mx-auto flex gap-3">
          <button onclick="addRandom()" class="w-14 h-14 flex-none bg-white border border-slate-200 rounded-2xl text-slate-400 shadow-sm flex items-center justify-center active:scale-90 transition">
              <i class="fa-solid fa-dice text-xl"></i>
          </button>
          <button onclick="takeScreenshot()" id="screenshot-btn" disabled class="flex-1 bg-slate-900 text-white rounded-2xl shadow-lg flex items-center justify-center gap-2 font-bold text-xs uppercase tracking-widest active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fa-solid fa-camera"></i>
              <span>Save Design</span>
          </button>
      </div>
  </div>

  <!-- 5. RESULT MODAL -->
  <div id="resultModal" class="fixed inset-0 z-[200] bg-black/90 hidden flex-col items-center justify-center p-6 backdrop-blur-sm">
      <div class="w-full max-w-sm bg-white rounded-3xl overflow-hidden shadow-2xl p-2 pop-in">
          <div class="relative bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
              <img id="screenshotPreview" class="w-full h-auto" src="" alt="Design">
              <button onclick="closeResult()" class="absolute top-3 right-3 w-8 h-8 bg-black/10 hover:bg-black/20 text-slate-900 rounded-full flex items-center justify-center backdrop-blur-md transition">
                  <i class="fa-solid fa-xmark"></i>
              </button>
          </div>
          <div class="p-5 text-center">
              <h3 class="font-bold text-slate-900 text-lg mb-1">Looking Good!</h3>
              <p class="text-xs text-slate-500 mb-4">Press and hold the image to save it to your Photos.</p>
              <button id="downloadBtn" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl text-xs uppercase tracking-widest shadow-lg shadow-orange-500/20 active:scale-95 transition">
                  Download Image
              </button>
          </div>
      </div>
  </div>

  <!-- 6. LOADING -->
  <div id="loadingOverlay" class="fixed inset-0 z-[210] bg-white/90 backdrop-blur-sm hidden flex-col items-center justify-center">
      <div class="w-10 h-10 border-4 border-slate-200 border-t-slate-900 rounded-full animate-spin"></div>
  </div>

  <script>
    // --- DATA ---
    const allCharms = [
    // --- PINK LETTERS (9001 - 9026) ---
    {"id": 9001, "name_kh": "Pink Letter Charm A", "price": 1200, "image": "/static/images/ap.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9002, "name_kh": "Pink Letter Charm B", "price": 1200, "image": "/static/images/bp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9003, "name_kh": "Pink Letter Charm C", "price": 1200, "image": "/static/images/cp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9004, "name_kh": "Pink Letter Charm D", "price": 1200, "image": "/static/images/dp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9005, "name_kh": "Pink Letter Charm E", "price": 1200, "image": "/static/images/ep.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9006, "name_kh": "Pink Letter Charm F", "price": 1200, "image": "/static/images/fp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9007, "name_kh": "Pink Letter Charm G", "price": 1200, "image": "/static/images/gp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9008, "name_kh": "Pink Letter Charm H", "price": 1200, "image": "/static/images/hp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9009, "name_kh": "Pink Letter Charm I", "price": 1200, "image": "/static/images/ip.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9010, "name_kh": "Pink Letter Charm J", "price": 1200, "image": "/static/images/jp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9011, "name_kh": "Pink Letter Charm K", "price": 1200, "image": "/static/images/kp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9012, "name_kh": "Pink Letter Charm L", "price": 1200, "image": "/static/images/lp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9013, "name_kh": "Pink Letter Charm M", "price": 1200, "image": "/static/images/mp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9014, "name_kh": "Pink Letter Charm N", "price": 1200, "image": "/static/images/np.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9015, "name_kh": "Pink Letter Charm O", "price": 1200, "image": "/static/images/op.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9016, "name_kh": "Pink Letter Charm P", "price": 1200, "image": "/static/images/pp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9017, "name_kh": "Pink Letter Charm Q", "price": 1200, "image": "/static/images/qp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9018, "name_kh": "Pink Letter Charm R", "price": 1200, "image": "/static/images/rp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9019, "name_kh": "Pink Letter Charm S", "price": 1200, "image": "/static/images/sp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9020, "name_kh": "Pink Letter Charm T", "price": 1200, "image": "/static/images/tp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9021, "name_kh": "Pink Letter Charm U", "price": 1200, "image": "/static/images/up.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9022, "name_kh": "Pink Letter Charm V", "price": 1200, "image": "/static/images/vp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9023, "name_kh": "Pink Letter Charm W", "price": 1200, "image": "/static/images/wp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9024, "name_kh": "Pink Letter Charm X", "price": 1200, "image": "/static/images/xp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 9025, "name_kh": "Pink Letter Charm Y", "price": 1200, "image": "/static/images/yp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 9026, "name_kh": "Pink Letter Charm Z", "price": 1200, "image": "/static/images/zp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},

// --- SILVER/GOLD LETTERS (1101 - 1126) ---
    {"id": 1101, "name_kh": "Letter Charm A", "price": 1200, "image": "/static/images/a.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1102, "name_kh": "Letter Charm B", "price": 1200, "image": "/static/images/b.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1103, "name_kh": "Letter Charm C", "price": 1200, "image": "/static/images/c.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1104, "name_kh": "Letter Charm D", "price": 1200, "image": "/static/images/d.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1105, "name_kh": "Letter Charm E", "price": 1200, "image": "/static/images/e.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1106, "name_kh": "Letter Charm F", "price": 1200, "image": "/static/images/f.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1107, "name_kh": "Letter Charm G", "price": 1200, "image": "/static/images/g.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1108, "name_kh": "Letter Charm H", "price": 1200, "image": "/static/images/h.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1109, "name_kh": "Letter Charm I", "price": 1200, "image": "/static/images/i.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1110, "name_kh": "Letter Charm J", "price": 1200, "image": "/static/images/j.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1111, "name_kh": "Letter Charm K", "price": 1200, "image": "/static/images/k.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1112, "name_kh": "Letter Charm L", "price": 1200, "image": "/static/images/l.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1113, "name_kh": "Letter Charm M", "price": 1200, "image": "/static/images/m.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1114, "name_kh": "Letter Charm N", "price": 1200, "image": "/static/images/n.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1115, "name_kh": "Letter Charm O", "price": 1200, "image": "/static/images/o.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1116, "name_kh": "Letter Charm P", "price": 1200, "image": "/static/images/p.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1117, "name_kh": "Letter Charm Q", "price": 1200, "image": "/static/images/q.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1118, "name_kh": "Letter Charm R", "price": 1200, "image": "/static/images/r.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1119, "name_kh": "Letter Charm S", "price": 1200, "image": "/static/images/s.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1120, "name_kh": "Letter Charm T", "price": 1200, "image": "/static/images/t.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1121, "name_kh": "Letter Charm U", "price": 1200, "image": "/static/images/u.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1122, "name_kh": "Letter Charm V", "price": 1200, "image": "/static/images/v.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1123, "name_kh": "Letter Charm W", "price": 1200, "image": "/static/images/w.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1124, "name_kh": "Letter Charm X", "price": 1200, "image": "/static/images/x.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1125, "name_kh": "Letter Charm Y", "price": 1200, "image": "/static/images/y.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1126, "name_kh": "Letter Charm Z", "price": 1200, "image": "/static/images/z.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},

   
    // --- STEAV (1201 - 1213) ---
    {"id": 1201, "name_kh": "Steav Charm 01", "price": 3000, "image": "/static/images/cm01.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1202, "name_kh": "Steav Charm 02", "price": 3000, "image": "/static/images/cm02.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1203, "name_kh": "Steav Charm 03", "price": 3000, "image": "/static/images/cm03.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1204, "name_kh": "Steav Charm 04", "price": 3000, "image": "/static/images/cm04.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1205, "name_kh": "Steav Charm 05", "price": 3000, "image": "/static/images/cm05.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1206, "name_kh": "Steav Charm 06", "price": 3000, "image": "/static/images/cm06.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1207, "name_kh": "Steav Charm 07", "price": 3000, "image": "/static/images/cm07.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1208, "name_kh": "Steav Charm 08", "price": 3000, "image": "/static/images/cm08.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1209, "name_kh": "Steav Charm 09", "price": 3000, "image": "/static/images/cm09.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1210, "name_kh": "Steav Charm 10", "price": 3000, "image": "/static/images/cm10.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1211, "name_kh": "Steav Charm 11", "price": 3000, "image": "/static/images/cm11.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1212, "name_kh": "Steav Charm 12", "price": 3000, "image": "/static/images/cm12.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1213, "name_kh": "Steav Charm 13", "price": 4000, "image": "/static/images/cm13.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    
    // --- Cartoon (1301) ---
    {"id": 13001, "name_kh": "Cartoon Charm", "price": 3000, "image": "/static/images/ct01.jpg", "categories": ["Cartoon"]},

    // --- CUTIE (1401 - 1416) ---
    {"id": 1401, "name_kh": "Cutie Charm 01", "price": 3000, "image": "/static/images/cw01.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1402, "name_kh": "Cutie Charm 02", "price": 3000, "image": "/static/images/cw02.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1403, "name_kh": "Cutie Charm 03", "price": 3000, "image": "/static/images/cw03.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1404, "name_kh": "Cutie Charm 04", "price": 3000, "image": "/static/images/cw04.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1405, "name_kh": "Cutie Charm 05", "price": 3000, "image": "/static/images/cw05.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1406, "name_kh": "Cutie Charm 06", "price": 4000, "image": "/static/images/cw06.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1407, "name_kh": "Cutie Charm 07", "price": 4000, "image": "/static/images/cw07.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1408, "name_kh": "Cutie Charm 08", "price": 4000, "image": "/static/images/cw08.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1409, "name_kh": "Cutie Charm 09", "price": 4000, "image": "/static/images/cw09.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1410, "name_kh": "Cutie Charm 10", "price": 4000, "image": "/static/images/cw10.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20}, 
    {"id": 1411, "name_kh": "Cutie Charm 11", "price": 4000, "image": "/static/images/cw11.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1412, "name_kh": "Cutie Charm 12", "price": 4000, "image": "/static/images/cw12.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1413, "name_kh": "Cutie Charm 13", "price": 4000, "image": "/static/images/cw13.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1414, "name_kh": "Cutie Charm 14", "price": 4000, "image": "/static/images/cw14.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1415, "name_kh": "Cutie Charm 15", "price": 4000, "image": "/static/images/cw15.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1416, "name_kh": "Cutie Charm 16", "price": 4000, "image": "/static/images/cw16.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},

    // --- Bubble (1501 - 1512) ---
    {"id": 1501, "name_kh": " Charm 01", "price": 3000, "image": "/static/images/charm-bubble-01.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1502, "name_kh": " Charm 02", "price": 3000, "image": "/static/images/charm-bubble-02.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1503, "name_kh": " Charm 03", "price": 3000, "image": "/static/images/charm-bubble-03.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1504, "name_kh": " Charm 04", "price": 3000, "image": "/static/images/charm-bubble-04.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1505, "name_kh": " Charm 05", "price": 3000, "image": "/static/images/charm-bubble-05.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1506, "name_kh": " Charm 06", "price": 3000, "image": "/static/images/charm-bubble-06.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1507, "name_kh": " Charm 07", "price": 3000, "image": "/static/images/charm-bubble-07.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1508, "name_kh": " Charm 08", "price": 3000, "image": "/static/images/charm-bubble-08.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1509, "name_kh": " Charm 09", "price": 3000, "image": "/static/images/charm-bubble-09.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1510, "name_kh": " Charm 10", "price": 3000, "image": "/static/images/charm-bubble-10.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1511, "name_kh": " Charm 11", "price": 3000, "image": "/static/images/charm-bubble-11.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1512, "name_kh": " Charm 12", "price": 3000, "image": "/static/images/charm-bubble-12.jpg", "categories": ["SlayðŸ’…"], "subcategory": ["All","Football"], "discount": 20},

    // --- Cute Cat (1601 - 1612) ---
    {"id": 1601, "name_kh": " Charm 01", "price": 3000, "image": "/static/images/charm-cutecat-01.jpg", "categories": ["Cute Cat"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1602, "name_kh": " Charm 02", "price": 3000, "image": "/static/images/charm-cutecat-02.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1603, "name_kh": " Charm 03", "price": 3000, "image": "/static/images/charm-cutecat-03.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1604, "name_kh": " Charm 04", "price": 3000, "image": "/static/images/charm-cutecat-04.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1605, "name_kh": " Charm 05", "price": 3000, "image": "/static/images/charm-cutecat-05.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1606, "name_kh": " Charm 06", "price": 3000, "image": "/static/images/charm-cutecat-06.jpg", "categories": ["Cute Cat"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1607, "name_kh": " Charm 07", "price": 3000, "image": "/static/images/charm-cutecat-07.jpg", "categories": ["Cute Cat"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 1608, "name_kh": " Charm 08", "price": 3000, "image": "/static/images/charm-cutecat-08.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1609, "name_kh": " Charm 09", "price": 3000, "image": "/static/images/charm-cutecat-09.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1610, "name_kh": " Charm 10", "price": 3000, "image": "/static/images/charm-cutecat-10.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1611, "name_kh": " Charm 11", "price": 3000, "image": "/static/images/charm-cutecat-11.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1612, "name_kh": " Charm 12", "price": 3000, "image": "/static/images/charm-cutecat-12.jpg", "categories": ["Cute Cat"], "subcategory": ["All","Football"], "discount": 20},

    // --- Rok Jit (1701 - 1708) ---
    {"id": 1701, "name_kh": "Rok Jit 01", "price": 3000, "image": "/static/images/charm-rokjit-01.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1702, "name_kh": "Rok Jit 02", "price": 3000, "image": "/static/images/charm-rokjit-02.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1703, "name_kh": "Rok Jit 03", "price": 3000, "image": "/static/images/charm-rokjit-03.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1704, "name_kh": "Rok Jit 04", "price": 3000, "image": "/static/images/charm-rokjit-04.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1705, "name_kh": "Rok Jit 05", "price": 3000, "image": "/static/images/charm-rokjit-05.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1706, "name_kh": "Rok Jit 06", "price": 3000, "image": "/static/images/charm-rokjit-06.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1707, "name_kh": "Rok Jit 07", "price": 3000, "image": "/static/images/charm-rokjit-07.jpg", "categories": ["Rok JitðŸ’”"]}, 
    {"id": 1708, "name_kh": "Rok Jit 08", "price": 3000, "image": "/static/images/charm-rokjit-08.jpg", "categories": ["Rok JitðŸ’”"]},

    // --- 8 Ball (1801 - 1803) ---
    {"id": 1801, "name_kh": "8 Ball ðŸŽ± 01", "price": 3000, "image": "/static/images/charm-8ball-01.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1802, "name_kh": "8 Ball ðŸŽ± 02", "price": 3000, "image": "/static/images/charm-8ball-02.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1803, "name_kh": "8 Ball ðŸŽ± 03", "price": 3000, "image": "/static/images/charm-8ball-03.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1804, "name_kh": "8 Ball ðŸŽ± 01", "price": 3000, "image": "/static/images/charm-8ball-04.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1805, "name_kh": "8 Ball ðŸŽ± 02", "price": 3000, "image": "/static/images/charm-8ball-05.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1806, "name_kh": "8 Ball ðŸŽ± 03", "price": 3000, "image": "/static/images/charm-8ball-06.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1807, "name_kh": "8 Ball ðŸŽ± 03", "price": 3000, "image": "/static/images/charm-8ball-07.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1808, "name_kh": "8 Ball ðŸŽ± 01", "price": 3000, "image": "/static/images/charm-8ball-08.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1809, "name_kh": "8 Ball ðŸŽ± 02", "price": 3000, "image": "/static/images/charm-8ball-09.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 1810, "name_kh": "8 Ball ðŸŽ± 03", "price": 3000, "image": "/static/images/charm-8ball-10.jpg", "categories": ["8 Ball ðŸŽ±"]},

    // --- Cherry (1901) ---
    {"id": 1901, "name_kh": "Cherry ðŸ’ 01", "price": 3000, "image": "/static/images/charm-cherry-01.jpg", "categories": ["Cherry ðŸ’"]},

    // --- Christmas (2001)
    {"id": 2001, "name_kh": "Christmas ðŸŽ„ 01", "price": 3000, "image": "/static/images/charm-christmas-01.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2002, "name_kh": "Christmas ðŸŽ„ 02", "price": 3000, "image": "/static/images/charm-christmas-02.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2003, "name_kh": "Christmas ðŸŽ„ 03", "price": 3000, "image": "/static/images/charm-christmas-03.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2004, "name_kh": "Christmas ðŸŽ„ 04", "price": 3000, "image": "/static/images/charm-christmas-04.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2005, "name_kh": "Christmas ðŸŽ„ 05", "price": 3000, "image": "/static/images/charm-christmas-05.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2006, "name_kh": "Christmas ðŸŽ„ 06", "price": 3000, "image": "/static/images/charm-christmas-06.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2007, "name_kh": "Christmas ðŸŽ„ 07", "price": 3000, "image": "/static/images/charm-christmas-07.jpg", "categories": ["Christmas ðŸŽ„"]}, 
    {"id": 2008, "name_kh": "Christmas ðŸŽ„ 08", "price": 3000, "image": "/static/images/charm-christmas-08.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2009, "name_kh": "Christmas ðŸŽ„ 09", "price": 3000, "image": "/static/images/charm-christmas-09.jpg", "categories": ["Christmas ðŸŽ„"]},

    {"id": 2011, "name_kh": "Christmas ðŸŽ„ 01", "price": 3000, "image": "/static/images/charm-christmas-11.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2012, "name_kh": "Christmas ðŸŽ„ 02", "price": 3000, "image": "/static/images/charm-christmas-12.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2013, "name_kh": "Christmas ðŸŽ„ 03", "price": 3000, "image": "/static/images/charm-christmas-13.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2014, "name_kh": "Christmas ðŸŽ„ 04", "price": 3000, "image": "/static/images/charm-christmas-14.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2015, "name_kh": "Christmas ðŸŽ„ 05", "price": 3000, "image": "/static/images/charm-christmas-15.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2016, "name_kh": "Christmas ðŸŽ„ 06", "price": 3000, "image": "/static/images/charm-christmas-16.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2017, "name_kh": "Christmas ðŸŽ„ 07", "price": 3000, "image": "/static/images/charm-christmas-17.jpg", "categories": ["Christmas ðŸŽ„"]}, 
    {"id": 2018, "name_kh": "Christmas ðŸŽ„ 08", "price": 3000, "image": "/static/images/charm-christmas-18.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2019, "name_kh": "Christmas ðŸŽ„ 09", "price": 3000, "image": "/static/images/charm-christmas-19.jpg", "categories": ["Christmas ðŸŽ„"]},

    {"id": 2021, "name_kh": "Christmas ðŸŽ„ 01", "price": 3000, "image": "/static/images/charm-christmas-21.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2022, "name_kh": "Christmas ðŸŽ„ 02", "price": 3000, "image": "/static/images/charm-christmas-22.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2023, "name_kh": "Christmas ðŸŽ„ 03", "price": 3000, "image": "/static/images/charm-christmas-23.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2024, "name_kh": "Christmas ðŸŽ„ 04", "price": 3000, "image": "/static/images/charm-christmas-04.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2025, "name_kh": "Christmas ðŸŽ„ 05", "price": 3000, "image": "/static/images/charm-christmas-05.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2026, "name_kh": "Christmas ðŸŽ„ 06", "price": 3000, "image": "/static/images/charm-christmas-06.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2027, "name_kh": "Christmas ðŸŽ„ 07", "price": 3000, "image": "/static/images/charm-christmas-07.jpg", "categories": ["Christmas ðŸŽ„"]}, 
    {"id": 2028, "name_kh": "Christmas ðŸŽ„ 08", "price": 3000, "image": "/static/images/charm-christmas-08.jpg", "categories": ["Christmas ðŸŽ„"]},
    {"id": 2029, "name_kh": "Christmas ðŸŽ„ 09", "price": 3000, "image": "/static/images/charm-christmas-09.jpg", "categories": ["Christmas ðŸŽ„"]},

    // --- Christmas (2001)
    {"id": 2101, "name_kh": "Flower ðŸŒ¹ 01", "price": 3000, "image": "/static/images/charm-flower-01.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2102, "name_kh": "Flower ðŸŒ¹ 02", "price": 3000, "image": "/static/images/charm-flower-02.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2103, "name_kh": "Flower ðŸŒ¹ 03", "price": 3000, "image": "/static/images/charm-flower-03.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2104, "name_kh": "Flower ðŸŒ¹ 04", "price": 3000, "image": "/static/images/charm-flower-04.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2105, "name_kh": "Flower ðŸŒ¹ 05", "price": 3000, "image": "/static/images/charm-flower-05.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2106, "name_kh": "Flower ðŸŒ¹ 06", "price": 3000, "image": "/static/images/charm-flower-06.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2107, "name_kh": "Flower ðŸŒ¹ 07", "price": 3000, "image": "/static/images/charm-flower-07.jpg", "categories": ["Flower ðŸŒ¹"]}, 
    {"id": 2108, "name_kh": "Flower ðŸŒ¹ 08", "price": 3000, "image": "/static/images/charm-flower-08.jpg", "categories": ["Flower ðŸŒ¹"]},
    {"id": 2109, "name_kh": "Flower ðŸŒ¹ 09", "price": 3000, "image": "/static/images/charm-flower-09.jpg", "categories": ["Flower ðŸŒ¹"]},
       ];

    let selectedCharms = JSON.parse(localStorage.getItem('customCharms')) || [];
    let stockData = {};
    let masterSwitch = "off";
    let activeLinkIndex = null; 
    let recentlyAddedUid = null; // Track newest item for animation

    async function init() {
        renderCategories();
        updateUI(false); // Initial load, no animation
    }

    // --- RENDER CATEGORIES ---
    function renderCategories() {
        const categories = Array.from(new Set(allCharms.flatMap(c => c.categories)));
        const gallery = document.getElementById('categoryGallery');
        
        gallery.innerHTML = categories.map(cat => {
            const charm = allCharms.find(c => c.categories.includes(cat));
            const displayCat = cat.length > 10 ? cat.split(' ')[0] : cat;
            
            return `
                <div onclick="openDrawer('${cat}')" class="group flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition duration-200">
                    <div class="w-full aspect-square rounded-xl bg-white border border-slate-200 shadow-sm p-1 flex items-center justify-center group-hover:border-orange-500 transition-colors">
                        <img src="${charm.image}" class="w-full h-full object-contain rounded-lg">
                    </div>
                    <span class="text-[8px] font-bold text-slate-500 uppercase tracking-tight text-center group-hover:text-slate-900 truncate w-full">${displayCat}</span>
                </div>
            `;
        }).join('');
    }

    // --- DRAWER ---
    function openDrawer(cat) {
        document.getElementById('drawer-title').innerText = cat;
        const grid = document.getElementById('charmGrid');
        const items = allCharms.filter(c => c.categories.includes(cat));
        
        grid.innerHTML = items.map(c => {
            const qty = stockData[c.id] !== undefined ? stockData[c.id] : 99;
            let isOut = false;
            if (masterSwitch === "on" && qty <= 0) isOut = true;

            return `
                <div onclick="${isOut ? '' : `addCharmById(${c.id})`}" 
                     class="flex flex-col gap-1 ${isOut ? 'opacity-40 grayscale pointer-events-none' : 'cursor-pointer active:scale-95 transition-transform'}">
                    <div class="relative w-full aspect-[3/4] bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-center overflow-hidden">
                        <img src="${c.image}" class="w-full h-full object-contain p-0.5 pointer-events-none">
                        ${isOut ? '<div class="absolute inset-0 bg-slate-900/10 flex items-center justify-center"><span class="bg-red-500 text-white text-[6px] font-bold px-1 rounded">SOLD</span></div>' : ''}
                    </div>
                    <div class="text-center">
                        <p class="text-[8px] font-bold text-slate-900 leading-none">${c.price}áŸ›</p>
                    </div>
                </div>
            `;
        }).join('');
        
        const drawer = document.getElementById('drawer');
        const backdrop = document.getElementById('drawer-backdrop');
        drawer.classList.remove('translate-y-full');
        backdrop.classList.remove('opacity-0');
        drawer.classList.add('pointer-events-auto');
    }

    function closeDrawer() {
        const drawer = document.getElementById('drawer');
        const backdrop = document.getElementById('drawer-backdrop');
        drawer.classList.add('translate-y-full');
        backdrop.classList.add('opacity-0');
        drawer.classList.remove('pointer-events-auto');
    }

    // --- LOGIC ---
    function addCharmById(id) {
        // Use loose equality (==) for string/number id mismatch safety
        const charm = allCharms.find(c => c.id == id);
        if(!charm) return;

        const uid = Math.random().toString(36).substr(2, 9);
        const newCharm = { ...charm, uid: uid };
        
        selectedCharms.push(newCharm);
        recentlyAddedUid = uid; // Mark for animation
        
        updateUI(true); // Trigger UI update with animation check
        
        // Scroll to end
        setTimeout(() => {
            const preview = document.getElementById('bracelet-preview');
            preview.scrollTo({ left: preview.scrollWidth, behavior: 'smooth' });
        }, 50);
        
        if (navigator.vibrate) navigator.vibrate(10);
    }

    function toggleCharmSelection(uid, event) {
        event.stopPropagation();
        if (activeLinkIndex === uid) {
            activeLinkIndex = null;
        } else {
            activeLinkIndex = uid;
        }
        updateUI(false);
    }

    function handleGlobalClick(event) {
        if (!event.target.closest('.bracelet-link-container') && activeLinkIndex !== null) {
            activeLinkIndex = null;
            updateUI(false);
        }
    }

    function removeCharm(uid, event) {
        event.stopPropagation();
        selectedCharms = selectedCharms.filter(c => c.uid !== uid);
        activeLinkIndex = null;
        updateUI(false);
        if (navigator.vibrate) navigator.vibrate(10);
    }

    function clearBracelet() {
        if(selectedCharms.length > 0 && confirm("Reset your design?")) {
            selectedCharms = [];
            activeLinkIndex = null;
            updateUI(false);
        }
    }
    
    function addRandom() {
        const rand = allCharms[Math.floor(Math.random() * allCharms.length)];
        if(rand) addCharmById(rand.id);
    }

    function updateUI(shouldAnimate) {
        const preview = document.getElementById('bracelet-preview');
        const emptyState = document.getElementById('empty-state');
        localStorage.setItem('customCharms', JSON.stringify(selectedCharms));

        // Stats
        let total = selectedCharms.reduce((sum, c) => sum + c.price, 0);
        document.getElementById('total-price').innerText = total.toLocaleString() + "áŸ›";
        document.getElementById('link-count').innerText = `${selectedCharms.length} Links`;
        document.getElementById('screenshot-btn').disabled = selectedCharms.length === 0;

        if (selectedCharms.length === 0) {
            emptyState.style.display = 'flex';
            preview.innerHTML = `<div class="w-[50vw] flex-shrink-0"></div><div class="w-[50vw] flex-shrink-0"></div>`; 
            handlePreviewScroll(preview);
            return;
        } else {
            emptyState.style.display = 'none';
        }

        let html = `<div class="w-[50vw] flex-shrink-0"></div>`;
        
        html += selectedCharms.map((c, index) => {
            const isSelected = activeLinkIndex === c.uid;
            // Only animate if it's the recently added one and shouldAnimate is true
            const isNew = shouldAnimate && c.uid === recentlyAddedUid;
            
            return `
            <div class="bracelet-link-container flex-shrink-0 relative group snap-center ${isNew ? 'animate-pop-new' : ''} ${isSelected ? 'is-selected' : ''}"
                 data-uid="${c.uid}"
                 data-index="${index}"
                 onclick="toggleCharmSelection('${c.uid}', event)"
                 ontouchstart="handleTouchStart(event)"
                 ontouchmove="handleTouchMove(event)"
                 ontouchend="handleTouchEnd(event)">
                
                <!-- X Button -->
                <button onclick="removeCharm('${c.uid}', event)" 
                        class="delete-btn absolute -top-8 left-1/2 w-8 h-8 bg-white border-2 border-slate-100 text-red-500 rounded-full flex items-center justify-center text-xs shadow-xl z-30 active:scale-90 ${isSelected ? 'show' : 'hide'}">
                    <i class="fa-solid fa-xmark"></i>
                </button>

                <img src="${c.image}" class="w-full h-full object-contain select-none pointer-events-none drop-shadow-md transition-all duration-200">
            </div>
            `;
        }).join('');

        html += `<div class="w-[50vw] flex-shrink-0"></div>`;
        preview.innerHTML = html;
        handlePreviewScroll(preview);
        
        // Reset recently added so it doesn't animate again on next selection/removal
        if(shouldAnimate) setTimeout(() => { recentlyAddedUid = null; }, 500);
    }

    // --- TOUCH EVENTS ---
    let touchStartIndex = null;
    let currentHoverIndex = null;

    function handleTouchStart(e) {
        if(e.target.closest('.delete-btn')) return;
        const container = e.target.closest('.bracelet-link-container');
        if (!container) return;
        touchStartIndex = parseInt(container.dataset.index);
        setTimeout(() => {
            if(touchStartIndex !== null) container.classList.add('dragging');
        }, 150);
    }

    function handleTouchMove(e) {
        if(touchStartIndex === null) return;
        e.preventDefault();
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const container = target?.closest('.bracelet-link-container');
        
        document.querySelectorAll('.bracelet-link-container').forEach(el => el.classList.remove('drag-over'));
        
        if (container) {
            currentHoverIndex = parseInt(container.dataset.index);
            if (currentHoverIndex !== touchStartIndex) container.classList.add('drag-over');
        }
    }

    function handleTouchEnd(e) {
        document.querySelectorAll('.bracelet-link-container').forEach(el => {
            el.classList.remove('dragging');
            el.classList.remove('drag-over');
        });

        if (touchStartIndex !== null && currentHoverIndex !== null && touchStartIndex !== currentHoverIndex) {
            const item = selectedCharms.splice(touchStartIndex, 1)[0];
            selectedCharms.splice(currentHoverIndex, 0, item);
            updateUI(false); // Don't animate pops on reorder
            if (navigator.vibrate) navigator.vibrate(20);
        }
        touchStartIndex = null;
        currentHoverIndex = null;
    }

    // --- SCROLL & SCREENSHOT ---
    function handlePreviewScroll(el) {
        const thumb = document.getElementById('scroll-thumb');
        const maxScroll = el.scrollWidth - el.clientWidth;
        if (maxScroll <= 0) { thumb.style.width = '100%'; thumb.style.left = '0'; return; }
        const pct = (el.scrollLeft / maxScroll);
        thumb.style.left = `${Math.min(Math.max(pct * 66, 0), 66)}%`;
    }

    function scrollManual(val) {
        document.getElementById('bracelet-preview').scrollBy({ left: val, behavior: 'smooth' });
    }

    async function takeScreenshot() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');

        try {
            const tempDiv = document.createElement('div');
            tempDiv.className = 'screenshot-frame';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            
            // Header
            tempDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px; width: 100%;">
                    <h2 style="font-size: 32px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #0f172a; margin: 0;">Italy Studio</h2>
                    <p style="font-size: 16px; font-weight: 500; color: #64748b; margin-top: 5px;">Custom Design by Somphea Reak</p>
                </div>
            `;
            
            // Grid
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(10, 1fr)'; // 10 Columns
            grid.style.gap = '15px';
            grid.style.background = '#f8fafc';
            grid.style.padding = '50px';
            grid.style.borderRadius = '30px';
            grid.style.width = '100%';
            grid.style.border = '2px solid #e2e8f0';

            selectedCharms.forEach(c => {
                const itemDiv = document.createElement('div');
                itemDiv.style.display = 'flex';
                itemDiv.style.alignItems = 'center';
                itemDiv.style.justifyContent = 'center';
                itemDiv.style.aspectRatio = '2/3.5'; // Match screen aspect
                
                const img = document.createElement('img');
                img.src = c.image;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'contain';
                img.style.filter = 'drop-shadow(0 5px 10px rgba(0,0,0,0.15))';
                
                itemDiv.appendChild(img);
                grid.appendChild(itemDiv);
            });
            tempDiv.appendChild(grid);

            // Footer
            const footer = document.createElement('div');
            footer.style.marginTop = '30px';
            footer.style.textAlign = 'center';
            footer.style.width = '100%';
            footer.innerHTML = `<p style="font-size: 20px; font-weight: 800; color: #334155;">Total: ${document.getElementById('total-price').innerText} â€¢ ${selectedCharms.length} Links</p>`;
            tempDiv.appendChild(footer);

            document.body.appendChild(tempDiv);

            const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
            const dataUrl = canvas.toDataURL("image/png");
            
            document.getElementById('screenshotPreview').src = dataUrl;
            document.getElementById('downloadBtn').onclick = () => {
                const link = document.createElement('a');
                link.download = `bracelet-${Date.now()}.png`;
                link.href = dataUrl;
                link.click();
            };

            document.body.removeChild(tempDiv);
            
            const modal = document.getElementById('resultModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

        } catch (err) {
            console.error(err);
            alert("Error generating image.");
        } finally {
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }
    }

    function closeResult() {
        document.getElementById('resultModal').classList.add('hidden');
        document.getElementById('resultModal').classList.remove('flex');
    }

    init();
  </script>
</body>
</html>


