<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Somphea Reak - Italy Bracelet Studio Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    
    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        background-color: #f8fafc;
        overscroll-behavior-y: contain;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    .link-pop {
        animation: linkPop 0.2s ease-out forwards;
    }
    @keyframes linkPop {
        0% { transform: scale(0.9); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Drag and Drop Visual States */
    .dragging {
        opacity: 0.4;
        transform: scale(1.1);
        z-index: 50;
    }
    .drag-over {
        border-left: 3px solid #ea580c !important;
        transition: border 0.1s ease;
    }

    #drawer {
        transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }

    /* 10 CHARMS PER VIEW CALCULATION */
    .bracelet-link-container {
        display: flex;
        align-items: center;
        justify-content: center;
        /* Calculate width to show exactly 10 per view */
        flex: 0 0 10%; 
        aspect-ratio: 2 / 3.5;
        position: relative;
        margin: 0;
        padding: 0;
        cursor: grab;
        touch-action: none;
    }

    .bracelet-link-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        pointer-events: none;
    }

    .aspect-16-9 { aspect-ratio: 16 / 9; }
    
    /* Smooth scrolling for the preview */
    #bracelet-preview {
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }
    .bracelet-link-container {
        scroll-snap-align: start;
    }
  </style>
</head>
<body class="text-gray-900 overflow-x-hidden">

  <!-- HEADER -->
  <header class="sticky top-0 z-[100] bg-white/95 backdrop-blur-xl border-b border-gray-100 px-4 py-3 flex items-center justify-between">
    <a href="/" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-gray-500 active:scale-90 transition-transform">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <div class="text-center">
        <h3 class="font-extrabold text-[9px] tracking-[0.2em] uppercase text-gray-400 leading-none">Custom Studio</h3>
        <p class="font-black text-sm text-gray-900 tracking-tighter uppercase leading-tight">Italy Bracelet</p>
    </div>
    <div class="w-10"></div>
  </header>

  <!-- PREVIEW BOX (Sticky) -->
  <section class="sticky top-[58px] z-[90] bg-white border-b shadow-lg pb-4">
    <div class="max-w-4xl mx-auto">
        <!-- Control Bar -->
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-2">
                <span id="link-count" class="bg-gray-900 text-[9px] font-black text-white px-2.5 py-1 rounded-full tracking-widest uppercase">0 LINKS</span>
                <span class="text-[8px] font-bold text-gray-400 uppercase italic">Slide to view</span>
            </div>
            <button onclick="clearBracelet()" class="text-[10px] font-black text-red-500 uppercase tracking-widest px-2 py-1">Reset</button>
        </div>

        <!-- SEAMLESS BRACELET PREVIEW (SCROLLABLE) -->
        <div id="bracelet-preview" class="flex overflow-x-auto py-1 scrollbar-hide min-h-[80px] items-center bg-gray-50 border-y border-gray-100 gap-0">
            <div class="w-full text-center py-8 opacity-20">
                <p class="text-[10px] font-black uppercase tracking-[0.4em]">Designer Workspace</p>
            </div>
        </div>

        <!-- Price Summary -->
        <div class="mt-3 flex justify-between items-center px-4">
            <div class="flex flex-col">
                <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest">Est. Total</span>
                <span id="total-price" class="text-xl font-black text-gray-900 leading-none">0áŸ›</span>
            </div>
            <p class="text-[8px] font-bold text-gray-400 uppercase italic text-right leading-tight">Drag and slide<br>to reorder</p>
        </div>
    </div>
  </section>

  <!-- CATEGORY GRID -->
  <section class="p-4 pb-48">
    <div class="mb-4">
        <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Collections</h4>
    </div>
    <div id="categoryGallery" class="grid grid-cols-6 gap-3">
      <!-- Injected by JS -->
    </div>
  </section>

  <!-- SELECTION DRAWER -->
  <div id="drawer" class="fixed inset-0 z-[200] translate-y-full pointer-events-none">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto" onclick="closeDrawer()"></div>
    <div class="absolute bottom-0 left-0 right-0 h-[65vh] bg-white rounded-t-[3rem] shadow-2xl pointer-events-auto flex flex-col border-t border-gray-100">
        <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto my-4"></div>
        <div class="px-6 pb-4 flex items-center justify-between">
            <h4 id="drawer-title" class="text-lg font-black uppercase tracking-tighter text-gray-900">Category</h4>
            <button onclick="closeDrawer()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-400">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto px-2 pb-24">
            <div id="charmGrid" class="grid grid-cols-8 gap-1.5">
                <!-- Injected by JS -->
            </div>
        </div>
    </div>
  </div>

  <!-- FIXED FOOTER -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-gray-100 p-4 z-[110]">
    <div class="max-w-md mx-auto flex gap-3">
        <button onclick="addRandom()" class="w-14 h-14 flex items-center justify-center bg-gray-50 border border-gray-200 rounded-xl text-gray-400 active:scale-90 transition-transform">
            <i class="fa-solid fa-shuffle text-lg"></i>
        </button>
        <button onclick="handleAddToCart()" id="add-to-cart-btn" disabled class="flex-grow bg-gray-900 text-white font-black rounded-xl shadow-xl active:scale-95 transition-all disabled:opacity-20 text-[10px] uppercase tracking-[0.2em]">
            Add To Cart
        </button>
    </div>
  </div>

  <script>
    // --- DATABASE ---
    const allCharms = [
    {"id": 1, "name_kh": "Silver Charm", "price": 400, "image": "/static/images/c01.jpg", "categories": ["Charm"]},
    {"id": 1100, "name_kh": "Classic F1 Logo", "price": 3000, "image": "/static/images/charm-f1â€“101.jpg", "categories": ["Class F1ðŸŽï¸"]},
    {"id": 1192, "name_kh": "Classic F1 - Ferri", "price": 3000, "image": "/static/images/charm-f1-301.jpg", "categories": ["Class F1ðŸŽï¸"]},
    {"id": 1001, "name_kh": "Car Charm 01", "price": 3000, "image": "/static/images/cc01.jpg", "categories": ["Car Logo"]},
    {"id": 2001, "name_kh": "Flag Charm 01", "price": 3000, "image": "/static/images/cf01.jpg", "categories": ["Flag"]},
    {"id": 3001, "name_kh": "Gemstone Charm 01", "price": 3500, "image": "/static/images/cg01.jpg", "categories": ["Gemstone"]},
    {"id": 4001, "name_kh": "Chain Charm 01", "price": 3000, "image": "/static/images/charm-chain-01.jpg", "categories": ["Chain"]},
    {"id": 5001, "name_kh": "Barcelona", "price": 3000, "image": "/static/images/charm-footballclub-01.jpg", "categories": ["Football Club Logo"]},
    {"id": 6001, "name_kh": "Black Charm 01", "price": 3000, "image": "/static/images/cb01.jpg", "categories": ["Black Lover"]},
    {"id": 8001, "name_kh": "Pink Charm 01", "price": 3000, "image": "/static/images/cp01.jpg", "categories": ["Pink Lover"]},
    {"id": 1401, "name_kh": "Cutie Charm 01", "price": 3000, "image": "/static/images/cw01.jpg", "categories": ["Cutie"]},
    {"id": 1501, "name_kh": "Bubble 01", "price": 3000, "image": "/static/images/charm-bubble-01.jpg", "categories": ["SlayðŸ’…"]},
    {"id": 1601, "name_kh": "Cute Cat 01", "price": 3000, "image": "/static/images/charm-cutecat-01.jpg", "categories": ["Cute Cat"]},
    {"id": 1701, "name_kh": "Rok Jit 01", "price": 3000, "image": "/static/images/charm-rokjit-01.jpg", "categories": ["Rok JitðŸ’”"]},
    {"id": 1801, "name_kh": "8 Ball 01", "price": 3000, "image": "/static/images/charm-8ball-01.jpg", "categories": ["8 Ball ðŸŽ±"]},
    {"id": 2101, "name_kh": "Flower 01", "price": 3000, "image": "/static/images/charm-flower-01.jpg", "categories": ["Flower ðŸŒ¹"]},
     // --- CAR LOGOS (1001 - 1015) ---
    {"id": 1001, "name_kh": "Car Charm 01", "price": 3000, "image": "/static/images/cc01.jpg", "categories": ["Car Logo"]},
    {"id": 1002, "name_kh": "Car Charm 02", "price": 3000, "image": "/static/images/cc02.jpg", "categories": ["Car Logo"]},
    {"id": 1003, "name_kh": "Car Charm 03", "price": 3000, "image": "/static/images/cc03.jpg", "categories": ["Car Logo"]},
    {"id": 1004, "name_kh": "Car Charm 04", "price": 3000, "image": "/static/images/cc04.jpg", "categories": ["Car Logo"]},
    {"id": 1005, "name_kh": "Car Charm 05", "price": 3000, "image": "/static/images/cc05.jpg", "categories": ["Car Logo"]},
    {"id": 1006, "name_kh": "Car Charm 06", "price": 3000, "image": "/static/images/cc06.jpg", "categories": ["Car Logo"]},
    {"id": 1007, "name_kh": "Car Charm 07", "price": 3000, "image": "/static/images/cc07.jpg", "categories": ["Car Logo"]}, 
    {"id": 1008, "name_kh": "Car Charm 08", "price": 3000, "image": "/static/images/cc08.jpg", "categories": ["Car Logo"]},
    
        ];

    const categories = Array.from(new Set(allCharms.flatMap(c => c.categories)));
    let selectedCharms = JSON.parse(localStorage.getItem('customCharms')) || [];

    // --- RENDER FUNCTIONS ---

    function init() {
        renderCategories();
        updateUI();
    }

    function renderCategories() {
        const container = document.getElementById('categoryGallery');
        container.innerHTML = categories.map(cat => {
            const charm = allCharms.find(c => c.categories.includes(cat));
            return `
                <div onclick="openDrawer('${cat}')" class="flex flex-col items-center gap-1 active:scale-95 transition-transform cursor-pointer">
                    <div class="w-full aspect-[2/3] bg-white rounded-lg border border-gray-100 shadow-sm overflow-hidden p-1">
                        <img src="${charm.image}" class="w-full h-full object-cover rounded-md">
                    </div>
                    <span class="text-[6px] font-black text-gray-500 uppercase truncate w-full text-center">${cat}</span>
                </div>
            `;
        }).join('');
    }

    function openDrawer(cat) {
        const drawer = document.getElementById('drawer');
        const title = document.getElementById('drawer-title');
        const grid = document.getElementById('charmGrid');
        
        title.innerText = cat;
        grid.innerHTML = allCharms.filter(c => c.categories.includes(cat)).map(c => `
            <div onclick="addCharmById(${c.id})" class="flex flex-col items-center bg-gray-50 rounded-lg p-1 active:bg-orange-50 transition-all cursor-pointer">
                <img src="${c.image}" class="w-full aspect-[2/3.5] object-cover rounded shadow-sm">
                <p class="text-[6px] font-black mt-1 text-gray-400">${c.price}áŸ›</p>
            </div>
        `).join('');

        drawer.classList.remove('translate-y-full');
        drawer.classList.add('pointer-events-auto');
    }

    function closeDrawer() { 
        const drawer = document.getElementById('drawer');
        drawer.classList.add('translate-y-full'); 
        drawer.classList.remove('pointer-events-auto');
    }

    // --- BUILDER ACTIONS ---

    function addCharmById(id) {
        // No limits logic
        const charm = allCharms.find(c => c.id === id);
        selectedCharms.push({ ...charm, uid: Math.random().toString(36).substr(2, 9) });
        updateUI();
    }

    function removeCharm(uid) {
        selectedCharms = selectedCharms.filter(c => c.uid !== uid);
        updateUI();
    }

    function updateUI() {
        const preview = document.getElementById('bracelet-preview');
        const totalDisplay = document.getElementById('total-price');
        const countDisplay = document.getElementById('link-count');
        const addBtn = document.getElementById('add-to-cart-btn');

        localStorage.setItem('customCharms', JSON.stringify(selectedCharms));

        if (selectedCharms.length === 0) {
            preview.innerHTML = `<div class="w-full text-center py-8 opacity-20 uppercase tracking-[0.4em] text-[10px] font-black">Designer Workspace</div>`;
            totalDisplay.innerText = "0áŸ›";
            countDisplay.innerText = "0 LINKS";
            addBtn.disabled = true;
            return;
        }

        let total = 0;
        preview.innerHTML = selectedCharms.map((c, index) => {
            total += c.price;
            return `
                <div class="bracelet-link-container link-pop" 
                     draggable="true" 
                     data-index="${index}"
                     ontouchstart="handleTouchStart(event)"
                     ontouchmove="handleTouchMove(event)"
                     ontouchend="handleTouchEnd(event)"
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                    <img src="${c.image}">
                    <button onclick="removeCharm('${c.uid}')" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full flex items-center justify-center text-[7px] shadow-lg">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `;
        }).join('');

        totalDisplay.innerText = total.toLocaleString() + "áŸ›";
        countDisplay.innerText = `${selectedCharms.length} LINKS`;
        addBtn.disabled = false;
        
        // Auto-scroll to newly added items
        if (selectedCharms.length > 5) {
             preview.scrollTo({ left: preview.scrollWidth, behavior: 'smooth' });
        }
    }

    // --- REORDERING LOGIC ---

    let touchStartIndex = null;
    let currentHoverIndex = null;

    function handleDragStart(e) {
        e.target.classList.add('dragging');
        e.dataTransfer.setData('text/plain', e.target.dataset.index);
    }

    function handleDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('.bracelet-link-container');
        if (target) target.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        const target = e.target.closest('.bracelet-link-container');
        if (target) target.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        const target = e.target.closest('.bracelet-link-container');
        if (!target) return;
        target.classList.remove('drag-over');
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        const to = parseInt(target.dataset.index);
        reorderArray(from, to);
    }

    function handleTouchStart(e) {
        const container = e.target.closest('.bracelet-link-container');
        if (!container) return;
        touchStartIndex = parseInt(container.dataset.index);
        container.classList.add('dragging');
    }

    function handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const container = target?.closest('.bracelet-link-container');
        document.querySelectorAll('.bracelet-link-container').forEach(el => el.classList.remove('drag-over'));
        if (container) {
            currentHoverIndex = parseInt(container.dataset.index);
            container.classList.add('drag-over');
        }
    }

    function handleTouchEnd(e) {
        document.querySelectorAll('.bracelet-link-container').forEach(el => {
            el.classList.remove('dragging');
            el.classList.remove('drag-over');
        });
        if (touchStartIndex !== null && currentHoverIndex !== null && touchStartIndex !== currentHoverIndex) {
            reorderArray(touchStartIndex, currentHoverIndex);
        }
        touchStartIndex = null;
        currentHoverIndex = null;
    }

    function reorderArray(from, to) {
        const item = selectedCharms.splice(from, 1)[0];
        selectedCharms.splice(to, 0, item);
        updateUI();
    }

    function clearBracelet() {
        if (confirm("Reset current design?")) { selectedCharms = []; updateUI(); }
    }

    function addRandom() {
        const rand = allCharms[Math.floor(Math.random() * allCharms.length)];
        if(rand) addCharmById(rand.id);
    }

    function handleAddToCart() {
        const total = selectedCharms.reduce((s, c) => s + c.price, 0);
        const formData = new FormData();
        formData.append('custom_name', `Custom Italy Bracelet (${selectedCharms.length} links)`);
        formData.append('price', total);

        fetch('/add-to-cart', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(() => {
            alert("Design added to cart!");
            selectedCharms = [];
            localStorage.removeItem('customCharms');
            window.location.href = "/";
        });
    }

    init();
  </script>
</body>
</html>

