<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- CRITICAL FIX: Add viewport meta tag for responsive mobile design -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Customize Your Italy Bracelet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Use Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #007bff;
      --accent-color: #ff9800;
      --danger-color: #ff4c4c;
      --success-color: #28a745;
      --background-light: #fafafa;
      --text-dark: #333;
      --shadow-soft: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { 
        font-family: 'Inter', sans-serif; 
        background: var(--background-light); 
        margin: 0; 
        padding: 0; 
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }
    /* Utility class for primary buttons */
    .btn-primary { 
        background: var(--primary-color); 
        color: white; 
        padding: 10px 18px; 
        border-radius: 8px; 
        text-decoration: none; 
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
    }
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }
    .header { position: sticky; top: 0; background: white; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 1000; width: 100%; box-sizing: border-box; }
    .back-home { margin-right: auto; }
    h2.title { margin-top: 20px; color: var(--text-dark); font-weight: 700; }

    .preview-box { 
        position: sticky; 
        top: 60px; 
        background: #fff; 
        border: 1px solid #ddd; 
        border-radius: 16px; 
        margin: 20px auto; 
        padding: 20px; 
        width: 95%; 
        max-width: 900px; 
        box-shadow: var(--shadow-soft);
        box-sizing: border-box;
    }
    .preview-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .cancel-btn { 
        background: var(--danger-color); 
        color:white; 
        border:none; 
        padding:8px 16px; 
        border-radius:6px; 
        font-weight:bold; 
        cursor:pointer;
        transition: 0.2s;
    }
    .cancel-btn:hover { background:#cc0000; }
    
    /* Bracelet Preview Container */
    #bracelet-preview { 
        display:flex; 
        justify-content:flex-start; 
        align-items:flex-start; 
        overflow-x:auto; 
        gap:5px; 
        padding:10px 0; 
        min-height:160px; 
        border-bottom: 1px solid #eee;
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: var(--accent-color) #f0f0f0; /* Firefox */
    }
    #bracelet-preview::-webkit-scrollbar {
        height: 8px;
    }
    #bracelet-preview::-webkit-scrollbar-thumb {
        background-color: var(--accent-color);
        border-radius: 10px;
    }

    .bracelet-charm { 
        position:relative; 
        flex-shrink: 0; /* Important for horizontal scrolling */
    }
    .remove-btn { 
        position:absolute; top:-15px; left:50%; transform:translateX(-50%); 
        background:var(--danger-color); color:white; border:2px solid white; 
        border-radius:50%; font-size:14px; width:30px; height:30px; line-height:30px;
        cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.3); transition:0.2s; 
        display:flex; justify-content:center; align-items:center;
    }
    .remove-btn:hover { background:#cc0000; transform:translateX(-50%) scale(1.1); }
    .bracelet-charm img { 
        width:90px; height:150px; object-fit:cover; border-radius: 4px; 
        border: 1px solid #ccc;
    }
    .controls { display:flex; justify-content: space-between; gap:2px; margin-top:5px; }
    .move-left, .move-right { 
        flex-grow: 1;
        border:none; background:rgba(0,0,0,0.6); color:white; 
        border-radius:4px; font-size:12px; padding:4px 6px; cursor:pointer; 
    }
    .move-left:active, .move-right:active { background:rgba(0,0,0,0.8); }

    .total-box { margin-top:20px; text-align:center; }
    .total-box p { font-size:24px; font-weight:700; margin:5px 0; color: var(--primary-color); }
    .action-buttons { display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin-top:15px; }
    .screenshot-btn { background:var(--success-color); }
    .add-recommended-btn { background:var(--accent-color); }
    .screenshot-btn:hover { background: #1e7e34; }
    .add-recommended-btn:hover { background:#e68900; }
    
    /* Category grid */
    .category-gallery { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* slightly smaller for mobile fit */
        gap:20px; 
        padding:20px;
        max-width: 900px; 
        width: 95%; 
        margin:0 auto 40px auto; 
        box-sizing: border-box;
    }
    .category-item { 
        background:white; 
        border:1px solid #ddd; 
        border-radius:12px; 
        padding: 15px 10px;
        cursor:pointer; 
        transition: background 0.2s, box-shadow 0.2s; 
        text-align:center; 
        font-size: 1rem; 
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .category-item:hover { 
        background: #f0f8ff; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .category-item img { width:80px; height:130px; object-fit:cover; border-radius:6px; }

    /* Modal - Slide up from bottom */
    .modal { 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background: rgba(0,0,0,0.6); 
        display:none; 
        justify-content:center; 
        align-items:flex-end; 
        z-index:10000; 
    }
    .modal-content { 
        background:white; 
        padding:20px; 
        border-radius:15px 15px 0 0; 
        width: 100%; 
        max-height: 80vh; /* Increased max height for larger screen content */
        overflow-y: auto; 
        text-align:center; 
        box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
    }
    
    .charm-grid { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive grid for charms */
        gap: 15px; 
        padding: 10px 0;
    }
    
    .recommended-item { 
        background:var(--background-light); 
        border:1px solid #ddd; 
        border-radius:10px; 
        padding:10px; 
        cursor:pointer; 
        transition:0.2s; 
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .recommended-item:hover { border-color:var(--primary-color); background: #eef7ff; }

    .recommended-item img { 
        width: 80px; /* Slightly larger images in modal for easier viewing */
        height: 120px; 
        object-fit:cover; 
        border-radius:8px; 
    }
    
    .close-modal-btn { 
        background:var(--danger-color); 
        color:white; 
        border:none; 
        padding:8px 14px; 
        border-radius:4px; 
        cursor:pointer; 
        
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10001; 
    }

    /* --- Custom Confirmation Dialog Styling (MANDATORY FIX) --- */
    .custom-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 20000;
        align-items: center;
        justify-content: center;
    }
    .custom-dialog-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 90%;
        width: 350px;
        text-align: center;
        box-shadow: var(--shadow-soft);
    }
    .custom-dialog-content h4 {
        margin-top: 0;
        color: var(--danger-color);
    }
    .dialog-buttons {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        margin-top: 20px;
    }
    .dialog-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }
    #dialogConfirm {
        background: var(--danger-color);
        color: white;
    }
    #dialogCancel {
        background: #ccc;
        color: var(--text-dark);
    }
    #dialogConfirm:hover { background: #cc0000; }
    #dialogCancel:hover { background: #bbb; }

    /* Placeholder style for broken images */
    .placeholder-charm {
        background-color: #f5f5f5 !important;
        border: 1px dashed #ccc !important;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 10px;
        text-align: center;
        line-height: 1.2;
    }
</style>
</head>
<body>

  <div class="header">
    <a href="/" class="back-home btn-primary">üè† Back to Home</a>
    <h3>Customize Your Bracelet</h3>
  </div>

  <div class="preview-box" id="previewBox">
    <div class="preview-header">
      <h3>ü™Ñ Preview Bracelet</h3>
      <button id="cancelSelection" class="cancel-btn">‚ùå Cancel Selection</button>
    </div>

    <div id="bracelet-preview">Your charms will appear here...</div>

    <div class="total-box">
      <p>Total: <span id="totalPrice">0·üõ</span></p>
      <div class="action-buttons">
        <button class="screenshot-btn btn-primary" id="screenshotBtn">üì∏ Take Screenshot</button>
        <button class="add-recommended-btn btn-primary" id="recommendedBtn">‚ú® Add Recommended Charm</button>
      </div>
    </div>
  </div>

  <h2 class="title">ü™Ñ Choose a Category ü™Ñ</h2>
  <div id="categoryGallery" class="category-gallery"></div>

  <!-- Charm Selection Modal -->
  <div id="charmModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <div id="charmGrid" class="charm-grid"></div>
      <button id="closeModalBtn" class="close-modal-btn">Close</button>
    </div>
  </div>
  
  <!-- Custom Confirmation Dialog (Replaces Forbidden confirm()) -->
  <div id="customDialog" class="custom-dialog">
    <div class="custom-dialog-content">
      <h4>Confirm Action</h4>
      <p id="dialogMessage">Are you sure you want to cancel your bracelet design? This action cannot be undone.</p>
      <div class="dialog-buttons">
        <button id="dialogConfirm">Yes, Cancel</button>
        <button id="dialogCancel">Keep Editing</button>
      </div>
    </div>
  </div>

  <script>
    // Global placeholder image URL for failed loads
    const placeholderImageUrl = "https://placehold.co/90x150/f5f5f5/999?text=Charm";

    // DOM refs
    const preview = document.getElementById('bracelet-preview');
    const totalPrice = document.getElementById('totalPrice');
    const categoryGallery = document.getElementById('categoryGallery');
    const charmModal = document.getElementById('charmModal');
    const charmGrid = document.getElementById('charmGrid');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const screenshotBtn = document.getElementById('screenshotBtn');
    const recommendedBtn = document.getElementById('recommendedBtn');
    const cancelSelectionBtn = document.getElementById('cancelSelection');
    
    // Dialog refs
    const customDialog = document.getElementById('customDialog');
    const dialogMessage = document.getElementById('dialogMessage');
    const dialogConfirm = document.getElementById('dialogConfirm');
    const dialogCancel = document.getElementById('dialogCancel');


    let charms = []; // current preview charms

    // Charm data (same as user provided)
    const allCharms = [
      // --- Charm
    {"id": 1, "name_kh": "Silver Charm", "price": 400, "image": "/static/images/c01.jpg", "categories": ["Charm"]},
    // --- CAR LOGOS (cc01 - cc15) ---
    {"id": 12301, "name_kh": "Car Charm 01", "price": 3000, "image": "/static/images/cc01.jpg", "categories": ["Car Logo"]},
    {"id": 12302, "name_kh": "Car Charm 02", "price": 3000, "image": "/static/images/cc02.jpg", "categories": ["Car Logo"]},
    {"id": 12303, "name_kh": "Car Charm 03", "price": 3000, "image": "/static/images/cc03.jpg", "categories": ["Car Logo"]},
    {"id": 12304, "name_kh": "Car Charm 04", "price": 3000, "image": "/static/images/cc04.jpg", "categories": ["Car Logo"]},
    {"id": 12305, "name_kh": "Car Charm 05", "price": 3000, "image": "/static/images/cc05.jpg", "categories": ["Car Logo"]},
    {"id": 12306, "name_kh": "Car Charm 06", "price": 3000, "image": "/static/images/cc06.jpg", "categories": ["Car Logo"]},
    {"id": 12307, "name_kh": "Car Charm 07", "price": 3000, "image": "/static/images/cc07.jpg", "categories": ["Car Logo"]},
    {"id": 12308, "name_kh": "Car Charm 08", "price": 3000, "image": "/static/images/cc08.jpg", "categories": ["Car Logo"]},
    {"id": 12309, "name_kh": "Car Charm 09", "price": 3000, "image": "/static/images/cc09.jpg", "categories": ["Car Logo"]},
    {"id": 12310, "name_kh": "Car Charm 10", "price": 3000, "image": "/static/images/cc10.jpg", "categories": ["Car Logo"]},
    {"id": 12311, "name_kh": "Car Charm 11", "price": 3000, "image": "/static/images/cc11.jpg", "categories": ["Car Logo"]},
    {"id": 12312, "name_kh": "Car Charm 12", "price": 3000, "image": "/static/images/cc12.jpg", "categories": ["Car Logo"]},
    {"id": 12313, "name_kh": "Car Charm 13", "price": 3000, "image": "/static/images/cc13.jpg", "categories": ["Car Logo"]},
    {"id": 12314, "name_kh": "Car Charm 14", "price": 3000, "image": "/static/images/cc14.jpg", "categories": ["Car Logo"]},
    {"id": 12315, "name_kh": "Car Charm 15", "price": 3000, "image": "/static/images/cc15.jpg", "categories": ["Car Logo"]},

    // --- FLAGS (cf01 - cf19) ---
    {"id": 1234501, "name_kh": "Flag Charm 01", "price": 3000, "image": "/static/images/cf01.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234502, "name_kh": "Flag Charm 02", "price": 3000, "image": "/static/images/cf02.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234503, "name_kh": "Flag Charm 03", "price": 3000, "image": "/static/images/cf03.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234504, "name_kh": "Flag Charm 04", "price": 3000, "image": "/static/images/cf04.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234505, "name_kh": "Flag Charm 05", "price": 3000, "image": "/static/images/cf05.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234506, "name_kh": "Flag Charm 06", "price": 3000, "image": "/static/images/cf06.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234507, "name_kh": "Flag Charm 07", "price": 3000, "image": "/static/images/cf07.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234508, "name_kh": "Flag Charm 08", "price": 3000, "image": "/static/images/cf08.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234509, "name_kh": "Flag Charm 09", "price": 3000, "image": "/static/images/cf09.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234510, "name_kh": "Flag Charm 10", "price": 3000, "image": "/static/images/cf10.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234511, "name_kh": "Flag Charm 11", "price": 3000, "image": "/static/images/cf11.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234512, "name_kh": "Flag Charm 12", "price": 3000, "image": "/static/images/cf12.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234513, "name_kh": "Flag Charm 13", "price": 3000, "image": "/static/images/cf13.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234514, "name_kh": "Flag Charm 14", "price": 3000, "image": "/static/images/cf14.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234515, "name_kh": "Flag Charm 15", "price": 3000, "image": "/static/images/cf15.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234516, "name_kh": "Flag Charm 16", "price": 3000, "image": "/static/images/cf16.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234517, "name_kh": "Flag Charm 17", "price": 3000, "image": "/static/images/cf17.jpg", "categories": ["Flag"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234518, "name_kh": "Flag Charm 18", "price": 3000, "image": "/static/images/cf18.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234519, "name_kh": "Flag Charm 19", "price": 3000, "image": "/static/images/cf19.jpg", "categories": ["Flag"], "subcategory": ["All","Football"], "discount": 20},

    // --- GEMSTONES (cg01 - cg24) ---
    {"id": 123501, "name_kh": "Gemstone Charm 01", "price": 3500, "image": "/static/images/cg01.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123502, "name_kh": "Gemstone Charm 02", "price": 3500, "image": "/static/images/cg02.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123503, "name_kh": "Gemstone Charm 03", "price": 3500, "image": "/static/images/cg03.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123504, "name_kh": "Gemstone Charm 04", "price": 3500, "image": "/static/images/cg04.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123505, "name_kh": "Gemstone Charm 05", "price": 3500, "image": "/static/images/cg05.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123506, "name_kh": "Gemstone Charm 06", "price": 3500, "image": "/static/images/cg06.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123507, "name_kh": "Gemstone Charm 07", "price": 3500, "image": "/static/images/cg07.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123508, "name_kh": "Gemstone Charm 08", "price": 3500, "image": "/static/images/cg08.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123509, "name_kh": "Gemstone Charm 09", "price": 3500, "image": "/static/images/cg09.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123510, "name_kh": "Gemstone Charm 10", "price": 3500, "image": "/static/images/cg10.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123511, "name_kh": "Gemstone Charm 11", "price": 3500, "image": "/static/images/cg11.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123512, "name_kh": "Gemstone Charm 12", "price": 3500, "image": "/static/images/cg12.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123513, "name_kh": "Gemstone Charm 13", "price": 3500, "image": "/static/images/cg13.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123514, "name_kh": "Gemstone Charm 14", "price": 3500, "image": "/static/images/cg14.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123515, "name_kh": "Gemstone Charm 15", "price": 3500, "image": "/static/images/cg15.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123516, "name_kh": "Gemstone Charm 16", "price": 3500, "image": "/static/images/cg16.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123517, "name_kh": "Gemstone Charm 17", "price": 3500, "image": "/static/images/cg17.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123518, "name_kh": "Gemstone Charm 18", "price": 3500, "image": "/static/images/cg18.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123519, "name_kh": "Gemstone Charm 19", "price": 3500, "image": "/static/images/cg19.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123520, "name_kh": "Gemstone Charm 20", "price": 3500, "image": "/static/images/cg20.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123521, "name_kh": "Gemstone Charm 21", "price": 5000, "image": "/static/images/cg21.jpg", "categories": ["Gemstone"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123522, "name_kh": "Gemstone Charm 22", "price": 5000, "image": "/static/images/cg22.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123523, "name_kh": "Gemstone Charm 23", "price": 5000, "image": "/static/images/cg23.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123524, "name_kh": "Gemstone Charm 24", "price": 5000, "image": "/static/images/cg24.jpg", "categories": ["Gemstone"], "subcategory": ["All","Football"], "discount": 20},
        // --- Black Lover 
    {"id": 101, "name_kh": "Chain ", "price": 3000, "image": "/static/images/charm-chain-01.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 102, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-02.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 103, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-03.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 104, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-04.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 105, "name_kh": "Chain ", "price": 3000, "image": "/static/images/charm-chain-05.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 106, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-06.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 107, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-07.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 108, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-08.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 101, "name_kh": "Chain ", "price": 3000, "image": "/static/images/charm-chain-09.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 109, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-10.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 110, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-11.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 111, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-12.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 112, "name_kh": "Chain ", "price": 3000, "image": "/static/images/charm-chain-13.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 113, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-14.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 114, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-15.jpg", "categories": ["Chain"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 115, "name_kh": "Chain", "price": 3000, "image": "/static/images/charm-chain-16.jpg", "categories": ["Chain"], "subcategory": ["Flag","Football"], "discount": 20},

        // --- Football Club 
    {"id": 123, "name_kh": "Barcelona", "price": 3000, "image": "/static/images/cs01.jpg", "categories": ["Football Club Logo"]},
  
        // --- Black Lover 
    {"id": 1001, "name_kh": "Black ", "price": 3000, "image": "/static/images/cb01.jpg", "categories": ["Black Lover"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1002, "name_kh": "Black", "price": 3000, "image": "/static/images/cb02.jpg", "categories": ["Black Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1003, "name_kh": "Black", "price": 3000, "image": "/static/images/cb03.jpg", "categories": ["Black Lover"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1004, "name_kh": "Black", "price": 3000, "image": "/static/images/cb04.jpg", "categories": ["Black Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1005, "name_kh": "Black", "price": 3000, "image": "/static/images/cb05.jpg", "categories": ["Black Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1006, "name_kh": "Black", "price": 3000, "image": "/static/images/cb06.jpg", "categories": ["Black Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1007, "name_kh": "Black", "price": 3000, "image": "/static/images/cb07.jpg", "categories": ["Black Lover"], "subcategory": ["Flag","Football"], "discount": 20},
        // --- Dog&Cat Lover 
    {"id": 10010, "name_kh": "Cat&Dog ", "price": 3000, "image": "/static/images/charm-animal-01.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 10020, "name_kh": "Cat&Dog", "price": 3000, "image": "/static/images/charm-animal-02.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 10030, "name_kh": "Cat&Dog", "price": 3000, "image": "/static/images/charm-animal-03.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 10040, "name_kh": "Cat&Dog", "price": 3000, "image": "/static/images/charm-animal-04.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 10050, "name_kh": "Cat&Dog", "price": 3000, "image": "/static/images/charm-animal-05.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 10060, "name_kh": "Cat&Dog", "price": 3000, "image": "/static/images/charm-animal-06.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 10070, "name_kh": "Cat&Dog", "price": 3000, "image": "/static/images/charm-animal-07.jpg", "categories": ["Dog&Cat Lover"], "subcategory": ["Flag","Football"], "discount": 20},

                // --- Pink Lover 
    {"id": 2001, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp01.jpg", "categories": ["Pink Lover"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 2002, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp02.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 2003, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp03.jpg", "categories": ["Pink Lover"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 2004, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp04.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 2005, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp05.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 2006, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp06.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 2007, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp07.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 2008, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp08.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 2009, "name_kh": "Pink", "price": 3000, "image": "/static/images/cp09.jpg", "categories": ["Pink Lover"], "subcategory": ["Flag","Football"], "discount": 20},
 
      // --- LETTERS (a - z) ---
    {"id": 1234501, "name_kh": "Pink Letter Charm A", "price": 1200, "image": "/static/images/ap.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234502, "name_kh": "Pink Letter Charm B", "price": 1200, "image": "/static/images/bp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234503, "name_kh": "Pink Letter Charm C", "price": 1200, "image": "/static/images/cp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234504, "name_kh": "Pink Letter Charm D", "price": 1200, "image": "/static/images/dp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234505, "name_kh": "Pink Letter Charm E", "price": 1200, "image": "/static/images/ep.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234506, "name_kh": "Pink Letter Charm F", "price": 1200, "image": "/static/images/fp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234507, "name_kh": "Pink Letter Charm G", "price": 1200, "image": "/static/images/gp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234508, "name_kh": "Pink Letter Charm H", "price": 1200, "image": "/static/images/hp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234509, "name_kh": "Pink Letter Charm I", "price": 1200, "image": "/static/images/ip.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234510, "name_kh": "Pink Letter Charm J", "price": 1200, "image": "/static/images/jp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234511, "name_kh": "Pink Letter Charm K", "price": 1200, "image": "/static/images/kp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234512, "name_kh": "Pink Letter Charm L", "price": 1200, "image": "/static/images/lp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234513, "name_kh": "Pink Letter Charm M", "price": 1200, "image": "/static/images/mp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234514, "name_kh": "Pink Letter Charm N", "price": 1200, "image": "/static/images/np.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234515, "name_kh": "Pink Letter Charm O", "price": 1200, "image": "/static/images/op.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234516, "name_kh": "Pink Letter Charm P", "price": 1200, "image": "/static/images/pp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234517, "name_kh": "Pink Letter Charm Q", "price": 1200, "image": "/static/images/qp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234518, "name_kh": "Pink Letter Charm R", "price": 1200, "image": "/static/images/rp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234519, "name_kh": "Pink Letter Charm S", "price": 1200, "image": "/static/images/sp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234520, "name_kh": "Pink Letter Charm T", "price": 1200, "image": "/static/images/tp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234521, "name_kh": "Pink Letter Charm U", "price": 1200, "image": "/static/images/up.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234522, "name_kh": "Pink Letter Charm V", "price": 1200, "image": "/static/images/vp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234523, "name_kh": "Pink Letter Charm W", "price": 1200, "image": "/static/images/wp.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234524, "name_kh": "Pink Letter Charm X", "price": 1200, "image": "/static/images/x.jpg", "categories": ["Pink Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 1234525, "name_kh": "Pink Letter Charm Y", "price": 1200, "image": "/static/images/yp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 1234526, "name_kh": "Pink Letter Charm Z", "price": 1200, "image": "/static/images/zp.jpg", "categories": ["Pink Letter"], "subcategory": ["All","Football"], "discount": 20},

    // --- LETTERS (a - z) ---
    {"id": 234501, "name_kh": "Letter Charm A", "price": 1200, "image": "/static/images/a.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234502, "name_kh": "Letter Charm B", "price": 1200, "image": "/static/images/b.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234503, "name_kh": "Letter Charm C", "price": 1200, "image": "/static/images/c.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234504, "name_kh": "Letter Charm D", "price": 1200, "image": "/static/images/d.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234505, "name_kh": "Letter Charm E", "price": 1200, "image": "/static/images/e.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234506, "name_kh": "Letter Charm F", "price": 1200, "image": "/static/images/f.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234507, "name_kh": "Letter Charm G", "price": 1200, "image": "/static/images/g.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234508, "name_kh": "Letter Charm H", "price": 1200, "image": "/static/images/h.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234509, "name_kh": "Letter Charm I", "price": 1200, "image": "/static/images/i.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234510, "name_kh": "Letter Charm J", "price": 1200, "image": "/static/images/j.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234511, "name_kh": "Letter Charm K", "price": 1200, "image": "/static/images/k.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234512, "name_kh": "Letter Charm L", "price": 1200, "image": "/static/images/l.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234513, "name_kh": "Letter Charm M", "price": 1200, "image": "/static/images/m.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234514, "name_kh": "Letter Charm N", "price": 1200, "image": "/static/images/n.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234515, "name_kh": "Letter Charm O", "price": 1200, "image": "/static/images/o.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234516, "name_kh": "Letter Charm P", "price": 1200, "image": "/static/images/p.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234517, "name_kh": "Letter Charm Q", "price": 1200, "image": "/static/images/q.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234518, "name_kh": "Letter Charm R", "price": 1200, "image": "/static/images/r.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234519, "name_kh": "Letter Charm S", "price": 1200, "image": "/static/images/s.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234520, "name_kh": "Letter Charm T", "price": 1200, "image": "/static/images/t.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234521, "name_kh": "Letter Charm U", "price": 1200, "image": "/static/images/u.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234522, "name_kh": "Letter Charm V", "price": 1200, "image": "/static/images/v.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234523, "name_kh": "Letter Charm W", "price": 1200, "image": "/static/images/w.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234524, "name_kh": "Letter Charm X", "price": 1200, "image": "/static/images/x.jpg", "categories": ["Letter"], "subcategory": ["Flag","Football"], "discount": 20},
    {"id": 234525, "name_kh": "Letter Charm Y", "price": 1200, "image": "/static/images/y.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 234526, "name_kh": "Letter Charm Z", "price": 1200, "image": "/static/images/z.jpg", "categories": ["Letter"], "subcategory": ["All","Football"], "discount": 20},

    // --- STEAV (cm01 - cm13) ---
    {"id": 123601, "name_kh": "Steav Charm 01", "price": 3000, "image": "/static/images/cm01.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123602, "name_kh": "Steav Charm 02", "price": 3000, "image": "/static/images/cm02.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123603, "name_kh": "Steav Charm 03", "price": 3000, "image": "/static/images/cm03.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123604, "name_kh": "Steav Charm 04", "price": 3000, "image": "/static/images/cm04.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123605, "name_kh": "Steav Charm 05", "price": 3000, "image": "/static/images/cm05.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123606, "name_kh": "Steav Charm 06", "price": 3000, "image": "/static/images/cm06.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123607, "name_kh": "Steav Charm 07", "price": 3000, "image": "/static/images/cm07.jpg", "categories": ["Steav"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123608, "name_kh": "Steav Charm 08", "price": 3000, "image": "/static/images/cm08.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123609, "name_kh": "Steav Charm 09", "price": 3000, "image": "/static/images/cm09.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123610, "name_kh": "Steav Charm 10", "price": 3000, "image": "/static/images/cm10.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123611, "name_kh": "Steav Charm 11", "price": 3000, "image": "/static/images/cm11.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123612, "name_kh": "Steav Charm 12", "price": 3000, "image": "/static/images/cm12.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123613, "name_kh": "Steav Charm 13", "price": 4000, "image": "/static/images/cm13.jpg", "categories": ["Steav"], "subcategory": ["All","Football"], "discount": 20},
    // --- Cartoon 
    {"id": 101, "name_kh": "Cartoon", "price": 3000, "image": "/static/images/ct01.jpg", "categories": ["Cartoon"]},

    // --- CUTIE (cw01 - cw16) ---
    {"id": 123701, "name_kh": "Cutie Charm 01", "price": 3000, "image": "/static/images/cw01.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123702, "name_kh": "Cutie Charm 02", "price": 3000, "image": "/static/images/cw02.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123703, "name_kh": "Cutie Charm 03", "price": 3000, "image": "/static/images/cw03.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123704, "name_kh": "Cutie Charm 04", "price": 3000, "image": "/static/images/cw04.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123705, "name_kh": "Cutie Charm 05", "price": 3000, "image": "/static/images/cw05.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123706, "name_kh": "Cutie Charm 06", "price": 4000, "image": "/static/images/cw06.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123707, "name_kh": "Cutie Charm 07", "price": 4000, "image": "/static/images/cw07.jpg", "categories": ["Cutie"], "subcategory": ["Car Logo"], "discount": 20},
    {"id": 123708, "name_kh": "Cutie Charm 08", "price": 4000, "image": "/static/images/cw08.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123709, "name_kh": "Cutie Charm 09", "price": 4000, "image": "/static/images/cw09.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123710, "name_kh": "Cutie Charm 10", "price": 4000, "image": "/static/images/cw10.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123711, "name_kh": "Cutie Charm 11", "price": 4000, "image": "/static/images/cw11.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123712, "name_kh": "Cutie Charm 12", "price": 4000, "image": "/static/images/cw12.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123713, "name_kh": "Cutie Charm 13", "price": 4000, "image": "/static/images/cw13.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123714, "name_kh": "Cutie Charm 14", "price": 4000, "image": "/static/images/cw14.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123715, "name_kh": "Cutie Charm 15", "price": 4000, "image": "/static/images/cw15.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20},
    {"id": 123716, "name_kh": "Cutie Charm 16", "price": 4000, "image": "/static/images/cw16.jpg", "categories": ["Cutie"], "subcategory": ["All","Football"], "discount": 20}
];
    // Build unique categories (order preserved by first appearance)
    const categories = Array.from(allCharms.reduce((s, ch) => {
      ch.categories.forEach(cat => { if (!s.has(cat)) s.add(cat); });
      return s;
    }, new Set()));

    // Render category tiles
    function renderCategoriesImpl() {
      categoryGallery.innerHTML = '';
      categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.tabIndex = 0;
        item.dataset.category = cat;

        const imgSrc = getCategoryImage(cat);
        // FIX: Added onerror for category images
        item.innerHTML = `
            <img src="${imgSrc}" alt="${escapeHtml(cat)}" onerror="this.onerror=null; this.src='${placeholderImageUrl}'; this.classList.add('placeholder-charm');">
            <p>${escapeHtml(cat)}</p>
        `;
        item.addEventListener('click', () => openCharmModal(cat));
        item.addEventListener('keydown', (e) => { if (e.key === 'Enter') openCharmModal(cat); });

        categoryGallery.appendChild(item);
      });
    }

    // Get an image for a category (first charm image in that category)
    function getCategoryImage(cat) {
      const found = allCharms.find(c => c.categories.includes(cat));
      return found ? found.image : placeholderImageUrl;
    }

    // Open modal and populate charms for the chosen category
    function openCharmModal(category) {
      modalTitle.textContent = `‚ú® ${category} Charms ‚ú®`;
      charmGrid.innerHTML = '';

      const charmsInCategory = allCharms.filter(ch => ch.categories.includes(category));
      if (charmsInCategory.length === 0) {
        charmGrid.innerHTML = `<p>No charms in this category.</p>`;
      } else {
        charmsInCategory.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'recommended-item';
          div.dataset.image = ch.image;
          div.dataset.name = ch.name_kh;
          div.dataset.price = ch.price;
          div.innerHTML = `
            <img src="${ch.image}" alt="${escapeHtml(ch.name_kh)}" onerror="this.onerror=null; this.src='${placeholderImageUrl}'; this.classList.add('placeholder-charm');">
            <p>${escapeHtml(ch.name_kh)}</p>
            <p><strong>${Number(ch.price).toLocaleString()}·üõ</strong></p>
          `;
          div.addEventListener('click', () => {
            addCharm(ch.image, ch.name_kh, ch.price);
            // Modal stays open for continuous selection
          });
          charmGrid.appendChild(div);
        });
      }

      charmModal.style.display = 'flex';
      charmModal.setAttribute('aria-hidden','false');
    }

    function closeCharmModal() {
      charmModal.style.display = 'none';
      charmModal.setAttribute('aria-hidden','true');
    }

    // Renders the bracelet preview and total price
    function renderBracelet() {
      preview.innerHTML = '';
      if (charms.length === 0) {
        preview.textContent = 'Your charms will appear here...';
        totalPrice.textContent = '0·üõ';
        return;
      }

      let total = 0;
      charms.forEach((charm, idx) => {
        total += Number(charm.price);
        const div = document.createElement('div');
        div.className = 'bracelet-charm';
        div.innerHTML = `
          <button class="remove-btn" data-index="${idx}" title="Remove">‚úñ</button>
          <!-- FIX: Added onerror for individual charm images -->
          <img src="${charm.image}" alt="${escapeHtml(charm.name)}" onerror="this.onerror=null; this.src='${placeholderImageUrl}'; this.classList.add('placeholder-charm');">
          <div class="controls">
            <button class="move-left" data-index="${idx}" title="Move left">‚¨ÖÔ∏è</button>
            <button class="move-right" data-index="${idx}" title="Move right">‚û°Ô∏è</button>
          </div>
        `;
        preview.appendChild(div);
      });

      totalPrice.textContent = total.toLocaleString() + '·üõ';
    }

    // Add / remove / move functions remain the same
    function addCharm(image, name, price) {
      charms.push({ image, name, price: Number(price) });
      renderBracelet();
      // Scroll to the newest item
      preview.scrollLeft = preview.scrollWidth; 
    }

    function removeCharm(index) {
      charms.splice(index, 1);
      renderBracelet();
    }

    function moveLeft(index) {
      if (index > 0) {
        [charms[index-1], charms[index]] = [charms[index], charms[index-1]];
        renderBracelet();
      }
    }

    function moveRight(index) {
      if (index < charms.length - 1) {
        [charms[index+1], charms[index]] = [charms[index], charms[index+1]];
        renderBracelet();
      }
    }

    // --- Custom Dialog Implementation ---

    // Function to show the custom dialog and handle confirmation
    function showConfirmDialog(message, onConfirm) {
      dialogMessage.textContent = message;
      customDialog.style.display = 'flex';

      const handleConfirm = () => {
        onConfirm();
        customDialog.style.display = 'none';
        cleanupListeners();
      };

      const handleCancel = () => {
        customDialog.style.display = 'none';
        cleanupListeners();
      };
      
      const handleOutsideClick = (e) => {
        if (e.target === customDialog) {
            handleCancel();
        }
      }

      dialogConfirm.addEventListener('click', handleConfirm);
      dialogCancel.addEventListener('click', handleCancel);
      customDialog.addEventListener('click', handleOutsideClick);

      const cleanupListeners = () => {
        dialogConfirm.removeEventListener('click', handleConfirm);
        dialogCancel.removeEventListener('click', handleCancel);
        customDialog.removeEventListener('click', handleOutsideClick);
      };
    }


    // Replace the forbidden window.confirm with the custom dialog
    cancelSelectionBtn.addEventListener('click', () => {
      showConfirmDialog('Are you sure you want to cancel your bracelet design? All added charms will be removed.', () => {
        charms = [];
        renderBracelet();
      });
    });

    // screenshot
    screenshotBtn.addEventListener('click', () => {
      const element = document.getElementById('previewBox');
      html2canvas(element, { useCORS: true }).then(canvas => { // Added useCORS to potentially handle image loading issues better
        try {
            const link = document.createElement('a');
            link.download = 'bracelet_design.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        } catch(error) {
            console.error("Screenshot failed:", error);
            // Fallback for screenshot error
            showConfirmDialog("Screenshot failed. This may happen if images are not loaded. Try reloading or using your device's native screenshot.", () => {});
        }
      });
    });

    // recommended (random) charm
    recommendedBtn.addEventListener('click', () => {
      if (allCharms.length === 0) return;
      const random = allCharms[Math.floor(Math.random()*allCharms.length)];
      addCharm(random.image, random.name_kh, random.price);
    });

    // modal close button
    closeModalBtn.addEventListener('click', closeCharmModal);
    // also close modal when clicking outside content
    charmModal.addEventListener('click', (e) => {
      if (e.target === charmModal) closeCharmModal();
    });

    // helper to escape text for safe insertion
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // --- EVENT DELEGATION SETUP (Runs once on load) ---
    preview.addEventListener('click', (e) => {
        const target = e.target;
        // Check if the clicked element is one of the control buttons
        if (target.classList.contains('remove-btn') || 
            target.classList.contains('move-left') || 
            target.classList.contains('move-right')) {
            
            // Get the index from the button's data-index attribute
            const index = Number(target.dataset.index);

            if (target.classList.contains('remove-btn')) {
                removeCharm(index);
            } else if (target.classList.contains('move-left')) {
                moveLeft(index);
            } else if (target.classList.contains('move-right')) {
                moveRight(index);
            }
            e.preventDefault(); 
        }
    });
    // --- END EVENT DELEGATION ---


    // initial render
    renderCategoriesImpl();
    renderBracelet();

    // expose renderCategories so we can call it after updating `allCharms` dynamically
    function renderCategories() { renderCategoriesImpl(); }
  </script>
</body>
</html>

