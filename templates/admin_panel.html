<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .admin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        @media (min-width: 1024px) { .admin-grid { grid-template-columns: repeat(6, 1fr); gap: 12px; } }
        
        .sold-out-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .sold-out-tag { background: #ef4444; color: white; font-weight: 900; font-size: 8px; padding: 4px 8px; border-radius: 6px; transform: rotate(-5deg); box-shadow: 0 4px 10px rgba(239,68,68,0.4); }
        
        /* Invoice Styling */
        #invoice-preview { background: white; padding: 20px; border-radius: 0; width: 100%; max-width: 350px; margin: 0 auto; display: none; }
        .invoice-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
        .invoice-item { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 5px; font-weight: 600; }
        .invoice-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-weight: 900; font-size: 14px; }
    </style>
</head>
<body class="pb-24 text-slate-900">

    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-xl border-b border-slate-200 px-4 py-3 flex justify-between items-center">
        <h1 class="text-sm font-black uppercase italic">Control <span class="text-orange-600">Pro</span></h1>
        <div class="flex gap-2">
            <input type="text" oninput="filterGrid(this.value)" placeholder="Search..." class="bg-slate-100 rounded-lg px-2 py-1 text-[10px] w-24 outline-none font-bold">
            <button onclick="toggleReceipt()" class="relative bg-slate-900 text-white w-8 h-8 rounded-xl flex items-center justify-center">
                <i class="fa-solid fa-receipt text-xs"></i>
                <span id="badge" class="absolute -top-1 -right-1 bg-orange-600 text-white text-[8px] font-black w-4 h-4 rounded-full flex items-center justify-center border-2 border-white">0</span>
            </button>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-3">
        {% for cat, items in grouped.items() %}
        <div class="mb-8">
            <h2 class="text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">{{ cat }}</h2>
            <div class="admin-grid">
                {% for p in items %}
                <div class="bg-white rounded-2xl p-1.5 border border-slate-200 shadow-sm flex flex-col" data-name="{{ p.name|lower }}">
                    <div class="relative w-full aspect-[3/5] overflow-hidden rounded-xl mb-2 bg-slate-50">
                        {% if p.stock <= 0 %}
                        <div class="sold-out-overlay"><span class="sold-out-tag">OUT OF STOCK</span></div>
                        {% endif %}
                        <img src="{{ p.image }}" class="w-full h-full object-cover">
                        <div class="absolute bottom-1 right-1 bg-white/90 px-1.5 py-0.5 rounded-md border border-slate-100 text-[8px] font-black">Qty: {{ p.stock }}</div>
                    </div>
                    <div class="mt-auto flex justify-between items-center bg-slate-50 rounded-lg p-0.5 border mb-1">
                        <button onclick="update({{ p.id }}, -1)" class="w-6 h-6 flex items-center justify-center text-slate-400"><i class="fa-solid fa-minus text-[8px]"></i></button>
                        <span id="val-{{ p.id }}" class="text-[10px] font-black">{{ p.stock }}</span>
                        <button onclick="update({{ p.id }}, 1)" class="w-6 h-6 flex items-center justify-center text-slate-400"><i class="fa-solid fa-plus text-[8px]"></i></button>
                    </div>
                    <button onclick="addSale({{ p.id }}, '{{ p.name }}', {{ p.price }})" class="w-full bg-slate-900 text-white py-1.5 rounded-lg text-[8px] font-black uppercase">+ Invoice</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </main>

    <!-- INVOICE DRAWER -->
    <div id="drawer" class="fixed inset-y-0 right-0 w-full md:w-80 bg-white z-[300] shadow-2xl translate-x-full transition-transform duration-300 flex flex-col border-l border-slate-200">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-black uppercase text-xs">Create Invoice</h3>
            <button onclick="toggleReceipt()"><i class="fa-solid fa-xmark text-slate-400"></i></button>
        </div>
        
        <!-- List of Items -->
        <div id="sale-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        
        <!-- Action Buttons -->
        <div class="p-4 border-t bg-slate-50 space-y-2">
            <div class="flex justify-between mb-2"><span class="text-[10px] font-bold">Total</span><span id="total-val" class="text-lg font-black text-orange-600">0៛</span></div>
            <button onclick="generateInvoiceImage()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black uppercase text-[10px]">1. Generate Image</button>
            <button onclick="confirmSale()" class="w-full bg-orange-600 text-white py-3 rounded-xl font-black uppercase text-[10px]">2. Confirm & Deduct</button>
        </div>
    </div>
    <div id="overlay" onclick="toggleReceipt()" class="fixed inset-0 bg-black/20 hidden z-[250]"></div>

    <!-- Hidden Invoice Template for Screenshot -->
    <div id="invoice-template-container" style="position:fixed; left:-9999px; top:0;">
        <div id="final-invoice" style="width: 300px; background: white; padding: 20px; font-family: sans-serif; color: black;">
            <div style="text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="font-weight: 900; text-transform: uppercase; margin: 0;">Somphea Reak</h2>
                <p style="font-size: 10px; margin: 0;">Official Receipt</p>
            </div>
            <div id="invoice-items"></div>
            <div style="border-top: 2px solid black; margin-top: 15px; padding-top: 10px; display: flex; justify-content: space-between; font-weight: 900;">
                <span>TOTAL</span>
                <span id="invoice-total-display">0៛</span>
            </div>
            <div style="text-align: center; margin-top: 20px; font-size: 8px; color: #666;">Thank you for shopping!</div>
        </div>
    </div>

    <script>
        let sale = [];

        async function update(id, d) {
            const el = document.getElementById('val-'+id);
            let n = Math.max(0, parseInt(el.innerText)+d);
            el.innerText = n;
            await fetch('/admin/api/update-stock', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, amount:n})});
        }

        function toggleReceipt() { 
            document.getElementById('drawer').classList.toggle('translate-x-full'); 
            document.getElementById('overlay').classList.toggle('hidden'); 
        }

        function addSale(id, name, price) {
            const ex = sale.find(i=>i.id===id);
            if(ex) ex.qty++; else sale.push({id, name, price, qty:1});
            renderSale();
        }

        function renderSale() {
            let total = 0;
            document.getElementById('sale-list').innerHTML = sale.map(i => {
                total += i.price * i.qty;
                return `<div class="bg-white p-2 border rounded-xl text-[9px] font-bold flex justify-between"><span>${i.name} (x${i.qty})</span><span>${i.price * i.qty}៛</span></div>`;
            }).join('');
            document.getElementById('total-val').innerText = total.toLocaleString() + "៛";
            document.getElementById('badge').innerText = sale.length;
        }

        function generateInvoiceImage() {
            if(sale.length === 0) return alert("Empty invoice!");
            
            // 1. Fill the hidden template
            const container = document.getElementById('invoice-items');
            let total = 0;
            container.innerHTML = sale.map(i => {
                total += i.price * i.qty;
                return `<div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:5px;"><span>${i.name} x${i.qty}</span><span>${i.price*i.qty}៛</span></div>`;
            }).join('');
            document.getElementById('invoice-total-display').innerText = total.toLocaleString() + "៛";

            // 2. Snap it
            html2canvas(document.getElementById('final-invoice')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Invoice-' + Date.now() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        async function confirmSale() {
            if(!sale.length) return;
            if(!confirm("Deduct items from stock?")) return;
            await fetch('/admin/api/process-receipt', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({items:sale})});
            sale = []; renderSale(); toggleReceipt(); alert("Stock Updated!"); location.reload();
        }

        function filterGrid(q) { 
            document.querySelectorAll('[data-name]').forEach(e => e.style.display = e.dataset.name.includes(q.toLowerCase()) ? 'flex' : 'none'); 
        }
    </script>
</body>
</html>


