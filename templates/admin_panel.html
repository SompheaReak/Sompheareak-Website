<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap'); body { font-family: 'Plus Jakarta Sans', sans-serif; }</style>
</head>
<body class="bg-slate-50 pb-20 text-slate-900">
    <header class="sticky top-0 z-50 bg-white p-4 border-b flex justify-between items-center">
        <h1 class="font-black text-sm">ADMIN <span class="text-orange-600">PRO</span></h1>
        <div class="flex gap-2">
            <input oninput="filter(this.value)" placeholder="Search..." class="bg-slate-100 rounded px-2 text-xs w-24">
            <button onclick="toggleReceipt()" class="bg-black text-white w-8 h-8 rounded flex items-center justify-center relative"><i class="fa-solid fa-receipt"></i><span id="badge" class="absolute -top-1 -right-1 bg-red-500 w-4 h-4 rounded-full text-[8px] flex items-center justify-center">0</span></button>
        </div>
    </header>

    <main class="p-2 max-w-6xl mx-auto">
        {% for cat, items in grouped.items() %}
        <div class="mb-6">
            <h2 class="text-xs font-black text-slate-400 mb-2 uppercase">{{ cat }}</h2>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                {% for p in items %}
                <div class="bg-white p-2 rounded-xl border flex flex-col" data-name="{{ p.name|lower }}">
                    <div class="relative mb-2">
                        {% if p.stock <= 0 %}<div class="absolute inset-0 flex items-center justify-center bg-white/50"><span class="bg-red-500 text-white text-[8px] font-black px-2 py-1 rounded">SOLD</span></div>{% endif %}
                        <img src="{{ p.image }}" class="w-full aspect-[2/3] object-cover rounded">
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="upd({{ p.id }},-1)" class="text-slate-400"><i class="fa-minus"></i></button>
                        <span id="v-{{ p.id }}" class="text-xs font-black">{{ p.stock }}</span>
                        <button onclick="upd({{ p.id }},1)" class="text-slate-400"><i class="fa-plus"></i></button>
                    </div>
                    <button onclick="add({{ p.id }}, '{{ p.name }}', {{ p.price }})" class="bg-black text-white text-[8px] font-black py-1 rounded w-full uppercase">+ Invoice</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </main>

    <div id="drawer" class="fixed inset-y-0 right-0 w-80 bg-white shadow-xl translate-x-full transition-transform z-50 flex flex-col">
        <div class="p-4 border-b flex justify-between"><h3 class="font-black">INVOICE</h3><button onclick="toggleReceipt()">X</button></div>
        <div id="list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        <div class="p-4 border-t space-y-2">
            <div class="flex justify-between font-black"><span>TOTAL</span><span id="tot">0៛</span></div>
            <button onclick="genImg()" class="w-full bg-slate-800 text-white py-2 rounded font-black text-xs">DOWNLOAD IMG</button>
            <button onclick="confirm()" class="w-full bg-orange-600 text-white py-2 rounded font-black text-xs">CONFIRM & DEDUCT</button>
        </div>
    </div>
    
    <!-- Hidden Invoice -->
    <div id="inv-box" style="position:fixed;left:-9999px;width:300px;background:white;padding:20px;color:black;">
        <h2 style="text-align:center;border-bottom:2px solid black;margin-bottom:10px;">RECEIPT</h2>
        <div id="inv-items"></div>
        <div style="display:flex;justify-content:space-between;border-top:2px solid black;margin-top:10px;font-weight:bold;"><span>TOTAL</span><span id="inv-tot"></span></div>
    </div>

    <script>
        let sale=[];
        async function upd(id,d){
            const e=document.getElementById('v-'+id);
            let n=Math.max(0,parseInt(e.innerText)+d);
            e.innerText=n;
            await fetch('/admin/api/update-stock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,amount:n})});
        }
        function toggleReceipt(){document.getElementById('drawer').classList.toggle('translate-x-full');}
        function add(id,n,p){
            const x=sale.find(i=>i.id===id);
            if(x)x.q++; else sale.push({id,n,p,q:1});
            render();
        }
        function render(){
            let t=0;
            document.getElementById('list').innerHTML=sale.map(i=>{t+=i.p*i.q;return `<div class="flex justify-between text-xs font-bold"><span>${i.n} x${i.q}</span><span>${i.p*i.q}៛</span></div>`}).join('');
            document.getElementById('tot').innerText=t+"៛";
            document.getElementById('badge').innerText=sale.length;
        }
        function genImg(){
            let t=0;
            document.getElementById('inv-items').innerHTML=sale.map(i=>{t+=i.p*i.q;return `<div style="display:flex;justify-content:space-between;font-size:12px;"><span>${i.n} x${i.q}</span><span>${i.p*i.q}</span></div>`}).join('');
            document.getElementById('inv-tot').innerText=t+"៛";
            html2canvas(document.getElementById('inv-box')).then(c=>{const l=document.createElement('a');l.download='inv.png';l.href=c.toDataURL();l.click();});
        }
        async function confirm(){
            if(!confirm("Deduct?"))return;
            await fetch('/admin/api/process-receipt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:sale.map(i=>({id:i.id,qty:i.q}))})});
            location.reload();
        }
        function filter(q){document.querySelectorAll('[data-name]').forEach(e=>e.style.display=e.dataset.name.includes(q.toLowerCase())?'flex':'none');}
    </script>
</body>
</html>


