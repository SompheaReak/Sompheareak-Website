<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Somphea Reak | Toy Universe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;500;600;700&display=swap');

        :root { --brand-green: #90D730; }
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans Khmer', sans-serif; background-color: #F4F4F4; -webkit-tap-highlight-color: transparent; padding-bottom: 60px; overscroll-behavior: none; }
        
        .text-brand { color: var(--brand-green); }
        .bg-brand { background-color: var(--brand-green); }
        .border-brand { border-color: var(--brand-green); }
        .bg-gradient-brand { background: linear-gradient(135deg, #a4e645 0%, #90D730 100%); }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }

        .flying-img { position: fixed; z-index: 9999; border-radius: 50%; opacity: 0.8; pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .popup-enter { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .popup-active { transform: translateY(0); }
        .screenshot-frame { background: white; width: 400px; padding: 20px; box-sizing: border-box; font-family: 'Noto Sans Khmer', sans-serif; }

        .custom-checkbox {
            appearance: none; width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%;
            display: grid; place-content: center; transition: all 0.2s;
        }
        .custom-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 0.2s; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: var(--brand-green); border-color: var(--brand-green); }
        .custom-checkbox:checked::before { transform: scale(1); }

        /* Gallery Styles */
        .gallery-snap { scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .gallery-item { scroll-snap-align: center; flex-shrink: 0; width: 100vw; height: 100%; display: flex; align-items: center; justify-content: center; }
        .gallery-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body class="bg-[#f4f4f4]">

    <!-- 1. HEADER -->
    <header class="sticky top-0 z-50 glass-nav h-[60px] px-3 flex items-center justify-between">
        <a href="/" class="w-9 h-9 flex items-center justify-center text-gray-600 rounded-full hover:bg-gray-100 active:scale-90 transition-transform"><i class="fa-solid fa-house text-lg"></i></a>
        <div class="flex flex-col items-center justify-center">
             <div class="flex items-center gap-1"><img src="static/images/logo.png" onerror="this.src='https://placehold.co/40'" class="w-6 h-6 object-contain rounded-md"><span class="font-black text-lg tracking-tight text-brand uppercase">Somphea Reak</span></div>
            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest" data-key="shop_name">Toy Universe</span>
        </div>
        <div class="flex items-center gap-2"><button onclick="toggleLang()" class="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-600 active:bg-gray-100"><span id="lang-btn">KH</span></button><a href="https://t.me/somphea_reak" target="_blank" class="w-9 h-9 flex items-center justify-center text-[#0088cc] rounded-full hover:bg-blue-50 active:scale-90 transition-transform"><i class="fa-brands fa-telegram text-xl"></i></a></div>
    </header>

    <!-- 2. PRODUCT GRID -->
    <nav class="sticky top-[60px] z-40 bg-[#f4f4f4]/95 backdrop-blur-sm px-3 py-2 overflow-x-auto hide-scrollbar flex gap-3" id="category-tabs"></nav>
    <main class="px-2 pb-24 grid grid-cols-2 gap-2 mt-2" id="product-grid"></main>

    <!-- 3. BOTTOM NAV -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-2 flex justify-between items-center z-[45] pb-safe h-[60px]">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center gap-1 w-14 text-brand"><i class="fa-solid fa-robot text-lg"></i><span class="text-[9px] font-bold" data-key="nav_toys">Toys</span></button>
        <a href="/bracelet" class="flex flex-col items-center gap-1 w-14 text-gray-400 hover:text-brand"><i class="fa-solid fa-gem text-lg"></i><span class="text-[9px] font-bold" data-key="nav_jewelry">Jewelry</span></a>
        <button onclick="openCart()" class="flex flex-col items-center gap-1 w-14 text-gray-400 hover:text-brand relative"><div class="relative"><i class="fa-solid fa-cart-shopping text-lg"></i><span id="nav-cart-badge" class="absolute -top-1.5 -right-1.5 bg-brand text-white text-[8px] font-bold w-4 h-4 flex items-center justify-center rounded-full border border-white hidden">0</span></div><span class="text-[9px] font-bold" data-key="nav_bag">My Bag</span></button>
    </div>

    <!-- 4. DETAIL VIEW -->
    <div id="detail-view" class="fixed inset-0 z-[60] bg-[#f4f4f4] hidden flex-col">
        <div class="absolute top-0 left-0 right-0 z-10 flex justify-between p-3 pointer-events-none">
            <button onclick="closeDetail()" class="pointer-events-auto w-9 h-9 bg-black/30 backdrop-blur rounded-full text-white flex items-center justify-center active:scale-90"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="openCart()" class="pointer-events-auto w-9 h-9 bg-black/30 backdrop-blur rounded-full text-white flex items-center justify-center active:scale-90 relative"><i class="fa-solid fa-cart-shopping text-xs"></i><span id="detail-cart-badge" class="absolute -top-1 -right-1 bg-brand text-white text-[8px] w-3.5 h-3.5 flex items-center justify-center rounded-full hidden">0</span></button>
        </div>

        <div class="flex-1 overflow-y-auto hide-scrollbar pb-20">
            <img id="dt-img" onclick="openGallery()" class="w-full aspect-square object-cover bg-white active:opacity-90 transition-opacity" onerror="this.src='https://placehold.co/400?text=No+Image'">
            <div class="bg-white p-3 mb-2 rounded-b-2xl shadow-sm">
                <div class="flex items-baseline gap-1 mb-1"><span class="text-brand text-xs font-bold">áŸ›</span><span id="dt-price" class="text-brand text-2xl font-black">0</span></div>
                <div id="dt-title" class="text-gray-900 font-bold text-sm leading-snug mb-2"></div>
                <div class="flex justify-between text-[10px] text-gray-400"><span data-key="express">Express</span><span><span data-key="sold">Sold</span> <span id="dt-sold">0</span></span><span>Phnom Penh</span></div>
            </div>
            <div class="bg-white p-3 mb-2 rounded-2xl shadow-sm">
                <div class="flex items-center justify-between text-[11px] font-bold text-gray-700 mb-2"><span data-key="select_model">Select Model</span><i class="fa-solid fa-chevron-right text-xs text-gray-400"></i></div>
                <div id="dt-vars" class="grid grid-cols-5 gap-2"></div>
            </div>
            <div class="p-4 text-center text-gray-300 text-xs font-bold uppercase tracking-widest">Somphea Reak</div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 bg-white border-t px-3 py-2 flex items-center gap-3 pb-safe">
            <div class="flex flex-col items-center justify-center text-gray-500 w-10" onclick="window.open('https://t.me/somphea_reak','_blank')"><i class="fa-regular fa-comment-dots text-xl"></i><span class="text-[9px]" data-key="chat">Chat</span></div>
            <div class="flex-1"><button onclick="openSku()" class="w-full h-11 bg-gradient-brand rounded-full text-white text-sm font-bold shadow-lg shadow-green-100 flex items-center justify-center gap-2 active:scale-95 transition-transform"><i class="fa-solid fa-cart-plus"></i><span data-key="add_cart">Add to Cart</span></button></div>
        </div>
    </div>

    <!-- 5. FULL SCREEN GALLERY -->
    <div id="gallery-view" class="fixed inset-0 z-[100] bg-black hidden flex-col transition-opacity duration-300 opacity-0">
        <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 pointer-events-none">
            <div class="bg-black/40 backdrop-blur px-3 py-1 rounded-full text-white font-bold text-xs"><span id="gallery-idx">1</span> / <span id="gallery-total">1</span></div>
            <button onclick="closeGallery()" class="pointer-events-auto w-9 h-9 bg-white/20 backdrop-blur rounded-full text-white flex items-center justify-center active:bg-white/40"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div id="gallery-scroll" class="flex-1 flex overflow-x-auto gallery-snap hide-scrollbar items-center h-full w-full"></div>
    </div>

    <!-- 6. SKU DRAWER -->
    <div id="sku-backdrop" class="fixed inset-0 z-[70] bg-black/60 hidden transition-opacity duration-300 opacity-0" onclick="closeSku()"></div>
    <div id="sku-drawer" class="fixed bottom-0 left-0 right-0 z-[71] bg-white rounded-t-2xl p-4 popup-enter h-[70vh] flex flex-col pb-safe">
        <div class="flex gap-3 mb-4">
            <img id="sku-img" class="w-24 h-24 rounded-lg object-cover bg-gray-50 border border-gray-100" onerror="this.src='https://placehold.co/100'">
            <div class="flex-1 pt-1">
                <div class="text-brand font-black text-xl"><span class="text-sm">áŸ›</span> <span id="sku-price">0</span></div>
                <div class="text-xs text-gray-500"><span data-key="stock">Stock</span>: 999+</div>
                <div class="text-xs text-gray-900 line-clamp-1 mt-1"><span data-key="selected">Selected</span>: <span id="sku-text" class="font-bold">--</span></div>
            </div>
            <button onclick="closeSku()"><i class="fa-solid fa-circle-xmark text-gray-300 text-2xl"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto hide-scrollbar">
            <div class="text-xs font-bold mb-2 text-gray-400 uppercase" data-key="models">Models</div>
            <div id="sku-list" class="flex flex-wrap gap-2 mb-6"></div>
            <div class="flex justify-between items-center py-4 border-t border-gray-100"><span class="text-sm font-bold" data-key="quantity">Quantity</span><div class="flex items-center gap-1"><button onclick="updQty(-1)" class="w-8 h-8 bg-gray-100 rounded text-gray-600 font-bold">-</button><div id="sku-qty" class="w-10 text-center font-bold text-sm">1</div><button onclick="updQty(1)" class="w-8 h-8 bg-gray-100 rounded text-gray-600 font-bold">+</button></div></div>
        </div>
        <button onclick="confirmSku()" class="w-full h-12 bg-gradient-brand rounded-full text-white font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2" data-key="add_cart">Add to Cart</button>
    </div>

    <!-- 7. CART DRAWER -->
    <div id="cart-bg" class="fixed inset-0 z-[80] bg-black/60 hidden" onclick="closeCart()"></div>
    <div id="cart-drawer" class="fixed top-0 right-0 bottom-0 w-80 bg-[#f4f4f4] z-[81] transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="bg-white px-4 py-3 flex justify-between items-center shadow-sm"><div class="font-bold"><span data-key="my_bag">My Bag</span> (<span id="cart-count">0</span>)</div><button onclick="closeCart()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
        <div id="cart-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        <div class="bg-white p-3 border-t pb-safe"><div class="flex justify-between font-bold text-sm mb-3"><span>Total (Selected):</span><span class="text-brand" id="cart-total">áŸ›0</span></div><button onclick="checkout()" class="w-full h-11 bg-gradient-brand rounded-full text-white font-bold text-sm shadow-lg" data-key="checkout">Checkout</button></div>
    </div>

    <!-- 8. INVOICE MODAL -->
    <div id="invoice-modal" class="fixed inset-0 z-[90] bg-white hidden flex-col"><div class="p-3 border-b flex items-center gap-3"><button onclick="closeInvoice()"><i class="fa-solid fa-arrow-left"></i></button><span class="font-bold" data-key="invoice">Invoice</span></div><div class="p-4 flex-1 overflow-y-auto"><input id="inv-name" placeholder="Name" class="w-full bg-gray-100 p-3 rounded-lg mb-3 text-sm font-bold"><input id="inv-phone" placeholder="Phone" type="tel" class="w-full bg-gray-100 p-3 rounded-lg mb-3 text-sm font-bold"><textarea id="inv-addr" placeholder="Address (Optional)" class="w-full bg-gray-100 p-3 rounded-lg mb-3 text-sm font-bold h-24 resize-none"></textarea><div id="invoice-preview" class="hidden flex justify-center mt-4"><img id="invoice-img" class="border shadow-lg rounded-lg w-full"></div></div><div class="p-4 border-t pb-safe flex gap-2"><button id="btn-share" class="flex-1 h-12 bg-[#0088cc] text-white rounded-full font-bold shadow-md hidden"><i class="fa-solid fa-share-nodes"></i> Share</button><button id="btn-tg" class="flex-1 h-12 bg-black text-white rounded-full font-bold shadow-md hidden"><i class="fa-brands fa-telegram"></i> Telegram</button><button id="gen-btn" onclick="doGenerate()" class="w-full h-12 bg-black text-white rounded-full font-bold" data-key="generate_invoice">Generate Invoice</button></div></div>

    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-5 py-3 rounded-xl z-[100] hidden flex-col items-center shadow-2xl backdrop-blur-md"><i class="fa-solid fa-circle-check text-3xl mb-2 text-brand"></i><span class="text-xs font-bold" data-key="added_to_bag">Added to Bag</span></div>

    <script>
        const CART_KEY = 'somphea_universal_cart';
        const EX_RATE = 4000;
        const TELEGRAM_USERNAME = "somphea_reak"; 
        
        // Full Product List from your request
        const PRODUCTS = [
            { id: 1, title: "WWII áž¢áž¶ážœáž»áž’áž’áž“áŸ‹áž’áŸ’áž„áž“áŸ‹", sold: "1.2k", cat: "WWII Soldier", vars: [{ id: "v1", name: "RPG", price: 0.125, img: "static/images/lego-wwii-02.jpg" }, { id: "v11", name: "áž€áž¶ážŽáž»áž„ (ážáŸ’áž˜áŸ…)", price: 1.50, img: "static/images/lego-wwii-101.jpg" }, { id: "v12", name: "áž€áž¶ážŽáž»áž„ M2", price: 1.25, img: "static/images/lego-wwii-102.jpg" }] },
            { id: 2, title: "WWII áž€áž¼áž“áž‘áž¶áž áž¶áž“", sold: "840", cat: "WWII Soldier", vars: [{ id: "a01", name: "áž‘áž¶áž áž¶áž“áž¢áž¶áž›áŸ’áž›ážºáž˜áŸ‰áž„", price: 0.25, img: "static/images/lego-wwii-army-101.jpg" }, { id: "a11", name: "áž‘áž¶áž áž¶áž“áž¢áž¶áž˜áŸážšáž·áž€", price: 0.25, img: "static/images/lego-wwii-army-201.jpg" }] },
            { id: 3, title: "áž‘áž¶áž áž¶áž“ áž¢áž¶áž›áŸ’áž›ážºáž˜áŸ‰áž„", sold: "310", cat: "WWII Soldier", vars: [{ id: "German-01", name: "German 01", price: 1.25, img: "static/images/lego-wwii-german-01.jpg" }, { id: "German-02", name: "German 02", price: 1.25, img: "static/images/lego-wwii-german-02.jpg" }] },
            { id: 9, title: "áž‘áž¶áž áž¶áž“ ážŸáž¼ážœáŸ€áž", sold: "310", cat: "WWII Soldier", vars: [{ id: "Soviet-01", name: "Soviet 01", price: 1.25, img: "static/images/lego-wwii-soviet-01.jpg" }, { id: "Soviet-02", name: "Soviet 02", price: 1.25, img: "static/images/lego-wwii-soviet-02.jpg" }] },
            { id: 10, title: "Ninjago Season 1", sold: "310", cat: "Ninjago", vars: [{ id: "njo-01", name: "Kai", price: 1.25, img: "static/images/lucky-01.jpg" }, { id: "njo-02", name: "Zane", price: 1.25, img: "static/images/lucky-02.jpg" }] },
            { id: 4, title: "Ninjago Pilot", sold: "310", cat: "Ninjago", vars: [{ id: "njo-11", name: "Kai Pilot", price: 1.25, img: "static/images/lucky-11.jpg" }] },
            { id: 5, title: "Ninjago NRG", sold: "310", cat: "Ninjago", vars: [{ id: "njo-21", name: "Kai NRG", price: 1.25, img: "static/images/lucky-21.jpg" }] },
            { id: 8, title: "LEGO Ninjago Sets", sold: "310", cat: "Ninjago", vars: [{ id: "LEGO 71808", name: "Mech 71808", price: 34.99, img: "static/images/lego-ninjago-71808.jpg" }, { id: "LEGO 30650", name: "Polybag", price: 9.99, img: "static/images/lego-ninjago-30650.jpg" }] }
        ];

        const TEXTS = {
            en: { shop_name: "Toy Universe", nav_toys: "Toys", nav_jewelry: "Jewelry", nav_bag: "My Bag", express: "Express", sold: "Sold", chat: "Chat", add_cart: "Add to Cart", stock: "Stock", selected: "Selected", models: "Models", quantity: "Quantity", confirm: "Confirm", my_bag: "My Bag", checkout: "Checkout", invoice: "Invoice", generate_invoice: "Generate Invoice", added_to_bag: "Added to Bag", select_model: "Select Model" },
            kh: { shop_name: "áž–áž·áž—áž–áž”áŸ’ážšážŠáž¶áž”áŸ‹áž€áŸ’áž˜áŸáž„áž›áŸáž„", nav_toys: "áž”áŸ’ážšážŠáž¶áž”áŸ‹áž›áŸáž„", nav_jewelry: "áž‚áŸ’ážšáž¿áž„áž¢áž›áž„áŸ’áž€áž¶ážš", nav_bag: "áž€áž“áŸ’ážáŸ’ážšáž€", express: "ážŠáž¹áž€ážšáž áŸážŸ", sold: "áž›áž€áŸ‹áž”áž¶áž“", chat: "áž†áž¶áž", add_cart: "ážŠáž¶áž€áŸ‹áž€áž“áŸ’ážáŸ’ážšáž€", stock: "ážŸáŸ’ážáž»áž€", selected: "áž”áž¶áž“áž‡áŸ’ážšáž¾ážŸážšáž¾ážŸ", models: "áž˜áŸ‰áž¼ážŠ", quantity: "áž…áŸ†áž“áž½áž“", confirm: "áž™áž›áŸ‹áž–áŸ’ážšáž˜", my_bag: "áž€áž“áŸ’ážáŸ’ážšáž€ážáŸ’áž‰áž»áŸ†", checkout: "áž‚áž·ážáž›áž»áž™", invoice: "ážœáž·áž€áŸ’áž€áž™áž”ážáŸ’ážš", generate_invoice: "áž”áž„áŸ’áž€áž¾ážážœáž·áž€áŸ’áž€áž™áž”ážáŸ’ážš", added_to_bag: "áž”áž¶áž“ážŠáž¶áž€áŸ‹áž…áž¼áž›áž€áž“áŸ’ážáŸ’ážšáž€", select_model: "áž‡áŸ’ážšáž¾ážŸážšáž¾ážŸáž˜áŸ‰áž¼ážŠ" }
        };

        let lang = 'en';
        let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
        let curProd = null, curVar = null, curQty = 1;
        let galleryIndex = 0;
        let generatedBlob = null;

        function init() { renderTabs(); renderGrid(PRODUCTS); updateBadges(); updateTexts(); }

        // --- Core ---
        function toggleLang() { lang = lang === 'en' ? 'kh' : 'en'; document.getElementById('lang-btn').innerText = lang === 'en' ? 'KH' : 'EN'; updateTexts(); }
        function updateTexts() { document.querySelectorAll('[data-key]').forEach(el => { const k = el.getAttribute('data-key'); if(TEXTS[lang][k]) el.innerText = TEXTS[lang][k]; }); renderTabs(); }
        function renderTabs() { const cats = ['All', 'WWII Soldier', 'Ninjago', 'City']; document.getElementById('category-tabs').innerHTML = cats.map(c => `<button onclick="filter('${c}')" class="px-4 py-1.5 bg-white rounded-full text-xs font-bold text-gray-600 border border-gray-100 shadow-sm whitespace-nowrap active:text-brand active:border-brand transition-colors">${c}</button>`).join(''); }
        function filter(c) { renderGrid(c==='All'?PRODUCTS:PRODUCTS.filter(p=>p.cat===c)); }
        function renderGrid(list) { document.getElementById('product-grid').innerHTML = list.map(p => `<div onclick="openDetail(${p.id})" class="bg-white rounded-xl overflow-hidden pb-2 shadow-sm"><img src="${p.vars[0].img}" class="w-full aspect-square object-cover bg-gray-50" onerror="this.src='https://placehold.co/400'"><div class="px-2 pt-2"><div class="text-xs text-gray-900 line-clamp-2 leading-tight h-8 mb-1 font-bold">${p.title}</div><div class="flex items-baseline gap-0.5"><span class="text-[10px] text-brand font-bold">áŸ›</span><span class="text-base text-brand font-black">${(p.vars[0].price * EX_RATE).toLocaleString()}</span></div><div class="text-[10px] text-gray-400 mt-1">${p.sold} <span data-key="sold">${TEXTS[lang].sold}</span></div></div></div>`).join(''); }

        // --- Detail View Logic ---
        function openDetail(id) {
            curProd = PRODUCTS.find(p=>p.id===id);
            curVar = curProd.vars[0];
            updateDetailUI();
            document.getElementById('detail-view').classList.remove('hidden'); document.getElementById('detail-view').classList.add('flex');
        }
        function updateDetailUI() {
            document.getElementById('dt-img').src = curVar.img;
            document.getElementById('dt-price').innerText = (curProd.vars[0].price * EX_RATE).toLocaleString(); // Show base price
            document.getElementById('dt-title').innerText = curProd.title;
            document.getElementById('dt-sold').innerText = curProd.sold;
            document.getElementById('dt-vars').innerHTML = curProd.vars.map(v => 
                `<img src="${v.img}" onclick="selectDetailVar('${v.id}')" class="w-full aspect-square rounded-md object-cover border-2 ${curVar.id===v.id ? 'border-brand' : 'border-gray-100'} bg-gray-50 transition-all active:scale-95" onerror="this.src='https://placehold.co/100'">`
            ).join('');
        }
        function selectDetailVar(id) { curVar = curProd.vars.find(v => v.id === id); updateDetailUI(); }
        function closeDetail() { document.getElementById('detail-view').classList.add('hidden'); document.getElementById('detail-view').classList.remove('flex'); }

        // --- Gallery Logic ---
        function openGallery() {
            const scroller = document.getElementById('gallery-scroll');
            scroller.onscroll = null;
            scroller.innerHTML = curProd.vars.map(v => `<div class="gallery-item"><img src="${v.img}" onerror="this.src='https://placehold.co/800'"></div>`).join('');
            document.getElementById('gallery-total').innerText = curProd.vars.length;
            document.getElementById('gallery-view').classList.remove('hidden');
            document.getElementById('gallery-view').classList.add('flex');
            const idx = curProd.vars.findIndex(v => v.id === curVar.id);
            scroller.scrollLeft = idx * window.innerWidth;
            galleryIndex = idx;
            document.getElementById('gallery-idx').innerText = idx + 1;
            setTimeout(() => { scroller.onscroll = onGalleryScroll; }, 50); 
            requestAnimationFrame(() => document.getElementById('gallery-view').classList.remove('opacity-0'));
        }
        function onGalleryScroll() {
            const scroller = document.getElementById('gallery-scroll');
            const idx = Math.round(scroller.scrollLeft / window.innerWidth);
            document.getElementById('gallery-idx').innerText = idx + 1;
            galleryIndex = idx;
        }
        function closeGallery() {
            if(curProd.vars[galleryIndex]) { selectDetailVar(curProd.vars[galleryIndex].id); }
            document.getElementById('gallery-view').classList.add('opacity-0');
            setTimeout(() => { document.getElementById('gallery-view').classList.add('hidden'); document.getElementById('gallery-view').classList.remove('flex'); }, 300);
        }

        // --- SKU/Add to Cart Logic ---
        function openSku() {
            curQty = 1; renderSkuInfo();
            document.getElementById('sku-list').innerHTML = curProd.vars.map(v => `<button onclick="selVar('${v.id}')" id="btn-${v.id}" class="px-3 py-1.5 rounded-lg text-xs font-bold border bg-gray-50 border-gray-100 text-gray-600">${v.name}</button>`).join('');
            selVar(curVar.id);
            document.getElementById('sku-backdrop').classList.remove('hidden'); requestAnimationFrame(()=>{ document.getElementById('sku-backdrop').classList.remove('opacity-0'); document.getElementById('sku-drawer').classList.add('popup-active'); });
        }
        function closeSku() { document.getElementById('sku-drawer').classList.remove('popup-active'); document.getElementById('sku-backdrop').classList.add('opacity-0'); setTimeout(()=> document.getElementById('sku-backdrop').classList.add('hidden'), 300); }
        function selVar(id) {
            curVar = curProd.vars.find(v=>v.id===id);
            document.querySelectorAll('#sku-list button').forEach(b => b.className = "px-3 py-1.5 rounded-lg text-xs font-bold border bg-gray-50 border-gray-100 text-gray-600");
            document.getElementById(`btn-${id}`).className = "px-3 py-1.5 rounded-lg text-xs font-bold border bg-green-50 border-brand text-brand";
            renderSkuInfo(); updateDetailUI();
        }
        function renderSkuInfo() { document.getElementById('sku-img').src = curVar.img; document.getElementById('sku-price').innerText = (curProd.vars.find(v=>v.id===curVar.id).price * EX_RATE).toLocaleString(); document.getElementById('sku-text').innerText = curVar.name; document.getElementById('sku-qty').innerText = curQty; }
        function updQty(d) { curQty = Math.max(1, curQty+d); document.getElementById('sku-qty').innerText = curQty; }

        function confirmSku() {
            const flyer = document.getElementById('sku-img').cloneNode();
            const start = document.getElementById('sku-img').getBoundingClientRect();
            flyer.className = 'flying-img'; flyer.style.top = start.top + 'px'; flyer.style.left = start.left + 'px'; flyer.style.width = start.width + 'px'; flyer.style.height = start.height + 'px';
            document.body.appendChild(flyer);
            requestAnimationFrame(()=> { flyer.style.top = (window.innerHeight - 50) + 'px'; flyer.style.left = (window.innerWidth/2 + 20) + 'px'; flyer.style.transform = 'scale(0.1)'; flyer.style.opacity = '0.5'; });
            setTimeout(()=> {
                flyer.remove();
                const ex = cart.find(i => i.vid === curVar.id);
                if(ex) ex.qty += curQty; else cart.push({pid: curProd.id, title: curProd.title, vid: curVar.id, vname: curVar.name, price: curVar.price, img: curVar.img, qty: curQty, chk: true});
                localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateBadges(); closeSku();
                const t = document.getElementById('toast'); t.classList.remove('hidden'); t.classList.add('flex'); setTimeout(()=> { t.classList.add('hidden'); t.classList.remove('flex'); }, 1500);
            }, 600);
        }

        // --- Cart/Invoice ---
        function updateBadges() { const c = cart.reduce((a,b)=>a+b.qty,0); ['nav-cart-badge', 'detail-cart-badge'].forEach(id => { const el = document.getElementById(id); el.innerText = c; el.classList.toggle('hidden', c===0); }); document.getElementById('cart-count').innerText = c; }
        function openCart() { renderCartList(); document.getElementById('cart-bg').classList.remove('hidden'); setTimeout(()=> document.getElementById('cart-drawer').classList.remove('translate-x-full'), 10); }
        function closeCart() { document.getElementById('cart-drawer').classList.add('translate-x-full'); setTimeout(()=> document.getElementById('cart-bg').classList.add('hidden'), 300); }
        function toggleCheck(idx) { cart[idx].chk = !cart[idx].chk; localStorage.setItem(CART_KEY, JSON.stringify(cart)); renderCartList(); }
        function renderCartList() {
            const list = document.getElementById('cart-list'); if(!cart.length) return list.innerHTML = '<div class="text-center mt-10 text-gray-400 text-xs">Empty</div>';
            list.innerHTML = cart.map((item, i) => `<div class="bg-white p-2 rounded-xl flex gap-3 shadow-sm items-center"><input type="checkbox" class="custom-checkbox shrink-0" ${item.chk ? 'checked' : ''} onclick="toggleCheck(${i})"><img src="${item.img}" class="w-16 h-16 rounded-lg bg-gray-50 object-cover border border-gray-100" onerror="this.src='https://placehold.co/100'"><div class="flex-1 min-w-0"><div class="text-xs font-bold line-clamp-1">${item.title}</div><div class="text-[10px] text-gray-400 bg-gray-50 inline px-1.5 rounded">${item.vname}</div><div class="flex justify-between items-end mt-1"><div class="text-brand text-sm font-black">áŸ›${(item.price*EX_RATE).toLocaleString()}</div><div class="text-xs font-bold text-gray-600">x${item.qty}</div></div></div><button onclick="delItem(${i})" class="text-gray-300 self-center px-2"><i class="fa-solid fa-trash"></i></button></div>`).join('');
            const total = cart.reduce((a,b)=> (b.chk ? a+(b.price*b.qty) : a), 0); document.getElementById('cart-total').innerText = 'áŸ›' + (total*EX_RATE).toLocaleString();
        }
        function delItem(i) { cart.splice(i,1); localStorage.setItem(CART_KEY, JSON.stringify(cart)); renderCartList(); updateBadges(); }
        
        function checkout() { 
            if(!cart.filter(i=>i.chk).length) return alert('Select items first'); 
            closeCart(); 
            document.getElementById('invoice-modal').classList.remove('hidden'); 
            document.getElementById('invoice-modal').classList.add('flex'); 
            // Reset state
            document.getElementById('btn-share').classList.add('hidden');
            document.getElementById('btn-tg').classList.add('hidden');
            document.getElementById('gen-btn').style.display = 'block';
            document.getElementById('invoice-preview').classList.add('hidden');
        }
        function closeInvoice() { 
            document.getElementById('invoice-modal').classList.add('hidden'); document.getElementById('invoice-modal').classList.remove('flex'); 
            openCart();
        }

        async function doGenerate() {
            const n=document.getElementById('inv-name').value, p=document.getElementById('inv-phone').value, a=document.getElementById('inv-addr').value; if(!n) return alert('Name required');
            
            // 1. Create a hidden container off-screen
            const div = document.createElement('div');
            div.style.position = 'absolute'; div.style.left = '-9999px'; div.style.top = '0'; div.style.width = '400px'; 
            div.className = 'screenshot-frame'; 
            
            const items = cart.filter(i => i.chk); const total = items.reduce((a,b)=> a+(b.price*b.qty), 0);
            const ts = new Date().getTime(); // Cache buster

            div.innerHTML = `<div class="text-center font-black text-2xl text-green-500 mb-4">SOMPHEA REAK</div><div class="text-xs mb-4"><div><b>To:</b> ${n}</div><div><b>Tel:</b> ${p}</div><div><b>Addr:</b> ${a}</div></div><table class="w-full text-xs border-collapse"><thead><tr class="border-b"><th class="text-left py-2">Item</th><th class="text-right py-2">Price</th></tr></thead><tbody>${items.map(i=>`<tr class="border-b border-dashed border-gray-200"><td class="py-2 flex gap-2"><img src="${i.img}?t=${ts}" crossorigin="anonymous" class="w-10 h-10 rounded object-cover border border-gray-200" onerror="this.src='https://placehold.co/50'"><div><div class="font-bold text-gray-800 line-clamp-1 w-32">${i.title}</div><div class="text-gray-500 text-[10px]">${i.vname} x${i.qty}</div></div></td><td class="text-right align-top font-bold pt-2 text-gray-700">$${(i.price*i.qty).toFixed(2)}</td></tr>`).join('')}</tbody><tfoot><tr class="border-t"><td class="pt-3 font-bold text-right pr-2">Total Riel</td><td class="pt-3 text-right font-black text-lg text-green-500">áŸ›${(total*EX_RATE).toLocaleString()}</td></tr></tfoot></table><div class="text-[9px] text-gray-400 text-center mt-6">Thank you for shopping!</div>`;
            document.body.appendChild(div); 

            // Allow images to load
            await new Promise(r => setTimeout(r, 500));

            try {
                // BUG FIX: use scrollHeight for windowHeight to capture full long receipt
                const cvs = await html2canvas(div, {
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: true,
                    windowHeight: div.scrollHeight + 100, // Important fix
                    height: div.scrollHeight + 50
                }); 
                
                const url = cvs.toDataURL();
                document.getElementById('invoice-img').src = url; 
                document.getElementById('invoice-preview').classList.remove('hidden'); 
                
                // Switch Buttons
                document.getElementById('gen-btn').style.display = 'none';
                document.getElementById('btn-share').classList.remove('hidden');
                document.getElementById('btn-tg').classList.remove('hidden');

                // Store Blob
                cvs.toBlob(blob => { generatedBlob = blob; });

                // Telegram Logic
                document.getElementById('btn-tg').onclick = () => {
                     let msg = `ðŸ§¾ *INVOICE ATTACHED*\nðŸ‘¤ ${n}\nðŸ“ž ${p}\n`;
                     if(a) msg += `ðŸ“ ${a}\n`;
                     msg += `\n*Please see the attached image for details.*`;
                     window.open(`https://t.me/${TELEGRAM_USERNAME}?text=${encodeURIComponent(msg)}`, '_blank');
                };
                
                // Share Logic
                document.getElementById('btn-share').onclick = async () => {
                    if (!generatedBlob) return alert('Image not ready');
                    const file = new File([generatedBlob], "invoice.png", { type: "image/png" });
                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file], title: 'Invoice', text: `Invoice for ${n}` });
                        } catch (err) { console.log('Share failed', err); }
                    } else {
                        alert("Sharing not supported. Long-press image to save.");
                    }
                };
            } catch (e) {
                alert("Error generating image"); console.error(e);
            } finally {
                div.remove();
            }
        }
        init();
    </script>
</body>
</html>


