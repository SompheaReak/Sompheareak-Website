<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minifigure Mystery Draw</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // IMPORTANT: Added arrayUnion and runTransaction for atomic code redemption
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase tools to the global scope for use in the script tag
        // These are now correctly imported using the module system before being exposed.
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, setLogLevel, serverTimestamp, arrayUnion, arrayRemove, runTransaction
        };
    </script>

    <style>
        /* --- General Variables and Fonts --- */
        :root {
            --lego-yellow: #FFC300;
            --lego-red: #C80815;
            --gacha-bg: #1f2937; /* Gray-800 */
        }
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* --- Keyframe Animations --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-2px, -3px) rotate(-1deg); }
            20% { transform: translate(3px, 0px) rotate(1deg); }
            30% { transform: translate(-3px, 2px) rotate(0deg); }
            40% { transform: translate(2px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 3px) rotate(-1deg); }
            60% { transform: translate(3px, 1px) rotate(0deg); }
            70% { transform: translate(-2px, -2px) rotate(-1deg); }
            80% { transform: translate(1px, 0px) rotate(1deg); }
            90% { transform: translate(-3px, 3px) rotate(0deg); }
            100% { transform: translate(1px, -1px) rotate(-1deg); }
        }

        @keyframes fadeIn {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* --- Custom Styles --- */
        .loading-animation {
            animation: shake 0.15s infinite;
            background-color: var(--lego-yellow);
            box-shadow: 0 0 20px rgba(255, 195, 0, 0.9), inset 0 0 10px rgba(0, 0, 0, 0.5);
            border-color: #fefefe !important;
        }

        .result-card {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
            transform: scale(0.7);
            opacity: 0;
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Rarity Styles */
        .rarity-common { background-color: #3b82f6; color: white; } 
        .rarity-rare { background-color: #fbbf24; color: #333; } 
        .rarity-super-rare { background-color: #ef4444; color: white; } 
        .rarity-ultra-rare { background-color: #a855f7; color: white; } 
        
        .new-badge {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            animation: pulse 1.5s infinite;
        }

        .draw-button-style {
            background-color: var(--lego-red);
            box-shadow: 0 5px 0 0 #A80008;
            transform: translateY(0);
            transition: all 0.1s ease-out;
        }
        .draw-button-style:active:not(:disabled) {
            transform: translateY(5px);
            box-shadow: 0 0 0 0 #A80008;
        }
        .draw-button-style:disabled {
            background-color: #4B5563;
            box-shadow: 0 5px 0 0 #374151;
            cursor: not-allowed;
        }
        
        /* Collection Styles */
        .collection-item {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .collection-item:hover {
            transform: scale(1.05);
        }
        .collected {
            filter: none;
            opacity: 1;
            border: 2px solid var(--lego-yellow);
        }
        .missing {
            filter: grayscale(100%) brightness(50%);
            opacity: 0.6;
            border: 2px dashed #4B5563;
            position: relative;
            cursor: default;
        }
        .missing:after {
            content: '??';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--lego-yellow);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }

        /* Modal specific styles */
        .category-button {
            transition: all 0.2s;
        }
        .category-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen bg-gray-900 flex flex-col items-center">

    <a href="#" class="self-start text-yellow-500 hover:text-yellow-400 mb-4 flex items-center transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
        Back to Home
    </a>
    
    <!-- Main App Container -->
    <div id="minifigure-app" class="w-full max-w-sm bg-gray-800 border-4 border-yellow-500 shadow-2xl p-6 rounded-xl relative overflow-hidden hidden">
        
        <div class="flex justify-center items-center mb-4">
            <h1 class="text-3xl font-black text-yellow-500 text-center uppercase tracking-wider font-['Bungee_Inline'] drop-shadow-lg shadow-black/50">
                Mystery Draw!
            </h1>
        </div>
        
        <!-- Category Selector Display -->
        <div id="category-display" class="mb-4 p-2 rounded-lg bg-red-800 shadow-inner border border-red-700 text-center">
            <span class="text-sm font-semibold text-gray-200">Current Collection:</span>
            <code id="current-category" class="text-xl font-mono font-extrabold text-yellow-300 block tracking-widest">...</code>
        </div>
        
        <div class="mb-4 p-2 rounded-lg bg-gray-700 shadow-inner border border-gray-600 text-center">
            <span class="text-sm font-semibold text-gray-300">Your Player ID:</span>
            <code id="user-id-display" class="text-xl font-mono font-extrabold text-red-400 block tracking-widest text-wrap break-all">...</code>
        </div>

        <div class="flex justify-between items-center mb-4 p-3 rounded-lg bg-gray-700 shadow-inner border border-gray-600">
            <span class="text-lg font-semibold text-gray-300">Draws Available:</span>
            <span id="draw-count" class="text-3xl font-extrabold text-yellow-500 drop-shadow-lg">0</span>
        </div>
        
        <div id="datetime-display" class="mb-6 p-2 text-center rounded-lg bg-gray-700 border border-gray-600">
        </div>

        <div id="result-area" class="mt-4 min-h-[150px] flex items-center justify-center border-2 border-dashed border-gray-700 rounded-lg p-2">
            <div id="initial-message" class="text-center p-4 text-gray-400">
                <p class="mb-2 text-lg font-semibold text-yellow-500">Welcome, Player!</p>
                <p class="text-sm">Use a redeem code (e.g., **FIGFREEA1**) to get draws and start collecting.</p>
            </div>
        </div>

        <div class="flex space-x-3 mt-6">
            <button id="draw-1x-button" class="w-1/2 py-4 text-xl font-bold text-white rounded-xl transition duration-150 uppercase draw-button-style" disabled>
                Open 1x (1 Draw)
            </button>
            <button id="draw-5x-button" class="w-1/2 py-4 text-xl font-bold text-white rounded-xl transition duration-150 uppercase draw-button-style" disabled>
                Open 5x (5 Draws)
            </button>
        </div>

        <div class="mt-4 flex space-x-2">
            <input type="text" id="redeem-input" placeholder="Enter redeem code (e.g., FIGFREEA1)" 
                   class="flex-grow p-2 text-sm rounded-xl bg-gray-700 text-white border border-gray-600 placeholder-gray-400 focus:ring-yellow-500 focus:border-yellow-500">
            <button id="redeem-button" class="py-2 px-4 text-sm font-semibold bg-green-600 hover:bg-green-700 text-white rounded-xl shadow transition duration-200">
                Redeem
            </button>
        </div>
        <p id="redeem-message" class="text-xs text-center mt-1 h-4"></p>
        <button id="reset-collection-button" class="w-full py-2 text-xs font-semibold bg-red-800 hover:bg-red-700 text-white rounded-xl shadow transition duration-200 mt-2 border border-red-700">
            [DEMO MODE] Reset Current Collection
        </button>
    </div>
    
    <!-- Collection List -->
    <div id="collection-app" class="w-full max-w-sm mt-8 p-4 bg-gray-800 rounded-xl border border-gray-700 shadow-lg hidden">
        <h2 class="text-xl font-bold text-yellow-500 mb-3 border-b border-yellow-500 pb-2 flex justify-between items-center">
            <span>Collection: <span id="collection-name">...</span></span>
            <span class="text-lg font-mono text-white">
                (<span id="collected-count">0</span> / <span id="total-count">0</span>)
            </span>
        </h2>
        <div id="collection-list" class="grid grid-cols-6 gap-1">
        </div>
    </div>

    <!-- Figure Details Modal -->
    <div id="figure-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4" onclick="document.getElementById('figure-modal').classList.add('hidden')">
        <div class="bg-gray-800 p-6 rounded-xl border-4 border-yellow-500 shadow-2xl max-w-xs sm:max-w-sm w-full relative" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('figure-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-red-600 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold hover:bg-red-700 transition">
                &times;
            </button>
            <h3 id="modal-title" class="2xl font-bold text-yellow-500 mb-4 text-center"></h3>
            <div class="aspect-square w-full bg-gray-700 rounded-lg overflow-hidden border-4 border-gray-600">
                <img id="modal-image" src="" alt="" class="w-full h-full object-contain">
            </div>
            <div class="mt-4 text-center">
                <span id="modal-rarity" class="px-4 py-1 text-sm font-bold rounded-full text-gray-900 shadow-md"></span>
            </div>
        </div>
    </div>

    <!-- Category Selection Modal (Initial Load) -->
    <div id="category-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-xl border-4 border-red-600 shadow-2xl max-w-lg w-full relative text-center">
            <h2 class="text-3xl font-black text-red-400 mb-6 font-['Bungee_Inline']">Choose Your Collection!</h2>
            <p class="text-gray-300 mb-6 text-sm">Your draws and collection are separate for each category.</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Category A: Pop Culture -->
                <button onclick="selectCategory('A')" 
                        class="category-button bg-blue-600 text-white p-6 rounded-xl font-bold text-lg hover:bg-blue-700">
                    <p class="text-xl mb-2">Category A: Pop Culture</p>
                    <p class="text-sm font-normal opacity-90">(Avengers, Spidey, Anime, Godzilla, etc.)</p>
                </button>
                
                <!-- Category B: Ninjago -->
                <button onclick="selectCategory('B')" 
                        class="category-button bg-green-600 text-white p-6 rounded-xl font-bold text-lg hover:bg-green-700">
                    <p class="text-xl mb-2">Category B: Ninjago</p>
                    <p class="text-sm font-normal opacity-90">(Classic Ninja Variants)</p>
                </button>
            </div>
            <p id="auth-status" class="mt-6 text-yellow-500 font-semibold text-sm"></p>
        </div>
    </div>


<script>
    // --- ðŸ’¥ CUSTOM MINIFIGURE DATASETS ðŸ’¥ ---

    // Note: The original image_url for Category B figures were using "static/images/lucky-XX.jpg" 
    // which won't load in this environment. We will use placeholders for Category B as well.
    const NINJAGO_FIGURE_STRINGS = [ 
        // Kai variants (Red color theme)
     'name:"Kai (DX)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-01.jpg"',
     'name:"Zane (DX)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-02.jpg"',
     'name:"Jay (DX)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-03.jpg"',
     'name:"Cole (DX)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-04.jpg"',
     'name:"Lloyd (DX)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-05.jpg"',
     'name:"Nya (DX)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-06.jpg"',
  
     'name:"Kai (PILOT)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-11.jpg"',
     'name:"Zane (PILOT)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-12.jpg"',
     'name:"Jay (PILOT)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-13.jpg"',
     'name:"Cole (PILOT)", rarity:"Common", weight:80, color:"red-600", image_url:"static/images/lucky-14.jpg"',
     'name:"Lloyd (PILOT)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-15.jpg"',
     'name:"Pink Zane (PILOT)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-16.jpg"',

     'name:"Kai (NRG)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-21.jpg"',
     'name:"Zane (NRG)", rarity:"Rare", weight:80, color:"red-600", image_url:"static/images/lucky-22.jpg"',
     'name:"Jay (NRG)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-23.jpg"',
     'name:"Cole (NRG)", rarity:"Rare", weight:80, color:"red-600", image_url:"static/images/lucky-24.jpg"',
     'name:"Lloyd (NRG)", rarity:"Rare", weight:20, color:"red-600", image_url:"static/images/lucky-25.jpg"',
     'name:"Nya (NRG)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-26.jpg"',
  
     'name:"Kai (ZX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-41.jpg"',
     'name:"Zane (ZX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-42.jpg"',
     'name:"Jay (ZX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-43.jpg"',
     'name:"Cole (ZX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-44.jpg"',
     'name:"Lloyd (ZX)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-45.jpg"',
     'name:"Nya (ZX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-46.jpg"',
  
     'name:"Kai (KIMONO)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-51.jpg"',
     'name:"Zane (KIMONO)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-52.jpg"',
     'name:"Jay (KIMONO)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-53.jpg"',
     'name:"Cole (KIMONO)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-54.jpg"',
     'name:"Lloyd (KIMONO)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-55.jpg"',
     'name:"Golden Lloyd (KIMONO)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-56.jpg"',

     'name:"Kai (PAJAMAS)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-61.jpg"',
     'name:"Zane (PAJAMAS)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-62.jpg"',
     'name:"Jay (PAJAMAS)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-63.jpg"',
     'name:"Cole (PAJAMAS)", rarity:"Ultra Rare", weight:10, color:"red-600", image_url:"static/images/lucky-64.jpg"',
     'name:"Golden Zane (DX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-65.jpg"',
     'name:"Ultra Nya (DX)", rarity:"Rare", weight:60, color:"red-600", image_url:"static/images/lucky-66.jpg"',
  
     'name:"Kai (REBOOTED)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-71.jpg"',
     'name:"Zane (REBOOTED)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-72.jpg"',
     'name:"Jay (REBOOTED)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-73.jpg"',
     'name:"Cole (REBOOTED)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-74.jpg"',
     'name:"Lloyd (REBOOTED)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-75.jpg"',
     'name:"Pixal (REBOOTED)", rarity:"Super Rare", weight:40, color:"red-600", image_url:"static/images/lucky-76.jpg"',
    ];

    const POP_CULTURE_FIGURE_STRINGS = [
        'name:"Iron Man (Mk 50)", rarity:"Common", weight:80, color:"red-600", image_url:"https://placehold.co/96x96/C80815/FFC300?text=IRONMAN"',
        'name:"Captain America (Endgame)", rarity:"Rare", weight:60, color:"blue-600", image_url:"https://placehold.co/96x96/2563EB/ffffff?text=CAPTAIN"',
        'name:"Spider-Man (Black Suit)", rarity:"Rare", weight:60, color:"gray-700", image_url:"https://placehold.co/96x96/374151/C80815?text=SPIDEY"',
        'name:"Goku (Super Saiyan)", rarity:"Super Rare", weight:40, color:"orange-500", image_url:"https://placehold.co/96x96/F97316/ffffff?text=GOKU"',
        'name:"Godzilla (Atomic)", rarity:"Ultra Rare", weight:10, color:"purple-600", image_url:"https://placehold.co/96x96/9333EA/ffffff?text=GODZILLA"',
        'name:"Black Widow (Tactical)", rarity:"Common", weight:80, color:"gray-700", image_url:"https://placehold.co/96x96/374151/C80815?text=WIDOW"',
        'name:"Thor (Stormbreaker)", rarity:"Common", weight:80, color:"yellow-500", image_url:"https://placehold.co/96x96/FBBF24/333333?text=THOR"',
        'name:"Thanos (Full Armor)", rarity:"Super Rare", weight:40, color:"purple-600", image_url:"https://placehold.co/96x96/9333EA/ffffff?text=THANOS"',
        'name:"Hulk (Smash)", rarity:"Rare", weight:60, color:"green-500", image_url:"https://placehold.co/96x96/22C55E/ffffff?text=HULK"',
        'name:"Vegeta (Majin)", rarity:"Ultra Rare", weight:10, color:"blue-600", image_url:"https://placehold.co/96x96/2563EB/ffffff?text=VEGETA"',
        'name:"Wonder Woman (Gold Armor)", rarity:"Ultra Rare", weight:10, color:"yellow-500", image_url:"https://placehold.co/96x96/FBBF24/333333?text=WW"',
        'name:"Groot (Tiny)", rarity:"Common", weight:80, color:"green-500", image_url:"https://placehold.co/96x96/22C55E/ffffff?text=GROOT"',
        'name:"Batman (The Dark Knight)", rarity:"Rare", weight:60, color:"gray-700", image_url:"https://placehold.co/96x96/374151/ffffff?text=BATMAN"',
        'name:"Joker (Clown Prince)", rarity:"Super Rare", weight:40, color:"purple-600", image_url:"https://placehold.co/96x96/9333EA/ffffff?text=JOKER"',
        'name:"Master Chief (Halo)", rarity:"Ultra Rare", weight:10, color:"green-500", image_url:"https://placehold.co/96x96/22C55E/ffffff?text=MC"',
    ];

    // --- Redeem Codes are now Category Specific ---
    const CODE_REFILL_AMOUNT = 5;
    // We add the category ID prefix to distinguish which category the code belongs to, but Firestore checks the global list.
    const POP_CULTURE_CODES = ["FREEA1", "FREEA2", "FREEMARVEL", "FREEANIME", "FREEGODZ"];
    const NINJAGO_CODES = ["FREEB1", "FREEB2", "FREENINJA", "FREEDX", "FREELLOYD"];


    // --- GLOBAL STATE ---
    let db, auth;
    let APP_ID; 
    let USER_ID = null; 
    let IS_AUTH_READY = false;
    let IS_GAME_READY = false; 

    let CATEGORY_ID = null; // 'A' or 'B'
    let MINIFIGURES = [];
    let SINGLE_USE_CODES = [];
    let currentDraws = 0;
    let collectedFigures = []; // Stores image_url strings
    let isLoading = false;

    // --- FIRESTORE CONSTANTS ---
    const BASE_COLLECTION_NAME = 'game_state'; 
    const GLOBAL_CODES_COLLECTION = 'redeem_codes';
    const GLOBAL_CODES_DOC = 'used_codes';
    const INITIAL_DRAWS = 0; 
    
    // Rarity Color Map for Placeholder Generation (Used by getPlaceholderUrl)
    const FIGURE_COLOR_MAP = {
        'red-600': 'C80815',
        'sky-400': '38BDF8',
        'blue-600': '2563EB',
        'gray-700': '374151',
        'green-500': '22C55E',
        'purple-600': '9333EA',
        'yellow-500': 'FBBF24',
        'orange-500': 'F97316',
        'pink-400': 'F472B6',
    };

    // --- UI Elements ---
    const appContainer = document.getElementById('minifigure-app');
    const collectionAppContainer = document.getElementById('collection-app');
    const drawCountElement = document.getElementById('draw-count');
    const draw1xButton = document.getElementById('draw-1x-button'); 
    const draw5xButton = document.getElementById('draw-5x-button');
    const resultArea = document.getElementById('result-area');
    const resetCollectionButton = document.getElementById('reset-collection-button');
    const collectionListElement = document.getElementById('collection-list');
    const collectedCountElement = document.getElementById('collected-count');
    const totalCountElement = document.getElementById('total-count');
    const initialMessage = document.getElementById('initial-message');
    const userIdDisplay = document.getElementById('user-id-display');
    const currentCategoryDisplay = document.getElementById('current-category');
    const collectionNameDisplay = document.getElementById('collection-name');

    const redeemInput = document.getElementById('redeem-input');
    const redeemButton = document.getElementById('redeem-button');
    const redeemMessage = document.getElementById('redeem-message');
    const authStatus = document.getElementById('auth-status');


    // --- FIRESTORE PATH UTILITIES ---

    /**
     * Gets the document reference for the current user's draw state for the selected category.
     * Path: /artifacts/{appId}/users/{userId}/game_state/category_{CATEGORY_ID}
     */
    function getDrawCollectionDocRef() {
        if (!db || !USER_ID || !CATEGORY_ID) return null;
        return firebase.doc(db, 'artifacts', APP_ID, 'users', USER_ID, BASE_COLLECTION_NAME, `category_${CATEGORY_ID}`);
    }

    /**
     * Gets the document reference for the globally used redeem codes.
     * Path: /artifacts/{appId}/public/data/redeem_codes/used_codes
     */
    function getGlobalCodesDocRef() {
        if (!db) return null;
        return firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', GLOBAL_CODES_COLLECTION, GLOBAL_CODES_DOC);
    }
    
    // --- Initial Setup & Auth ---

    async function setupFirebase() {
        try {
            // 1. Get Global Variables
            APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Parse config, falling back to an empty object if undefined/malformed
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            // Debugging
            firebase.setLogLevel('Debug');
            authStatus.textContent = "Initializing Firebase...";

            // 2. Initialize App and Services
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.getFirestore(app);
            auth = firebase.getAuth(app);
            
            // 3. Set up Auth Listener and sign in
            firebase.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    USER_ID = user.uid;
                } else {
                    // Sign in with custom token or anonymously
                    try {
                        if (initialAuthToken) {
                            await firebase.signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Use anonymous sign-in as fallback
                            const anonymousUser = await firebase.signInAnonymously(auth);
                            USER_ID = anonymousUser.user.uid;
                        }
                    } catch (e) {
                        console.error("Auth sign-in error:", e);
                        // If auth fails completely, set a random ID for temporary state
                        USER_ID = crypto.randomUUID(); 
                    }
                }
                
                // Once authenticated (or fallback ID generated)
                if (!IS_AUTH_READY) {
                    IS_AUTH_READY = true;
                    userIdDisplay.textContent = USER_ID;
                    authStatus.textContent = `Authenticated. ID: ${USER_ID.substring(0, 8)}...`;
                    
                    // Show category modal only once auth is done
                    if (!CATEGORY_ID) {
                        document.getElementById('category-modal').classList.remove('hidden');
                    }
                }
            });
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            // Handling the specific error from the screenshot for better user feedback
            if (error.message.includes('projectId') || JSON.stringify(error).includes('projectId')) {
                // Keep the error message visible but allow the user to select a category
                authStatus.textContent = `âŒ Initialization Error: Project config missing (projectId).`;
            } else {
                authStatus.textContent = `Authentication Failed: ${error.message}`;
            }
             // Even if initialization failed, we can still show the modal, 
             // but we rely on selectCategory not using IS_AUTH_READY flag.
             if (!CATEGORY_ID) {
                document.getElementById('category-modal').classList.remove('hidden');
            }
        }
    }


    // --- Category Selection Logic ---
    
    window.selectCategory = function(categoryId) {
        // FIX: Removed !IS_AUTH_READY guard. If Firebase initialization failed, 
        // the button click was blocked. Now it proceeds, and Firebase-dependent 
        // functions will handle the null 'db' variable gracefully.
        if (IS_GAME_READY) return; 

        CATEGORY_ID = categoryId;
        
        // 1. Set game data based on category
        if (CATEGORY_ID === 'B') {
            MINIFIGURES = NINJAGO_FIGURE_STRINGS.map(parseFigureString);
            SINGLE_USE_CODES = NINJAGO_CODES;
            currentCategoryDisplay.textContent = "CATEGORY B: NINJAGO";
            collectionNameDisplay.textContent = "NINJAGO";
            redeemInput.placeholder = "Enter NINJAGO code (e.g., FREEB1)";
        } else { // Default to A
            MINIFIGURES = POP_CULTURE_FIGURE_STRINGS.map(parseFigureString);
            SINGLE_USE_CODES = POP_CULTURE_CODES;
            currentCategoryDisplay.textContent = "CATEGORY A: POP CULTURE";
            collectionNameDisplay.textContent = "POP CULTURE";
            redeemInput.placeholder = "Enter POP CULTURE code (e.g., FREEA1)";
        }

        // 2. Hide modal and show app UI
        document.getElementById('category-modal').classList.add('hidden');
        appContainer.classList.remove('hidden');
        collectionAppContainer.classList.remove('hidden');
        
        // 3. Start Firestore listener for this category
        startFirestoreListener();
        
        // 4. Update UI visuals
        if (totalCountElement) {
            totalCountElement.textContent = MINIFIGURES.length;
        }

        IS_GAME_READY = true;
        updateDrawCountUI();
    }


    // --- Firestore Realtime Listener ---

    function startFirestoreListener() {
        // Check if Firestore is initialized. If not, default to 0 draws / empty collection.
        if (!db || !getDrawCollectionDocRef()) {
            console.warn("Firestore not initialized or category/auth not ready. Skipping real-time listener.");
            currentDraws = INITIAL_DRAWS;
            collectedFigures = [];
            updateCollectionUI();
            updateDrawCountUI();
            return;
        }

        const docRef = getDrawCollectionDocRef();
        
        firebase.onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentDraws = data.draws || INITIAL_DRAWS;
                // Filter out any potential duplicates in the stored array just in case
                collectedFigures = Array.from(new Set(data.collectedFigures || [])); 
            } else {
                // Initialize document if it doesn't exist
                currentDraws = INITIAL_DRAWS;
                collectedFigures = [];
                // Use setDoc to create the document with initial state
                firebase.setDoc(docRef, { 
                    draws: INITIAL_DRAWS, 
                    collectedFigures: [], 
                    lastUpdate: firebase.serverTimestamp()
                }).catch(e => console.error("Error initializing document:", e));
            }

            updateCollectionUI();
            updateDrawCountUI();
            
        }, (error) => {
            console.error("Firestore Snapshot Error:", error);
            authStatus.textContent = `Data Sync Error: ${error.message}`;
        });
    }

    // --- Core Data Management ---

    /**
     * Updates the user's draw count in Firestore.
     * @param {number} newCount - The new total number of draws.
     */
    async function updateDrawCount(newCount) {
        currentDraws = Math.max(0, newCount);
        const docRef = getDrawCollectionDocRef();
        // Check if DB is available before attempting to write
        if (docRef && db) { 
            await firebase.updateDoc(docRef, { 
                draws: currentDraws,
                lastUpdate: firebase.serverTimestamp()
            }).catch(e => console.error("Error updating draw count:", e));
        }
    }
    
    /**
     * Saves a new figure's URL to the collectedFigures array in Firestore.
     * @param {string} figureUrl - The unique identifier (image_url) of the figure.
     * @returns {boolean} - True if the figure was newly collected, false if it was a duplicate.
     */
    async function saveCollection(figureUrl) {
        const isNew = !collectedFigures.includes(figureUrl);
        
        if (isNew) {
            const newCollected = [...collectedFigures, figureUrl];
            const docRef = getDrawCollectionDocRef();
            
            // Check if DB is available before attempting to write
            if (docRef && db) { 
                // The snapshot listener handles the real-time update of collectedFigures
                await firebase.updateDoc(docRef, { 
                    collectedFigures: newCollected,
                    lastUpdate: firebase.serverTimestamp()
                }).catch(e => console.error("Error saving collection:", e));
            }
        }
        return isNew; 
    }
    
    /**
     * Resets the current category's collection and draws to initial state. (DEMO FUNCTION)
     */
    async function resetCollection() {
        const docRef = getDrawCollectionDocRef();
        // Check if DB is available before attempting to write
        if (docRef && db) { 
            await firebase.setDoc(docRef, { // Using setDoc to overwrite cleanly
                collectedFigures: [],
                draws: INITIAL_DRAWS,
                lastUpdate: firebase.serverTimestamp()
            }).catch(e => console.error("Error resetting collection:", e));
        }
        
        // Display confirmation message in the draw area
        resultArea.innerHTML = `
            <div class="text-center p-4 text-gray-400">
                <p class="mb-2 text-lg font-semibold text-red-500">Collection Reset!</p>
                <p class="text-sm">All collected figures for ${CATEGORY_ID} cleared and draws set to ${INITIAL_DRAWS}.</p>
            </div>
        `;
    }

    // --- Utility Functions ---

    /**
     * Generates a unique placeholder URL for a figure using its color and name.
     * @param {Object} figure - The minifigure object.
     * @returns {string} The placeholder image URL.
     */
    function getPlaceholderUrl(figure) {
        let bgColor = FIGURE_COLOR_MAP[figure.color] || '6B7280';
        // Light text for dark backgrounds, dark text for light backgrounds (yellow, sky, pink)
        let fgColor = ['sky-400', 'yellow-500', 'pink-400'].includes(figure.color) ? '333333' : 'ffffff';
        
        const nameCode = figure.name.split(' ')[0].toUpperCase().substring(0, 5);
        return `https://placehold.co/96x96/${bgColor}/${fgColor}?text=${nameCode}`;
    }

    /**
     * Parses a string definition into a minifigure object.
     * @param {string} str - The figure definition string.
     * @returns {Object} The parsed figure object.
     */
    function parseFigureString(str) {
        const figure = {};
        // Regex to match key:"value" pairs, handling nested quotes or complex values are not needed here
        const regex = /(\w+):"([^"]+)"/g; 
        let match;
        while ((match = regex.exec(str)) !== null) {
            if (match[1] === 'weight') {
                figure[match[1]] = parseInt(match[2], 10);
            } else {
                figure[match[1]] = match[2];
            }
        }
        return figure;
    }

    /**
     * Performs a weighted random draw of a single minifigure.
     * @returns {Object|null} The drawn minifigure object.
     */
    function weightedDraw() {
        const weightedList = [];
        MINIFIGURES.forEach(fig => {
            const weight = fig.weight || 1; 
            for (let i = 0; i < weight; i++) {
                weightedList.push(fig);
            }
        });

        if (weightedList.length === 0) {
            console.error("No figures available for draw.");
            return null;
        }

        const randomIndex = Math.floor(Math.random() * weightedList.length);
        return weightedList[randomIndex];
    }
    
    // --- Cambodia Time Logic ---
    function getOrdinal(d) {
        if (d > 3 && d < 21) return 'th'; 
        switch (d % 10) {
            case 1: return "st";
            case 2: return "nd";
            case 3: return "rd";
            default: return "th";
        }
    }
    
    function updateCambodiaTime() {
        const now = new Date();
        const options = {
            timeZone: 'Asia/Phnom_Penh',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };

        const formatter = new Intl.DateTimeFormat('en-US', options);
        const parts = formatter.formatToParts(now);

        let day, month, year, hour, minute, second;

        parts.forEach(part => {
            if (part.type === 'day') day = part.value;
            if (part.type === 'month') month = part.value;
            if (part.type === 'year') year = part.value;
            if (part.type === 'hour') hour = part.value; 
            if (part.type === 'minute') minute = part.value;
            if (part.type === 'second') second = part.value;
        });

        const dayInt = parseInt(day, 10);
        const formattedDate = `${dayInt}${getOrdinal(dayInt)}/${month}/${year}`;
        const formattedTime = `${hour}h ${minute}m ${second}s`;
        
        const datetimeDisplay = document.getElementById('datetime-display');
        if (datetimeDisplay) {
            datetimeDisplay.innerHTML = `
                <p class="text-sm font-semibold text-gray-400">Time in Phnom Penh (UTC+7)</p>
                <p class="text-base font-bold text-gray-300">${formattedDate} | ${formattedTime}</p>
            `;
        }
    }
    
    // --- Modal Function (Exposed to window for onclick handler) ---
    window.showFigureDetails = function(figureUrl) {
        const figure = MINIFIGURES.find(f => f.image_url === figureUrl);
        if (!figure) return;
        
        const modal = document.getElementById('figure-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalImage = document.getElementById('modal-image');
        const modalRarity = document.getElementById('modal-rarity');
        
        const rarityClass = `rarity-${figure.rarity.toLowerCase().replace(' ', '-')}`;
        const fallbackUrl = getPlaceholderUrl(figure);

        modalTitle.textContent = figure.name;
        modalImage.src = figure.image_url; 
        modalImage.alt = figure.name;
        // Set the onerror handler for fallback image
        modalImage.setAttribute('onerror', `this.onerror=null; this.src='${fallbackUrl}'`);
        
        modalRarity.textContent = figure.rarity.toUpperCase();
        modalRarity.className = `px-4 py-1 text-sm font-bold rounded-full text-gray-900 shadow-md ${rarityClass}`;
        
        modal.classList.remove('hidden');
    }


    // --- UI Update ---

    function updateDrawCountUI() {
        if (!IS_GAME_READY) return;

        if (drawCountElement) {
            drawCountElement.textContent = currentDraws;
        }
        
        if (draw1xButton && draw5xButton) {
            const noDraws = currentDraws <= 0;
            const notEnoughFor5x = currentDraws < 5;
            const disableButtons = isLoading || !IS_GAME_READY;
            
            draw1xButton.disabled = noDraws || disableButtons;
            draw1xButton.textContent = disableButtons ? 'Drawing...' : (noDraws ? 'No Draws Left!' : 'Open 1x (1 Draw)');
            
            draw5xButton.disabled = notEnoughFor5x || disableButtons;
            draw5xButton.textContent = disableButtons ? 'Drawing...' : (notEnoughFor5x ? `Need ${5 - currentDraws} More` : 'Open 5x (5 Draws)');
        }
    }
    
    function updateCollectionUI() {
        if (!collectionListElement) return;
        
        const collectedUrls = new Set(collectedFigures);
        const collectedCount = collectedUrls.size;
        
        if (collectedCountElement) {
            collectedCountElement.textContent = collectedCount;
        }

        collectionListElement.innerHTML = MINIFIGURES.map(fig => {
            const isCollected = collectedUrls.has(fig.image_url);
            const statusClass = isCollected ? 'collected collection-item' : 'missing';
            const clickHandler = isCollected ? `onclick="showFigureDetails('${fig.image_url}')"` : '';
            const fallbackUrl = getPlaceholderUrl(fig);
            const rarityClass = `rarity-${fig.rarity.toLowerCase().replace(' ', '-')} `;


            return `
                <div class="relative w-full aspect-square rounded-lg overflow-hidden transition duration-150 p-0.5 ${statusClass}"
                     title="${fig.name} (${isCollected ? 'Found - Click to View' : 'Missing'})" ${clickHandler}>
                    <img src="${fig.image_url}" 
                         alt="${fig.name}" 
                         class="w-full h-full object-contain rounded-md" 
                         onerror="this.onerror=null; this.src='${fallbackUrl}'"/>
                    
                    <span class="absolute top-1 right-1 w-2 h-2 rounded-full shadow-lg ${rarityClass}"></span>
                </div>
            `;
        }).join('');
    }

    // --- Updated Function: Handle Code Redemption (Uses Firestore Transaction for Atomicity) ---
    async function handleRedeem() {
        // Check for Firebase initialization and game readiness
        if (!db || !IS_AUTH_READY || isLoading || !CATEGORY_ID) {
            redeemMessage.textContent = "App not ready or database is inaccessible.";
            redeemMessage.className = "text-xs text-center mt-1 h-4 text-red-500 font-semibold";
            setTimeout(() => { redeemMessage.textContent = ''; }, 3000);
            return;
        }

        const code = redeemInput.value.trim().toUpperCase();
        
        // 1. Basic validation
        if (!SINGLE_USE_CODES.includes(code)) {
            redeemMessage.textContent = "âŒ Invalid Code for this category!";
            redeemMessage.className = "text-xs text-center mt-1 h-4 text-red-500 font-semibold";
            setTimeout(() => { redeemMessage.textContent = ''; }, 3000);
            return;
        }

        isLoading = true;
        redeemButton.disabled = true;
        redeemMessage.textContent = "Checking code...";
        redeemMessage.className = "text-xs text-center mt-1 h-4 text-yellow-500 font-semibold";

        try {
            const globalDocRef = getGlobalCodesDocRef();
            const userDocRef = getDrawCollectionDocRef();
            let wasSuccessful = false;

            // Use a transaction to ensure that checking the code's status and updating 
            // both the global list and the user's draws is atomic.
            await firebase.runTransaction(db, async (transaction) => {
                const globalDoc = await transaction.get(globalDocRef);
                
                // Get the list of codes already used globally
                let usedCodes = globalDoc.exists() ? globalDoc.data().codes || [] : [];
                
                if (usedCodes.includes(code)) {
                    // Code is already used. Abort transaction by throwing an identifiable error.
                    throw new Error("CODE_ALREADY_USED");
                }

                // --- CRITICAL STEP: Atomic Update ---
                
                // 1. Atomically mark code as used globally by adding it to the array
                // We use arrayUnion for safety, but in a transaction context, this ensures it's added.
                transaction.update(globalDocRef, { 
                    codes: firebase.arrayUnion(code),
                    lastUpdate: firebase.serverTimestamp()
                }, { merge: true });

                // 2. Update user's draws
                const userDoc = await transaction.get(userDocRef);
                let currentDrawsInDB = userDoc.exists() ? userDoc.data().draws || INITIAL_DRAWS : INITIAL_DRAWS;
                
                // Set the user's draw count
                transaction.set(userDocRef, { 
                    draws: currentDrawsInDB + CODE_REFILL_AMOUNT,
                    collectedFigures: userDoc.exists() ? userDoc.data().collectedFigures || [] : [],
                    lastUpdate: firebase.serverTimestamp()
                }, { merge: true });

                wasSuccessful = true;
            });
            
            if (wasSuccessful) {
                // The transaction succeeded, so the draws will update via onSnapshot
                redeemMessage.textContent = `âœ… Success! Added ${CODE_REFILL_AMOUNT} draws.`;
                redeemMessage.className = "text-xs text-center mt-1 h-4 text-green-500 font-semibold";
                redeemInput.value = ''; // Clear input after success
            }
            
        } catch (error) {
            if (error.message === "CODE_ALREADY_USED") {
                redeemMessage.textContent = "âŒ Code already used globally!";
                redeemMessage.className = "text-xs text-center mt-1 h-4 text-red-500 font-semibold";
            } else {
                console.error("Redemption failed:", error);
                redeemMessage.textContent = "âŒ Server error during redemption. Try again.";
                redeemMessage.className = "text-xs text-center mt-1 h-4 text-red-500 font-semibold";
            }
        } finally {
            isLoading = false;
            redeemButton.disabled = false;
            updateDrawCountUI();
            setTimeout(() => { redeemMessage.textContent = ''; }, 3000);
        }
    }

    // --- Main Draw Logic ---

    function displayDrawResults(results) {
        if(initialMessage) initialMessage.remove(); 

        const isMultiDraw = results.length > 1;
        
        const resultTitle = isMultiDraw 
            ? `RESULTS (${results.length} FIGURES DRAWN)` 
            : 'YOUR MYSTERY RESULT';
        
        let containerClass = "flex flex-col items-center justify-center p-4 w-full";
        let cardClass = "result-card p-4 bg-gray-700 rounded-xl shadow-2xl w-full max-w-xs border-b-8";
        
        if (isMultiDraw) {
            containerClass = "grid grid-cols-2 gap-2 p-1 w-full"; 
            cardClass = "result-card flex flex-col items-center p-1 bg-gray-700 rounded-lg shadow-md border-b-4 text-xs";
        }

        resultArea.innerHTML = `
            <div class="w-full">
                <h3 class="text-lg font-extrabold text-white text-center mb-3 border-b-2 border-yellow-500 pb-2">${resultTitle}</h3>
                <div id="results-grid" class="${containerClass}"></div>
            </div>
        `;
        const resultsGrid = document.getElementById('results-grid');

        results.forEach((result, index) => {
            const figure = result.figure;
            const isNewFigure = result.isNew;
            
            const borderColorClass = figure.color ? `border-${figure.color}` : 'border-yellow-500';
            const rarityClass = `rarity-${figure.rarity.toLowerCase().replace(' ', '-')} `;
            
            const figureImageUrl = figure.image_url;
            const fallbackUrl = getPlaceholderUrl(figure); 

            let titleText;
            let titleClass;
            let titleBadge; 

            if (isNewFigure) {
                titleText = 'NEW FIGURE!';
                titleClass = 'text-green-400';
                titleBadge = `<span class="new-badge absolute top-0 left-0 text-[8px] font-bold px-1.5 py-0.5 rounded-br-lg rounded-tl-lg uppercase">NEW</span>`;
            } else {
                const isCollectionFull = collectedFigures.length >= MINIFIGURES.length;
                titleText = isCollectionFull ? 'COLLECTION COMPLETE!' : 'DUPLICATE!';
                titleClass = isCollectionFull ? 'text-yellow-400' : 'text-red-400';
                titleBadge = ''; 
            }
            
            const imageContainerClass = isMultiDraw ? 
                'w-full aspect-square p-1 mb-1 bg-gray-800 rounded-md shadow-inner border border-gray-600 flex items-center justify-center' :
                'w-full aspect-square p-4 mb-4 bg-gray-700 rounded-xl shadow-inner border-4 border-yellow-500 flex items-center justify-center';


            const cardHtml = `
                <div style="animation-delay: ${index * 50}ms;" class="${cardClass} ${borderColorClass} relative">
                    <div class="w-full text-center">
                        <p class="font-bold mb-1 uppercase tracking-wider ${titleClass} text-[10px]">${titleText}</p>
                    </div>

                    <div class="${imageContainerClass}">
                        <img src="${figureImageUrl}" alt="${figure.name}" class="w-full h-full object-contain rounded-md" 
                             onerror="this.onerror=null; this.src='${fallbackUrl}'"/>
                        ${titleBadge}
                    </div>
                    
                    <h4 class="font-bold text-gray-200 text-center truncate w-full mb-1">${figure.name}</h4>
                    <span class="mt-1 px-2 py-0.5 text-[10px] font-bold rounded-full text-gray-900 shadow-md ${rarityClass}">
                        ${figure.rarity.toUpperCase()}
                    </span>
                    
                </div>
            `;
            resultsGrid.insertAdjacentHTML('beforeend', cardHtml);
        });

        // Reset loading state
        isLoading = false;
        updateDrawCountUI();
    }


    async function handleDraw(count) {
        if (isLoading || currentDraws < count || !IS_GAME_READY) return;
        
        isLoading = true;
        updateDrawCountUI(); 
        
        if(initialMessage) initialMessage.remove(); 

        // 1. Deduct draws first (triggers real-time UI update via onSnapshot)
        // If DB is null, currentDraws is local and will be updated, but not saved.
        await updateDrawCount(currentDraws - count);

        resultArea.innerHTML = `
            <div id="mystery-box" class="loading-animation w-32 h-32 rounded-xl flex items-center justify-center shadow-inner border-4 border-white">
                <span class="text-6xl text-gray-900" role="img" aria-label="Mystery Box">ðŸ“¦</span>
            </div>
        `;

        // Wait for suspense (1.5 seconds)
        setTimeout(async () => {
            const drawResults = [];

            for (let i = 0; i < count; i++) {
                let drawnFigure = weightedDraw();
                if (!drawnFigure) continue; // Should not happen

                // 2. Check if it's new and save if it is
                // We rely on saveCollection to update Firestore and the onSnapshot listener 
                // to update the local collectedFigures array correctly. If Firestore is down, 
                // isNew check is based on the current in-memory collection.
                const isNew = await saveCollection(drawnFigure.image_url);

                // 3. Log the final result for display
                drawResults.push({
                    figure: drawnFigure,
                    isNew: isNew,
                });
            }
            
            // Note: Displaying the results happens *before* the Firestore updates confirm, 
            // but the collection display relies on the listener which should update quickly.
            displayDrawResults(drawResults);

        }, 1500); 
    }
    
    // --- Initialization ---

    function initGame() {
        // Start Firebase setup and authentication
        setupFirebase();
        
        // Start the real-time clock update
        updateCambodiaTime();
        setInterval(updateCambodiaTime, 1000); 
        
        // Attach event listeners
        if (draw1xButton) {
            draw1xButton.addEventListener('click', () => handleDraw(1));
        }
        if (draw5xButton) {
            draw5xButton.addEventListener('click', () => handleDraw(5));
        }
        
        if (redeemButton) {
            redeemButton.addEventListener('click', handleRedeem);
        }
        if (redeemInput) {
             redeemInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleRedeem();
                }
            });
        }
        
        if (resetCollectionButton) {
            resetCollectionButton.addEventListener('click', resetCollection);
        }

        updateDrawCountUI();
    }

    document.addEventListener('DOMContentLoaded', initGame);
</script>
</body>
</html>

