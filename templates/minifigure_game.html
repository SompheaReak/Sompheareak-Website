<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minifigure Mystery Draw 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Inter:wght@300;400;600;800;900&display=swap');
        
        :root {
            --theme-primary: #C80815;
            --theme-secondary: #FFC300;
            --theme-bg: #111827;
            --theme-panel: #1f2937;
            --card-back: linear-gradient(135deg, #4b0005, #8a000a);
        }

        body[data-theme="ninjago"] {
            --theme-primary: #C80815; 
            --theme-secondary: #FFC300; 
            --theme-bg: #0f0505; 
            --theme-panel: #1f0f0f;
            --card-back: linear-gradient(135deg, #4b0005, #8a000a);
        }

        body[data-theme="lego"] {
            --theme-primary: #0055BF; 
            --theme-secondary: #FFCF00; 
            --theme-bg: #050b14; 
            --theme-panel: #0f172a;
            --card-back: linear-gradient(135deg, #003785, #0055BF);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--theme-bg); color: white; transition: background-color 0.5s ease; }

        /* Rarity */
        .rarity-common { color: #d1d5db; border-color: #d1d5db; background: linear-gradient(135deg, #9ca3af, #6b7280); }
        .rarity-uncommon { color: #4ade80; border-color: #4ade80; background: linear-gradient(135deg, #22c55e, #166534); }
        .rarity-rare { color: #60a5fa; border-color: #60a5fa; background: linear-gradient(135deg, #3b82f6, #1e40af); }
        .rarity-epic { color: #c084fc; border-color: #c084fc; background: linear-gradient(135deg, #a855f7, #6b21a8); }
        .rarity-legendary { color: #facc15; border-color: #facc15; background: linear-gradient(135deg, #eab308, #854d0e); box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); }

        /* Animations */
        .perspective-1000 { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 0.75rem; }
        .card-front { background: var(--card-back); display: flex; align-items: center; justify-content: center; border: 2px solid var(--theme-secondary); }
        .card-back { transform: rotateY(180deg); background-color: #374151; }
        .flipped .card-inner { transform: rotateY(180deg); }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-5deg); } 75% { transform: translateX(5px) rotate(5deg); } }
        .animate-shake { animation: shake 0.3s ease-in-out infinite; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .theme-text { color: var(--theme-secondary); }
        .theme-bg-panel { background-color: var(--theme-panel); }
        .theme-btn { background-color: var(--theme-primary); transition: all 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .theme-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: none; }
        .theme-btn:disabled { background-color: #4b5563; box-shadow: none; cursor: not-allowed; opacity: 0.6; }
        .sold-out-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
        .sold-out-stamp { border: 2px solid #ef4444; color: #ef4444; transform: rotate(-15deg); text-transform: uppercase; font-weight: 900; padding: 0.25rem 0.5rem; font-size: 0.7rem; letter-spacing: 0.1em; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body data-theme="ninjago" class="h-screen overflow-hidden flex flex-col items-center">

    <!-- TOP BAR -->
    <div class="w-full max-w-md p-4 flex justify-between items-center z-20 bg-opacity-90 backdrop-blur-sm fixed top-0 left-1/2 -translate-x-1/2">
        <a href="index.html" class="flex items-center gap-1 text-gray-400 hover:text-white text-xs font-bold uppercase tracking-widest">
             <i class="fa-solid fa-chevron-left"></i> Home
        </a>
        <div class="flex space-x-1 bg-gray-900/80 p-1 rounded-full border border-gray-700">
            <button onclick="switchCategory('ninjago')" id="nav-ninjago" class="px-3 py-1.5 rounded-full text-[10px] font-bold uppercase transition-all bg-red-700 text-white">Ninjago</button>
            <button onclick="switchCategory('lego')" id="nav-lego" class="px-3 py-1.5 rounded-full text-[10px] font-bold uppercase transition-all text-gray-400">LEGO City</button>
        </div>
        <button onclick="toggleInfo()" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition">
            <i class="fa-solid fa-info text-gray-300 text-xs"></i>
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="w-full max-w-md h-full pt-20 pb-24 px-4 overflow-y-auto no-scrollbar relative" id="main-scroll">
        <div class="text-center mb-6">
            <h1 id="theme-title" class="text-4xl font-['Bungee_Inline'] theme-text drop-shadow-lg tracking-wider">NINJAGO</h1>
            <p class="text-[10px] text-gray-400 font-bold tracking-[0.4em] uppercase">Mystery Collection</p>
            <div class="mt-1 font-mono text-[9px] text-gray-500">Player ID: <span id="player-id" class="text-gray-300">...</span></div>
        </div>

        <div class="theme-bg-panel rounded-2xl p-4 shadow-lg border border-gray-700/50 mb-6 flex justify-between items-center relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-white opacity-5 rounded-full blur-xl"></div>
            <div>
                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Your Draws</p>
                <div class="flex items-baseline"><span id="draw-balance" class="text-3xl font-black text-white">0</span><span class="text-sm ml-1">üéüÔ∏è</span></div>
            </div>
            <div class="text-right">
                <p id="clock" class="text-[9px] font-mono text-gray-500 mb-1">00:00:00</p>
                <button onclick="openRedeem()" class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold uppercase rounded shadow-md transition">Redeem Code</button>
            </div>
        </div>

        <!-- TAB: PLAY -->
        <div id="view-play" class="transition-opacity duration-300">
            <div id="stage" class="w-full aspect-square theme-bg-panel rounded-xl border-2 border-dashed border-gray-700 mb-4 relative flex items-center justify-center overflow-hidden">
                <div id="stage-idle" class="text-center"><div class="text-6xl mb-2 animate-bounce">üì¶</div><p class="text-xs text-gray-400 font-bold uppercase">Ready to Open</p></div>
                <div id="stage-loading" class="hidden absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-10">
                    <div class="w-24 h-24 rounded-xl border-4 border-white shadow-[0_0_30px_rgba(255,255,255,0.3)] flex items-center justify-center animate-shake bg-gray-800"><span class="text-4xl">‚ùì</span></div>
                </div>
                <div id="stage-result" class="hidden absolute inset-0 p-4 grid gap-2 overflow-y-auto content-center"></div>
                <div id="stage-empty" class="hidden absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="text-5xl mb-3">üèÜ</div><h3 class="text-xl font-black text-yellow-500 mb-1">COMPLETE!</h3><p class="text-xs text-gray-400">You own everything.</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="draw(1)" id="btn-draw-1" class="theme-btn py-3 rounded-xl font-bold uppercase text-xs tracking-wider" disabled>Draw 1x</button>
                <button onclick="draw(5)" id="btn-draw-5" class="theme-btn py-3 rounded-xl font-bold uppercase text-xs tracking-wider" disabled>Draw 5x</button>
            </div>
            <p id="draw-info-msg" class="text-center text-[10px] text-gray-500 mt-2 h-4"></p>
        </div>

        <!-- TAB: CATALOG -->
        <div id="view-catalog" class="hidden animate-pop">
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-sm font-bold uppercase tracking-widest text-gray-300">Product Catalog</h2>
                <span class="text-[10px] theme-text font-mono"><span id="cat-collected">0</span>/<span id="cat-total">0</span> Collected</span>
            </div>
            <div id="catalog-grid" class="grid grid-cols-3 gap-2 pb-20"></div>
        </div>
    </div>

    <div class="fixed bottom-4 w-[90%] max-w-md bg-gray-900/90 backdrop-blur-md border border-gray-700 rounded-full p-2 flex justify-around shadow-2xl z-30">
        <button onclick="switchView('play')" id="tab-play" class="flex-1 py-2 rounded-full text-xs font-bold uppercase text-white bg-gray-800 shadow-md transition-all">Play</button>
        <button onclick="switchView('catalog')" id="tab-catalog" class="flex-1 py-2 rounded-full text-xs font-bold uppercase text-gray-500 hover:text-white transition-all">Catalog</button>
    </div>

    <!-- MODALS -->
    <div id="modal-info" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-300" onclick="toggleInfo()">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl border border-gray-700 p-6 shadow-2xl transform scale-95 transition-transform" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black text-white mb-4 uppercase text-center">Remaining Rates</h3>
            <div class="space-y-3 mb-6">
                <div class="flex items-center justify-between text-xs"><span class="px-2 py-0.5 rounded text-black font-bold rarity-common">COMMON</span><span class="font-mono text-gray-400">Rate: <span id="rate-common">0%</span></span></div>
                <div class="flex items-center justify-between text-xs"><span class="px-2 py-0.5 rounded text-black font-bold rarity-uncommon">UNCOMMON</span><span class="font-mono text-gray-400">Rate: <span id="rate-uncommon">0%</span></span></div>
                <div class="flex items-center justify-between text-xs"><span class="px-2 py-0.5 rounded text-white font-bold rarity-rare">RARE</span><span class="font-mono text-gray-400">Rate: <span id="rate-rare">0%</span></span></div>
                <div class="flex items-center justify-between text-xs"><span class="px-2 py-0.5 rounded text-white font-bold rarity-epic">EPIC</span><span class="font-mono text-gray-400">Rate: <span id="rate-epic">0%</span></span></div>
                <div class="flex items-center justify-between text-xs"><span class="px-2 py-0.5 rounded text-black font-bold rarity-legendary">LEGENDARY</span><span class="font-mono text-gray-400">Rate: <span id="rate-legendary">0%</span></span></div>
            </div>
            <button onclick="resetAllData()" class="w-full mt-4 py-2 border border-red-900 text-red-500 text-xs hover:bg-red-900/20 rounded">Reset All Data</button>
        </div>
    </div>

    <div id="modal-redeem" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-300" onclick="closeRedeem()">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl border border-gray-700 p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-white mb-2 uppercase text-center">Redeem Code</h3>
            <input type="text" id="redeem-input" placeholder="e.g. NINJA1" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-center text-white uppercase font-bold tracking-widest mb-3 focus:border-yellow-500 outline-none">
            <button onclick="handleRedeem()" class="w-full theme-btn text-white font-bold py-3 rounded-xl uppercase text-sm">Submit</button>
            <p id="redeem-msg" class="text-center text-xs mt-3 h-4 font-bold"></p>
        </div>
    </div>

<script>
    const RARITY = { COMMON: { id: 'common', label: 'Common', weight: 100 }, UNCOMMON: { id: 'uncommon', label: 'Uncommon', weight: 60 }, RARE: { id: 'rare', label: 'Rare', weight: 30 }, EPIC: { id: 'epic', label: 'Epic', weight: 10 }, LEGENDARY: { id: 'legendary', label: 'Legendary', weight: 2 } };
    const INITIAL_NINJAGO = [{ id: 'n1', name: "Kai (Fire)", rarity: 'COMMON', stock: 50, color: 'red' }, { id: 'n2', name: "Jay (Lightning)", rarity: 'COMMON', stock: 50, color: 'blue' }, { id: 'n3', name: "Cole (Earth)", rarity: 'COMMON', stock: 50, color: 'gray' }, { id: 'n4', name: "Zane (Ice)", rarity: 'UNCOMMON', stock: 30, color: 'white' }, { id: 'n5', name: "Lloyd (Green)", rarity: 'RARE', stock: 15, color: 'green' }, { id: 'n6', name: "Lord Garmadon", rarity: 'EPIC', stock: 5, color: 'purple' }, { id: 'n7', name: "Golden Wu", rarity: 'LEGENDARY', stock: 1, color: 'yellow' }, { id: 'n8', name: "Nya (Water)", rarity: 'UNCOMMON', stock: 30, color: 'blue' }, { id: 'n9', name: "Pythor", rarity: 'RARE', stock: 10, color: 'purple' }, { id: 'n10', name: "Samurai X", rarity: 'EPIC', stock: 5, color: 'red' }];
    const INITIAL_LEGO = [{ id: 'l1', name: "Police Officer", rarity: 'COMMON', stock: 50, color: 'blue' }, { id: 'l2', name: "Firefighter", rarity: 'COMMON', stock: 50, color: 'red' }, { id: 'l3', name: "Robber", rarity: 'COMMON', stock: 50, color: 'gray' }, { id: 'l4', name: "Construction Worker", rarity: 'UNCOMMON', stock: 30, color: 'orange' }, { id: 'l5', name: "Doctor", rarity: 'UNCOMMON', stock: 30, color: 'white' }, { id: 'l6', name: "Spaceman", rarity: 'RARE', stock: 15, color: 'blue' }, { id: 'l7', name: "Deep Sea Diver", rarity: 'EPIC', stock: 5, color: 'red' }, { id: 'l8', name: "Mr. Gold", rarity: 'LEGENDARY', stock: 1, color: 'yellow' }, { id: 'l9', name: "Pizza Guy", rarity: 'RARE', stock: 10, color: 'white' }];
    const CODES = { 'NINJA': [1,2,3,4,5].map(n=>`NINJA${n}`), 'LEGO': [1,2,3,4,5].map(n=>`LEGO${n}`) };

    let STATE = { userId: null, category: 'ninjago', view: 'play', balances: { ninjago: 0, lego: 0 }, inventory: { ninjago: [], lego: [] }, stock: { ninjago: {}, lego: {} }, usedCodes: [] };

    function init() {
        let uid = localStorage.getItem('mmd3_uid'); if (!uid) { uid = Math.floor(Math.random()*90000+10000).toString(); localStorage.setItem('mmd3_uid', uid); }
        STATE.userId = uid; document.getElementById('player-id').innerText = uid;
        const saved = localStorage.getItem(`mmd3_data_${uid}`);
        if (saved) { STATE = { ...STATE, ...JSON.parse(saved) }; } else { INITIAL_NINJAGO.forEach(i => STATE.stock.ninjago[i.id] = i.stock); INITIAL_LEGO.forEach(i => STATE.stock.lego[i.id] = i.stock); }
        switchCategory('ninjago');
        setInterval(() => { const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { timeZone: 'Asia/Phnom_Penh', hour12: false }); }, 1000);
    }
    function save() { localStorage.setItem(`mmd3_data_${STATE.userId}`, JSON.stringify({ balances: STATE.balances, inventory: STATE.inventory, stock: STATE.stock, usedCodes: STATE.usedCodes })); renderUI(); }
    
    function switchCategory(cat) {
        STATE.category = cat; document.body.setAttribute('data-theme', cat);
        document.getElementById('nav-ninjago').className = cat === 'ninjago' ? "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase bg-red-700 text-white" : "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase text-gray-400";
        document.getElementById('nav-lego').className = cat === 'lego' ? "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase bg-blue-600 text-white" : "px-3 py-1.5 rounded-full text-[10px] font-bold uppercase text-gray-400";
        document.getElementById('theme-title').innerText = cat === 'ninjago' ? "NINJAGO" : "LEGO CITY";
        renderUI();
    }
    function switchView(v) {
        STATE.view = v;
        const active = "flex-1 py-2 rounded-full text-xs font-bold uppercase text-white bg-gray-800 shadow-md"; const inactive = "flex-1 py-2 rounded-full text-xs font-bold uppercase text-gray-500 hover:text-white";
        document.getElementById('tab-play').className = v === 'play' ? active : inactive; document.getElementById('tab-catalog').className = v === 'catalog' ? active : inactive;
        if(v==='play') { document.getElementById('view-play').classList.remove('hidden'); document.getElementById('view-catalog').classList.add('hidden'); }
        else { document.getElementById('view-play').classList.add('hidden'); document.getElementById('view-catalog').classList.remove('hidden'); renderCatalog(); }
    }
    function renderUI() {
        const bal = STATE.balances[STATE.category]; const pool = STATE.category === 'ninjago' ? INITIAL_NINJAGO : INITIAL_LEGO; const owned = STATE.inventory[STATE.category]; const stock = STATE.stock[STATE.category];
        document.getElementById('draw-balance').innerText = bal;
        const availableItems = pool.filter(i => !owned.includes(i.id) && stock[i.id] > 0);
        const isComplete = pool.length === owned.length; const isSoldOut = !isComplete && availableItems.length === 0;
        const btn1=document.getElementById('btn-draw-1'), btn5=document.getElementById('btn-draw-5'), msg=document.getElementById('draw-info-msg'), idle=document.getElementById('stage-idle'), empty=document.getElementById('stage-empty');
        if(isComplete) { btn1.disabled=true; btn5.disabled=true; btn1.innerText="COMPLETE"; btn5.innerText="COMPLETE"; msg.innerText="Complete!"; idle.classList.add('hidden'); empty.classList.remove('hidden'); empty.querySelector('h3').innerText="COMPLETE!"; empty.querySelector('p').innerText="You own everything."; }
        else if(isSoldOut) { btn1.disabled=true; btn5.disabled=true; btn1.innerText="SOLD OUT"; btn5.innerText="SOLD OUT"; msg.innerText="Out of stock."; idle.classList.add('hidden'); empty.classList.remove('hidden'); empty.querySelector('h3').innerText="SOLD OUT"; empty.querySelector('p').innerText="No packs available."; }
        else { btn1.disabled=bal<1; btn5.disabled=bal<5 && availableItems.length >= 5; btn1.innerText="Draw 1x"; btn5.innerText=availableItems.length<5?`Draw ${availableItems.length}x`:"Draw 5x"; if(availableItems.length<5) btn5.disabled=bal<availableItems.length; msg.innerText=""; idle.classList.remove('hidden'); empty.classList.add('hidden'); }
        document.getElementById('cat-collected').innerText = owned.length; document.getElementById('cat-total').innerText = pool.length; calculateRates(availableItems);
    }
    function calculateRates(items) {
        if(!items) { const pool=STATE.category==='ninjago'?INITIAL_NINJAGO:INITIAL_LEGO; items=pool.filter(i=>!STATE.inventory[STATE.category].includes(i.id)&&STATE.stock[STATE.category][i.id]>0); }
        const totalW = items.reduce((s,i)=>s+RARITY[i.rarity].weight,0); const rates={COMMON:0,UNCOMMON:0,RARE:0,EPIC:0,LEGENDARY:0};
        if(totalW>0) items.forEach(i=>rates[i.rarity]+=RARITY[i.rarity].weight);
        for(let r in rates) { const el=document.getElementById(`rate-${r.toLowerCase()}`); if(el) el.innerText = totalW===0?`0%`:((rates[r]/totalW)*100).toFixed(1)+'%'; }
    }
    async function draw(n) {
        if(STATE.balances[STATE.category]<1) return;
        document.getElementById('stage-idle').classList.add('hidden'); document.getElementById('stage-loading').classList.remove('hidden');
        await new Promise(r=>setTimeout(r,1000));
        const res=[], pool=STATE.category==='ninjago'?INITIAL_NINJAGO:INITIAL_LEGO;
        let inv=[...STATE.inventory[STATE.category]], stk={...STATE.stock[STATE.category]}, count=0;
        for(let i=0;i<n;i++) {
            const avail=pool.filter(item=>stk[item.id]>0 && !inv.includes(item.id)); if(avail.length===0) break;
            const totalW=avail.reduce((a,x)=>a+RARITY[x.rarity].weight,0); let rnd=Math.random()*totalW, picked=avail[0];
            for(let x of avail){ if(rnd<RARITY[x.rarity].weight){picked=x;break;} rnd-=RARITY[x.rarity].weight; }
            stk[picked.id]--; inv.push(picked.id); count++; res.push({item:picked,isNew:true});
        }
        if(count>0){ STATE.balances[STATE.category]-=count; STATE.stock[STATE.category]=stk; STATE.inventory[STATE.category]=inv; save(); } else { renderUI(); }
        document.getElementById('stage-loading').classList.add('hidden');
        const grid=document.getElementById('stage-result'); grid.classList.remove('hidden'); grid.innerHTML='';
        grid.className=res.length===1?"absolute inset-0 flex items-center justify-center p-8":"absolute inset-0 p-2 grid grid-cols-2 gap-2 content-center overflow-y-auto";
        res.forEach((r,i)=>{
            const c=document.createElement('div'); c.className=res.length===1?"perspective-1000 w-48 h-64":"perspective-1000 w-full h-40";
            c.innerHTML=`<div class="card-inner w-full h-full relative shadow-xl"><div class="card-face card-front z-10"><div class="text-4xl">‚ùì</div></div><div class="card-face card-back theme-bg-panel border-2 border-yellow-400 flex flex-col p-2 overflow-hidden rounded-xl"><div class="absolute top-0 right-0 bg-yellow-500 text-black text-[8px] font-bold px-2 py-0.5 rounded-bl z-20">NEW</div><div class="flex-1 bg-gray-900/50 rounded-lg flex items-center justify-center mb-2 overflow-hidden relative"><div class="absolute inset-0 opacity-20 rarity-${r.item.rarity.toLowerCase()}"></div><img src="https://placehold.co/150x150/333/fff?text=${r.item.name.charAt(0)}" class="w-full h-full object-contain z-10"></div><div class="text-center"><span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase tracking-wider rarity-${r.item.rarity.toLowerCase()} text-white border mb-1 inline-block">${RARITY[r.item.rarity].label}</span><div class="text-xs font-bold truncate text-white leading-tight">${r.item.name}</div></div></div></div>`;
            c.style.opacity='0'; c.style.animation=`pop 0.5s cubic-bezier(0.175,0.885,0.32,1.275) forwards ${i*0.1}s`; grid.appendChild(c);
            setTimeout(()=>c.classList.add('flipped'),100+(i*100));
        });
    }
    function renderCatalog(){
        const g=document.getElementById('catalog-grid'); g.innerHTML=''; const pool=STATE.category==='ninjago'?INITIAL_NINJAGO:INITIAL_LEGO;
        pool.forEach(i=>{
            const own=STATE.inventory[STATE.category].includes(i.id), s=STATE.stock[STATE.category][i.id]||0;
            const el=document.createElement('div'); el.className=`relative aspect-[3/4] theme-bg-panel rounded-lg border border-gray-700 overflow-hidden flex flex-col ${own?'border-'+i.color+'-500':'opacity-80 grayscale'}`;
            el.innerHTML=`<div class="absolute top-1 left-1 z-20 bg-black/60 px-1.5 py-0.5 rounded text-[8px] font-mono ${s<5?'text-red-400':'text-gray-300'}">Stock: ${s}</div><div class="flex-1 relative flex items-center justify-center bg-gray-800"><img src="https://placehold.co/100x100/333/fff?text=${i.name.charAt(0)}" class="w-full h-full object-cover opacity-80">${s===0&&!own?'<div class="absolute inset-0 sold-out-overlay flex items-center justify-center"><div class="sold-out-stamp">SOLD OUT</div></div>':''}</div><div class="p-1.5 text-center bg-gray-900 border-t border-gray-800"><div class="w-2 h-2 rounded-full mx-auto mb-1 rarity-${i.rarity.toLowerCase()}"></div><div class="text-[9px] font-bold truncate leading-tight text-gray-300">${i.name}</div></div>${own?'<div class="absolute bottom-1 right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900 z-20"></div>':''}`;
            g.appendChild(el);
        });
    }
    function toggleInfo(){const m=document.getElementById('modal-info');if(m.classList.contains('hidden')){m.classList.remove('hidden');setTimeout(()=>{m.classList.remove('opacity-0');m.children[0].classList.remove('scale-95');},10);renderUI();}else{m.classList.add('opacity-0');m.children[0].classList.add('scale-95');setTimeout(()=>m.classList.add('hidden'),300);}}
    function openRedeem(){const m=document.getElementById('modal-redeem');m.classList.remove('hidden');setTimeout(()=>m.classList.remove('opacity-0'),10);}
    function closeRedeem(){const m=document.getElementById('modal-redeem');m.classList.add('opacity-0');setTimeout(()=>m.classList.add('hidden'),300);}
    function handleRedeem(){
        const inp=document.getElementById('redeem-input'), msg=document.getElementById('redeem-msg'), c=inp.value.trim().toUpperCase();
        if(STATE.usedCodes.includes(c)){msg.innerText="Code used!";msg.className="text-center text-xs mt-3 h-4 font-bold text-red-500";return;}
        if(CODES.NINJA.includes(c)){STATE.balances.ninjago+=5;STATE.usedCodes.push(c);msg.innerText="+5 Ninja Draws";msg.className="text-green-500 font-bold text-xs mt-3";if(STATE.category!=='ninjago')switchCategory('ninjago');}
        else if(CODES.LEGO.includes(c)){STATE.balances.lego+=5;STATE.usedCodes.push(c);msg.innerText="+5 Lego Draws";msg.className="text-green-500 font-bold text-xs mt-3";if(STATE.category!=='lego')switchCategory('lego');}
        else{msg.innerText="Invalid Code";msg.className="text-red-500 font-bold text-xs mt-3";}
        save();setTimeout(()=>{closeRedeem();inp.value='';msg.innerText='';},1500);
    }
    function resetAllData(){if(confirm("Reset?")){localStorage.removeItem(`mmd3_data_${STATE.userId}`);location.reload();}}
    window.onload=init;
</script>
</body>
</html>

