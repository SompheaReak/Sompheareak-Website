<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minifigure Mystery Draw</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Inter:wght@100..900&display=swap');
        
        :root {
            --lego-yellow: #FFC300;
            --lego-red: #C80815;
        }
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Keyframes for the shaking/loading animation */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-2px, -3px) rotate(-1deg); }
            20% { transform: translate(3px, 0px) rotate(1deg); }
            30% { transform: translate(-3px, 2px) rotate(0deg); }
            40% { transform: translate(2px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 3px) rotate(-1deg); }
            60% { transform: translate(3px, 1px) rotate(0deg); }
            70% { transform: translate(-2px, -2px) rotate(-1deg); }
            80% { transform: translate(1px, 0px) rotate(1deg); }
            90% { transform: translate(-3px, 3px) rotate(0deg); }
            100% { transform: translate(1px, -1px) rotate(-1deg); }
        }

        .loading-animation {
            animation: shake 0.15s infinite;
            background-color: var(--lego-yellow);
            box-shadow: 0 0 20px rgba(255, 195, 0, 0.7);
        }

        /* Styles for individual result cards within the multi-draw */
        .result-card {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
            transform: scale(0.7);
            opacity: 0;
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Custom style for the rarity badge background */
        .rarity-common { background-color: #3b82f6; color: white; } /* Blue */
        .rarity-rare { background-color: #f59e0b; color: #333; } /* Amber */
        .rarity-super-rare { background-color: #ef4444; color: white; } /* Red */
        .rarity-ultra-rare { background-color: #a855f7; color: white; } /* Purple */

        .draw-button-style {
            box-shadow: 0 5px 0 0 #A80008;
            transform: translateY(0);
            transition: all 0.1s ease-out;
        }
        .draw-button-style:active:not(:disabled) {
            transform: translateY(5px);
            box-shadow: 0 0 0 0 #A80008;
        }
        .draw-button-style:disabled {
            box-shadow: 0 0 0 0 #4B5563;
        }
        
        /* Styles for the Collection grid items */
        .collection-item {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .collection-item:hover {
            transform: scale(1.05);
        }
        .collected {
            filter: none;
            opacity: 1;
            border: 2px solid var(--lego-yellow);
        }
        .missing {
            filter: grayscale(100%) brightness(50%);
            opacity: 0.6;
            border: 2px dashed #4B5563;
            position: relative;
            cursor: default; /* Not clickable */
        }
        .missing:after {
            content: '?';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen bg-gray-900 flex flex-col items-center">

    <!-- Back Button - Placeholder as per template -->
    <a href="#" class="self-start text-yellow-500 hover:text-yellow-400 mb-4 flex items-center transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
        Back to Home
    </a>
    
    <div id="minifigure-app" class="w-full max-w-sm bg-gray-800 border-4 border-yellow-500 shadow-2xl p-6 rounded-xl relative overflow-hidden">
        
        <!-- Header -->
        <h1 class="text-3xl font-black text-yellow-500 text-center mb-4 uppercase tracking-wider font-['Bungee_Inline']">
            Mystery Draw!
        </h1>

        <!-- Draw Count Info -->
        <div class="flex justify-between items-center mb-4 p-3 rounded-lg bg-gray-700 shadow-inner border border-gray-600">
            <span class="text-lg font-semibold text-gray-300">Draws Available:</span>
            <span id="draw-count" class="text-3xl font-extrabold text-red-500 drop-shadow-lg">...</span>
        </div>
        
        <!-- Cambodia Date & Time Display -->
        <div id="datetime-display" class="mb-6 p-2 text-center rounded-lg bg-gray-700 border border-gray-600">
            <!-- Content filled by JavaScript -->
            <p class="text-sm font-semibold text-gray-400">Loading Cambodia Time...</p>
        </div>

        <!-- Result Area (dynamically filled by JS) -->
        <div id="result-area" class="mt-4 min-h-[150px] flex items-center justify-center">
            <div id="initial-message" class="text-center p-4 text-gray-400">
                <p class="mb-2 text-lg font-semibold">Will you find the Ultra Rare?</p>
                <p class="text-sm">Click a button to open your new blind box!</p>
            </div>
        </div>

        <!-- NEW Draw Buttons Container -->
        <div class="flex space-x-3 mt-6">
            <button id="draw-1x-button" class="w-1/2 py-4 text-xl font-bold bg-red-600 hover:bg-red-700 text-white rounded-xl transition duration-150 uppercase draw-button-style" disabled>
                Open 1x (1 Draw)
            </button>
            <button id="draw-5x-button" class="w-1/2 py-4 text-xl font-bold bg-red-700 hover:bg-red-800 text-white rounded-xl transition duration-150 uppercase draw-button-style" disabled>
                Open 5x (5 Draws)
            </button>
        </div>

        <!-- Refill Draws Button (using localStorage - DEMO WARNING) -->
        <button id="refill-button" class="w-full py-2 text-xs font-semibold bg-gray-700 hover:bg-gray-600 text-gray-400 rounded-xl shadow transition duration-200 mt-3 border border-gray-600">
            [DEMO MODE] Reset Draws to 5
        </button>

        <!-- Reset Collection Button -->
        <button id="reset-collection-button" class="w-full py-2 text-xs font-semibold bg-gray-700 hover:bg-gray-600 text-gray-400 rounded-xl shadow transition duration-200 mt-2 border border-gray-600">
            [DEMO MODE] Reset Collection
        </button>
    </div>
    
    <!-- Minifigure Collection Display -->
    <div class="w-full max-w-sm mt-8 p-4 bg-gray-800 rounded-xl border border-gray-700">
        <h2 class="text-xl font-bold text-yellow-500 mb-3 border-b border-yellow-500 pb-2">
            Your Collection (<span id="collected-count">0</span> / <span id="total-count">0</span>)
        </h2>
        <!-- ðŸ’¥ 5-COLUMN GRID CONTAINER ðŸ’¥ -->
        <div id="collection-list" class="grid grid-cols-5 gap-2">
            <!-- Figures will be populated by JS, showing found/missing status -->
        </div>
    </div>
</div>

<!-- Full-Screen Modal for Viewing Figure Details -->
<div id="figure-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4" onclick="document.getElementById('figure-modal').classList.add('hidden')">
    <div class="bg-gray-800 p-6 rounded-xl border-4 border-yellow-500 shadow-2xl max-w-xs sm:max-w-sm w-full relative" onclick="event.stopPropagation()">
        <button onclick="document.getElementById('figure-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-red-600 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold hover:bg-red-700 transition">
            &times;
        </button>
        <h3 id="modal-title" class="text-2xl font-bold text-yellow-500 mb-4 text-center"></h3>
        <!-- Image display area -->
        <div class="aspect-square w-full bg-gray-700 rounded-lg overflow-hidden border-4 border-gray-600">
            <img id="modal-image" src="" alt="" class="w-full h-full object-contain">
        </div>
        <div class="mt-4 text-center">
             <span id="modal-rarity" class="px-4 py-1 text-xs font-bold rounded-full text-gray-900 shadow-md"></span>
        </div>
    </div>
</div>


<!-- Game Logic -->
<script>
    // --- ðŸ’¥ CUSTOM MINIFIGURE WEIGHTS ðŸ’¥ ---
    // The 'weight' property defines the chance score.
    const FIGURE_STRINGS = [
const 
'name:"DX Suit", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss1dx.jpg"',
'name:"KAI (DX)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss1dxkai.jpg"',
'name:"ZANE (DX)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss1dxzane.jpg"',
'name:"JAY (DX)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss1dxjay.jpg"',
'name:"COLE (DX)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss1dxcole.jpg"',
'name:"NYA (DX)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss1dxnya.jpg"',
'name:"LLOYD (DX)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss1dxlloyd.jpg"',
'name:"Pilot Suit", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss1pilot.jpg"',
'name:"KAI (Pilot)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss1pilotkai.jpg"',
'name:"ZANE (Pilot)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss1pilotzane.jpg"',
'name:"JAY (Pilot)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss1pilotjay.jpg"',
'name:"COLE (Pilot)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss1pilotcole.jpg"',
'name:"LLOYD (Pilot)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss1pilotlloyd.jpg"',
'name:"NRG", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss1nrg.jpg"',
'name:"NRG KAI", rarity:"Legendary", weight:30, color:"red-600", image_url:"/static/images/njoss1nrgkai.jpg"',
'name:"NRG ZANE", rarity:"Legendary", weight:30, color:"cyan-400", image_url:"/static/images/njoss1nrgzane.jpg"',
'name:"NRG JAY", rarity:"Legendary", weight:30, color:"blue-500", image_url:"/static/images/njoss1nrgjay.jpg"',
'name:"NRG COLE", rarity:"Legendary", weight:30, color:"stone-700", image_url:"/static/images/njoss1nrgcole.jpg"',
'name:"NRG LLOYD", rarity:"Legendary", weight:30, color:"green-500", image_url:"/static/images/njoss1nrglloyd.jpg"',
'name:"ZX Suits", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss1zx.jpg"',
'name:"KAI (ZX)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss1zxkai.jpg"',
'name:"ZANE (ZX)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss1zxzane.jpg"',
'name:"JAY (ZX)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss1zxjay.jpg"',
'name:"COLE (ZX)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss1zxcole.jpg"',
'name:"LLOYD (ZX)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss1zxlloyd.jpg"',
'name:"Kimono Suit", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss2kimono.jpg"',
'name:"KAI (Kimono)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss2kimonokai.jpg"',
'name:"ZANE (Kimono)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss2kimonozane.jpg"',
'name:"JAY (Kimono)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss2kimonojay.jpg"',
'name:"COLE (Kimono)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss2kimonocole.jpg"',
'name:"LLOYD  (Kimono)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss2kimonolloyd.jpg"',
'name:"GOLDEN LLOYD (Kimono)", rarity:"Legendary", weight:30, color:"amber-500", image_url:"/static/images/njoss2kimonogoldlloyd.jpg"',
'name:"Pajamas", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss2pajamas.jpg"',
'name:"KAI (Pajamas)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss2pajamaskai.jpg"',
'name:"ZANE (Pajamas)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss2pajamaszane.jpg"',
'name:"JAY (Pajamas)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss2pajamasjay.jpg"',
'name:"Cole (Pajamas)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss2pajamascole.jpg"',
'name:"Techno Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss3techno.jpg"',
'name:"KAI (Techno)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss3technokai.jpg"',
'name:"ZANE (Techno)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss3technozane.jpg"',
'name:"ZANE (Techno)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss3technozane2.jpg"',
'name:"JAY (Techno)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss3technojay.jpg"',
'name:"COLE (Techno)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss3technocole.jpg"',
'name:"LLOYD (Techno)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss3technolloyd.jpg"',
'name:"Stone Armor", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss3stone.jpg"',
'name:"KAI (Stone)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss3stonekai.jpg"',
'name:"ZANE (Stone)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss3stonezane.jpg"',
'name:"JAY (Stone)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss3stonejay.jpg"',
'name:"COLE (Stone)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss3stonecole.jpg"',
'name:"NYA(Stone)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss3stonenya.jpg"',
'name:"LLOYD (Stone)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss3stonelloyd.jpg"',
'name:"Tournament Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss4tournament.jpg"',
'name:"KAI (Tournament)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss4tournamentkai.jpg"',
'name:"JAY (Tournament)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss4tournamentjay.jpg"',
'name:"COLE (Tournament)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss4tournamentcole.jpg"',
'name:"LLOYD (Tournament)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss4tournamentlloyd.jpg"',
'name:"Jungle Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss4jungle.jpg"',
'name:"KAI (Jungle)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss4junglekai.jpg"',
'name:"ZANE (Jungle)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss4junglezane.jpg"',
'name:"JAY (Jungle)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss4junglejay.jpg"',
'name:"COLE (Jungle)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss4junglecole.jpg"',
'name:"SKYLAR (Jungle)", rarity:"Unique", weight:30, color:"orange-500", image_url:"/static/images/njoss4jungleskylar.jpg"',
'name:"LLOYD (Jungle)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss4junglelloyd.jpg"',
'name:"Deepstone Armour", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss5deep.jpg"',
'name:"KAI (Deepstone)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss5deepkai.jpg"',
'name:"ZANE (Deepstone)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss5deepzane.jpg"',
'name:"JAY (Deepstone)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss5deepjay.jpg"',
'name:"COLE (Deepstone)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss5deepcole.jpg"',
'name:"NYA (Deepstone)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss5deepnya.jpg"',
'name:"LLOYD (Deepstone)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss5deeplloyd.jpg"',
'name:"Air Jitzu", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss5air.jpg"',
'name:"KAI (Air)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss5airkai.jpg"',
'name:"ZANE (Air)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss5airzane.jpg"',
'name:"JAY (Air)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss5airjay.jpg"',
'name:"COLE (Air)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss5aircole.jpg"',
'name:"NYA (Air)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss5airnya.jpg"',
'name:"LLOYD (Air)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss5airlloyd.jpg"',
'name:"Future Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss5future.jpg"',
'name:"KAI (Future)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss5futurekai.jpg"',
'name:"ZANE (Future)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss5futurezane.jpg"',
'name:"JAY (Future)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss5futurejay.jpg"',
'name:"COLE (Future)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss5futurecole.jpg"',
'name:"NYA (Future)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss5futurenya.jpg"',
'name:"LLOYD (Future)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss5futurelloyd.jpg"',
'name:"Destiny Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss6destiny.jpg"',
'name:"KAI (Destiny)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss6destinykai.jpg"',
'name:"ZANE (Destiny)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss6destinyzane.jpg"',
'name:"JAY (Destiny)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss6destinyjay.jpg"',
'name:"COLE (Destiny)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss6destinycole.jpg"',
'name:"NYA (Destiny)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss6destinynya.jpg"',
'name:"LLOYD (Destiny)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss6destinylloyd.jpg"',
'name:"Honor Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss6honor.jpg"',
'name:"KAI (Honor)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss6honorkai.jpg"',
'name:"ZANE (Honor)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss6honorzane.jpg"',
'name:"JAY (Honor)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss6honorjay.jpg"',
'name:"COLE (Honor)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss6honorcole.jpg"',
'name:"NYA (Honor)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss6honornya.jpg"',
'name:"LLOYD (Honor)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss6honorlloyd.jpg"',
'name:"Fusion Armour", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss7fusion.jpg"',
'name:"KAI (Fusion)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss7fusionkai.jpg"',
'name:"ZANE (Fusion)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss7fusionzane.jpg"',
'name:"JAY (Fusion)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss7fusionjay.jpg"',
'name:"COLE (Fusion)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss7fusioncole.jpg"',
'name:"NYA (Fusion)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss7fusionnya.jpg"',
'name:"LLOYD (Fusion)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss7fusionlloyd.jpg"',
'name:"Sensei Wu (Fusion)", rarity:"Unique", weight:30, color:"yellow-300", image_url:"/static/images/njoss7fusionsenseiwu.jpg"',
'name:"KAI (Resistance)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss8resistancekai.jpg"',
'name:"ZANE (Resistance)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss8resistancezane.jpg"',
'name:"JAY (Resistance)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss8resistancejay.jpg"',
'name:"COLE (Resistance)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss8resistancecole.jpg"',
'name:"NYA (Resistance)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss8resistancenya.jpg"',
'name:"LLOYD (Resistance)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss8resistancelloyd.jpg"',
'name:"Hunted Robes", rarity:"Epic", weight:50, color:"gray-500", image_url:"/static/images/njoss9hunted.jpg"',
'name:"KAI (Hunted)", rarity:"Rare", weight:20, color:"red-600", image_url:"/static/images/njoss9huntedkai.jpg"',
'name:"ZANE (Hunted)", rarity:"Rare", weight:20, color:"cyan-400", image_url:"/static/images/njoss9huntedzane.jpg"',
'name:"JAY (Hunted)", rarity:"Rare", weight:20, color:"blue-500", image_url:"/static/images/njoss9huntedjay.jpg"',
'name:"COLE (Hunted)", rarity:"Rare", weight:20, color:"stone-700", image_url:"/static/images/njoss9huntedcole.jpg"',
'name:"NYA (Hunted)", rarity:"Rare", weight:20, color:"sky-500", image_url:"/static/images/njoss9huntednya.jpg"',
'name:"LLOYD (Hunted)", rarity:"Rare", weight:20, color:"green-500", image_url:"/static/images/njoss9huntedlloyd.jpg"',
    ];
    // ----------------------------------------
    
    // Global state
    let MINIFIGURES = [];
    let currentDraws = 0;
    let isLoading = false;
    let collectedFigures = []; // Stores names of collected figures

    // UI Elements
    const drawCountElement = document.getElementById('draw-count');
    const draw1xButton = document.getElementById('draw-1x-button'); // NEW
    const draw5xButton = document.getElementById('draw-5x-button'); // NEW
    const resultArea = document.getElementById('result-area');
    const refillButton = document.getElementById('refill-button');
    const resetCollectionButton = document.getElementById('reset-collection-button');
    const collectionListElement = document.getElementById('collection-list');
    const collectedCountElement = document.getElementById('collected-count');
    const totalCountElement = document.getElementById('total-count');
    const initialMessage = document.getElementById('initial-message');


    // localStorage Keys
    const DRAW_COUNT_KEY = 'minifigure_draw_count_simple';
    const COLLECTION_KEY = 'minifigure_collection_list';
    const INITIAL_DRAWS = 5;

    // --- Utility Functions ---
    function parseFigureString(str) {
        const figure = {};
        const regex = /(\w+):"([^"]+)"/g;
        let match;
        while ((match = regex.exec(str)) !== null) {
            figure[match[1]] = match[2];
        }
        return figure;
    }
    
    function initializeMinifigures() {
        MINIFIGURES = FIGURE_STRINGS.map(parseFigureString);
        if (totalCountElement) {
            totalCountElement.textContent = MINIFIGURES.length;
        }
    }
    
    /**
     * Draws a minifigure based on the custom 'weight' property from the ENTIRE list.
     */
    function weightedDraw() {
        const weightedList = [];
        MINIFIGURES.forEach(fig => {
            const weight = parseInt(fig.weight, 10) || 1; 
            
            // Add the figure to the list 'weight' number of times
            for (let i = 0; i < weight; i++) {
                weightedList.push(fig);
            }
        });

        if (weightedList.length === 0) {
            console.error("No figures available for draw.");
            return null;
        }

        const randomIndex = Math.floor(Math.random() * weightedList.length);
        return weightedList[randomIndex];
    }

    // --- Cambodia Time Logic ---

    function getOrdinal(d) {
        if (d > 3 && d < 21) return 'th'; 
        switch (d % 10) {
            case 1: return "st";
            case 2: return "nd";
            case 3: return "rd";
            default: return "th";
        }
    }
    
    function updateCambodiaTime() {
        const now = new Date();
        const options = {
            timeZone: 'Asia/Phnom_Penh',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };

        const formatter = new Intl.DateTimeFormat('en-US', options);
        const parts = formatter.formatToParts(now);

        let day, month, year, hour, minute, second;

        parts.forEach(part => {
            if (part.type === 'day') day = part.value;
            if (part.type === 'month') month = part.value;
            if (part.type === 'year') year = part.value;
            if (part.type === 'hour') hour = part.value; 
            if (part.type === 'minute') minute = part.value;
            if (part.type === 'second') second = part.value;
        });

        const dayInt = parseInt(day, 10);
        // Date format: Dth/MonthName/YYYY
        const formattedDate = `${dayInt}${getOrdinal(dayInt)}/${month}/${year}`;
        
        // Time format: Hhour/Mminute/Ssecond
        const formattedTime = `${hour}hour/${minute}minute/${second}second`;
        
        const datetimeDisplay = document.getElementById('datetime-display');
        if (datetimeDisplay) {
            datetimeDisplay.innerHTML = `
                <p class="text-sm font-semibold text-gray-400">Date: ${formattedDate}</p>
                <p class="text-sm font-semibold text-gray-400">Time: ${formattedTime}</p>
            `;
        }
    }
    
    // --- Local Storage Management ---

    function updateDrawCount(newCount) {
        currentDraws = Math.max(0, newCount);
        localStorage.setItem(DRAW_COUNT_KEY, currentDraws);
        updateDrawCountUI();
    }
    
    function loadDrawCount() {
        const storedCount = localStorage.getItem(DRAW_COUNT_KEY);
        if (storedCount === null || isNaN(parseInt(storedCount, 10))) {
            updateDrawCount(INITIAL_DRAWS);
        } else {
            currentDraws = parseInt(storedCount, 10);
            updateDrawCountUI();
        }
    }
    
    function loadCollection() {
        const storedCollection = localStorage.getItem(COLLECTION_KEY);
        try {
            collectedFigures = storedCollection ? JSON.parse(storedCollection) : [];
        } catch (e) {
            console.error("Error parsing collection data, resetting:", e);
            collectedFigures = [];
        }
        updateCollectionUI();
    }
    
    /**
     * Attempts to save a figure name to the collection.
     * @param {string} figureName - The name of the figure.
     * @returns {boolean} True if the figure was newly added, false if it was a duplicate.
     */
    function saveCollection(figureName) {
        if (!collectedFigures.includes(figureName)) {
            collectedFigures.push(figureName);
            localStorage.setItem(COLLECTION_KEY, JSON.stringify(collectedFigures));
            return true; // NEW
        }
        return false; // DUPLICATE
    }
    
    function resetCollection() {
        collectedFigures = [];
        localStorage.removeItem(COLLECTION_KEY);
        updateCollectionUI();
        // Provide 2 bonus draws when resetting the collection
        updateDrawCount(currentDraws + 2);
        // Reset the result area message
        resultArea.innerHTML = `
            <div class="text-center p-4 text-gray-400">
                <p class="mb-2 text-lg font-semibold text-yellow-500">Collection Reset!</p>
                <p class="text-sm">You received +2 bonus draws for your courage!</p>
            </div>
        `;
    }

    // --- Modal Function ---
    window.showFigureDetails = function(figureName) {
        const figure = MINIFIGURES.find(f => f.name === figureName);
        if (!figure) return;
        
        const modal = document.getElementById('figure-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalImage = document.getElementById('modal-image');
        const modalRarity = document.getElementById('modal-rarity');
        
        const rarityClass = `rarity-${figure.rarity.toLowerCase().replace(' ', '-')}`;

        modalTitle.textContent = figure.name;
        // Use an absolute path / to ensure it works in all environments
        modalImage.src = `/${figure.image_url}`;
        modalImage.alt = figure.name;
        
        modalRarity.textContent = figure.rarity.toUpperCase();
        modalRarity.className = `px-4 py-1 text-xs font-bold rounded-full text-gray-900 shadow-md ${rarityClass}`;
        
        modal.classList.remove('hidden');
    }


    // --- UI Update ---

    function updateDrawCountUI() {
        if (drawCountElement) {
            drawCountElement.textContent = currentDraws;
        }
        
        if (draw1xButton && draw5xButton) {
            const noDraws = currentDraws <= 0;
            const notEnoughFor5x = currentDraws < 5;
            
            // 1X Button
            draw1xButton.disabled = noDraws || isLoading;
            draw1xButton.textContent = isLoading ? 'Drawing...' : (noDraws ? 'No Draws Left!' : 'Open 1x (1 Draw)');
            draw1xButton.classList.toggle('bg-gray-500', noDraws || isLoading);
            draw1xButton.classList.toggle('bg-red-600', !noDraws && !isLoading);
            draw1xButton.classList.toggle('hover:bg-red-700', !noDraws && !isLoading);


            // 5X Button
            draw5xButton.disabled = noDraws || notEnoughFor5x || isLoading;
            draw5xButton.textContent = isLoading ? 'Drawing...' : (notEnoughFor5x ? 'Need 5 Draws' : 'Open 5x (5 Draws)');
            draw5xButton.classList.toggle('bg-gray-500', notEnoughFor5x || isLoading);
            draw5xButton.classList.toggle('bg-red-700', !notEnoughFor5x && !isLoading);
            draw5xButton.classList.toggle('hover:bg-red-800', !notEnoughFor5x && !isLoading);

        }
    }
    
    function updateCollectionUI() {
        if (!collectionListElement) return;
        
        const collectedNames = new Set(collectedFigures);
        
        if (collectedCountElement) {
            collectedCountElement.textContent = collectedNames.size;
        }

        collectionListElement.innerHTML = MINIFIGURES.map(fig => {
            const isCollected = collectedNames.has(fig.name);
            const statusClass = isCollected ? 'collected collection-item' : 'missing';
            
            // Placeholder generation for missing/error images
            const firstLetter = fig.name.substring(0, 1);
            const [baseColor, shade] = fig.color.split('-');
            const placeholderColor = baseColor === 'yellow' ? '555' : 'FFF';
            const placeholderBackground = baseColor === 'yellow' ? 'F0A000' : '4A5568';
            const placeholderUrl = `https://placehold.co/40x40/${placeholderBackground}/${placeholderColor}?text=${firstLetter}`;
            
            // Add click handler only if collected
            const clickHandler = isCollected ? `onclick="showFigureDetails('${fig.name}')"` : '';

            return `
                <div class="relative w-full aspect-square rounded-lg overflow-hidden transition duration-150 p-0.5 ${statusClass}"
                     title="${fig.name} (${isCollected ? 'Found - Click to View' : 'Missing'})" ${clickHandler}>
                    <img src="/${fig.image_url}" 
                         alt="${fig.name}" 
                         class="w-full h-full object-contain rounded-md" 
                         onerror="this.onerror=null; this.src='${placeholderUrl}'; this.style.backgroundColor='#${placeholderBackground}'"/>
                    
                    <!-- Rarity indicator dot -->
                    <span class="absolute top-1 right-1 w-2 h-2 rounded-full shadow-lg rarity-${fig.rarity.toLowerCase().replace(' ', '-')}"></span>
                </div>
            `;
        }).join('');

        updateDrawCountUI(); 
    }


    // --- Main Draw Logic ---

    function displayDrawResults(results) {
        // Remove the initial message
        if(initialMessage) initialMessage.remove();

        const isMultiDraw = results.length > 1;
        
        let containerClass = "flex flex-col items-center justify-center p-4 w-full";
        let cardClass = "result-card p-4 bg-gray-800 rounded-xl shadow-2xl w-full max-w-xs border-b-8";
        
        if (isMultiDraw) {
            // For 5x draw, use a responsive grid
            containerClass = "grid grid-cols-2 md:grid-cols-3 gap-3 p-2 w-full";
            cardClass = "result-card flex flex-col items-center p-2 bg-gray-800 rounded-xl shadow-md border-b-4 text-xs";
        }

        resultArea.innerHTML = `<div id="results-grid" class="${containerClass}"></div>`;
        const resultsGrid = document.getElementById('results-grid');

        results.forEach((result, index) => {
            const figure = result.figure;
            const isNewFigure = result.isNew;
            
            // Calculate figure-specific styling
            const borderColorClass = figure.color ? `border-${figure.color}` : 'border-yellow-500';
            const rarityClass = `rarity-${figure.rarity.toLowerCase().replace(' ', '-')}`;
            
            // Placeholder generation for drawn figure
            const firstLetter = figure.name.substring(0, 1);
            const [baseColor, shade] = figure.color.split('-');
            const placeholderColor = baseColor === 'yellow' ? '555' : 'FFF';
            const placeholderBackground = baseColor === 'yellow' ? 'F0A000' : '4A5568';
            const placeholderUrl = `https://placehold.co/96x96/${placeholderBackground}/${placeholderColor}?text=${firstLetter}`;

            let titleText;
            let titleClass;
            let subtitleText;

            if (!isNewFigure) {
                // Duplicate Scenario (This is what the user got when collection is full)
                titleText = 'COLLECTION FULL!';
                titleClass = 'text-yellow-500';
                subtitleText = isMultiDraw ? 'Owned!' : 'You already own this one!';
            } else {
                // New Figure Scenario
                titleText = 'NEW!';
                titleClass = 'text-green-400';
                subtitleText = isMultiDraw ? 'New!' : 'Added to your collection!';
                
                // Special message if a free re-draw occurred
                if (result.wasFreeRedraw) {
                    titleText = 'FREE RE-ROLL SUCCESS!';
                    titleClass = 'text-green-400';
                    subtitleText = 'Duplicate found, but you got a free chance!';
                }
            }
            
            // Generate the HTML for one result card
            const cardHtml = `
                <div style="animation-delay: ${index * 50}ms;" class="${cardClass} ${borderColorClass} draw-animation">
                    ${isMultiDraw ? 
                        // Simplified view for 5x draw
                        `
                        <p class="font-bold mb-1 uppercase tracking-widest ${titleClass}">${titleText}</p>
                        <div class="w-16 h-16 p-1 mb-1 bg-gray-700 rounded-lg shadow-inner border border-yellow-500 flex items-center justify-center">
                            <img src="/${figure.image_url}" alt="${figure.name}" class="w-full h-full object-contain p-1"
                                 onerror="this.onerror=null; this.src='${placeholderUrl}'; this.style.backgroundColor='#${placeholderBackground}'"/>
                        </div>
                        <h4 class="font-bold text-white text-center truncate w-full">${figure.name}</h4>
                        <span class="mt-1 px-2 py-0.5 text-[10px] font-bold rounded-full text-gray-900 shadow-md ${rarityClass}">
                            ${figure.rarity.toUpperCase()}
                        </span>
                        `
                        :
                        // Detailed view for 1x draw
                        `
                        <p class="font-bold mb-2 uppercase tracking-widest ${titleClass}">${titleText}</p>
                        <div class="w-full aspect-square p-2 mb-4 bg-gray-700 rounded-xl shadow-inner border-2 border-yellow-500 flex items-center justify-center">
                            <img src="/${figure.image_url}" alt="${figure.name}" class="w-full h-full object-contain p-2"
                                 onerror="this.onerror=null; this.src='${placeholderUrl}'; this.style.backgroundColor='#${placeholderBackground}'"/>
                        </div>
                        <h2 class="text-3xl font-extrabold text-white text-center mb-1">${figure.name}</h2>
                        <p class="text-sm font-semibold mb-3 text-gray-400">${subtitleText}</p>
                        <span class="px-4 py-1 text-xs font-bold rounded-full text-gray-900 shadow-md ${rarityClass}">
                            ${figure.rarity.toUpperCase()}
                        </span>
                        `
                    }
                </div>
            `;
            resultsGrid.insertAdjacentHTML('beforeend', cardHtml);
        });

        // After all draws are displayed, update the collection list visually
        updateCollectionUI();
    }


    /**
     * Handles the drawing mechanism for 1x or 5x, implementing the free re-draw rule.
     * @param {number} count - The number of draws (1 or 5).
     */
    function handleDraw(count) {
        if (isLoading || currentDraws < count) return;
        
        // Disable buttons and set loading state
        isLoading = true;
        updateDrawCountUI(); 
        
        // Remove old results/initial message and start animation
        if(initialMessage) initialMessage.remove(); // Ensure initial message is removed

        resultArea.innerHTML = `
            <div id="mystery-box" class="loading-animation w-32 h-32 rounded-xl flex items-center justify-center shadow-inner border-4 border-white">
                <span class="text-6xl text-gray-900" role="img" aria-label="Mystery Box">ðŸ“¦</span>
            </div>
        `;

        // DEDUCT DRAW COUNT (COST)
        updateDrawCount(currentDraws - count);

        // Wait for suspense (1.5 seconds)
        setTimeout(() => {
            const drawResults = [];

            for (let i = 0; i < count; i++) {
                let finalDrawnFigure = null;
                let isNew = false;
                let wasFreeRedraw = false;
                let attempts = 0;
                const maxFreeAttempts = 50;

                // 1. Initial Draw (Paid Slot)
                let drawnFigure = weightedDraw();
                isNew = saveCollection(drawnFigure.name); // Attempts to save/checks if new
                finalDrawnFigure = drawnFigure;
                
                // 2. Re-draw loop if duplicate AND collection is not full
                if (!isNew && collectedFigures.length < MINIFIGURES.length) {
                    wasFreeRedraw = true; // Mark that a free chance was given
                    attempts = 0;

                    // Keep re-drawing until a NEW figure is found, or we hit max attempts/collection is full
                    do {
                        attempts++;
                        let reDrawnFigure = weightedDraw();
                        isNew = saveCollection(reDrawnFigure.name); // This updates global collectedFigures
                        
                        if (isNew) {
                            finalDrawnFigure = reDrawnFigure; // Success: show the NEW figure
                            break;
                        }

                        // Check if the collection is now full due to concurrent draws
                        if (collectedFigures.length >= MINIFIGURES.length) {
                            finalDrawnFigure = reDrawnFigure; // The result is the last duplicate, collection is full
                            isNew = false;
                            break;
                        }
                        
                        // Safety break
                        if (attempts >= maxFreeAttempts) {
                            console.warn("Free draw loop failed to find a new figure.");
                            isNew = false;
                            break;
                        }
                    } while (!isNew);
                }

                // 3. Log the result for display
                drawResults.push({
                    figure: finalDrawnFigure,
                    isNew: isNew,
                    wasFreeRedraw: wasFreeRedraw
                });
            }
            
            // Display all the results
            displayDrawResults(drawResults);

            // Reset loading state
            isLoading = false;
            updateDrawCountUI();

        }, 1500); 
    }
    
    // --- Initialization ---

    function initGame() {
        initializeMinifigures();
        loadDrawCount();
        loadCollection(); 
        
        // Start the real-time clock update
        updateCambodiaTime();
        setInterval(updateCambodiaTime, 1000); // Update every second
        
        // Attach event listeners to the new buttons
        if (draw1xButton) {
            draw1xButton.addEventListener('click', () => handleDraw(1));
        }
        if (draw5xButton) {
            draw5xButton.addEventListener('click', () => handleDraw(5));
        }
        
        // Refill button functionality 
        if (refillButton) {
            refillButton.addEventListener('click', () => {
                updateDrawCount(INITIAL_DRAWS);
            });
        }
        
        // Reset collection button functionality
        if (resetCollectionButton) {
            resetCollectionButton.addEventListener('click', resetCollection);
        }

        updateDrawCountUI();
    }

    document.addEventListener('DOMContentLoaded', initGame);
</script>
</body>
</html>

